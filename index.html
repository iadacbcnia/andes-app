<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andes - Tu Gu√≠a en la Comarca</title>
    <script src="https://cdn.tailwindcss.com?v=2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=2" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=2" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js?v=2"></script>
    <style>
        :root {
            --emerald-500: #10b981;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --slate-700: #334155;
            --gray-100: #f3f4f6;
            --white: #ffffff;
        }
        .dark {
            --bg-color: var(--slate-800);
            --text-color: var(--gray-100);
            --card-bg: var(--slate-700);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color, var(--gray-100));
            color: var(--text-color, var(--slate-900));
        }
        .user-message { background-color: var(--emerald-500); color: white; border-radius: 20px 20px 5px 20px; }
        .ai-message { background-color: var(--card-bg, var(--white)); border-radius: 20px 20px 20px 5px; }
        .sponsored-message {
            background-color: var(--card-bg, var(--white));
            border: 2px solid #facc15;
            box-shadow: 0 4px 14px 0 rgba(250, 204, 21, 0.3);
        }
        .place-link { color: var(--emerald-500); font-weight: 500; cursor: pointer; }
        .place-link:hover { text-decoration: underline; }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af;
            border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 2.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating:not(:checked) > label:hover, .star-rating:not(:checked) > label:hover ~ label { color: #f59e0b; }
        #map { height: 100%; width: 100%; }
        .leaflet-container { height: 100%; width: 100%; }
        .ar-top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 0.5rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .ar-pill { background-color: rgba(0, 0, 0, 0.6); color: white; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; }
        #ar-status { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; color: white; background-color: rgba(0,0,0,0.7); padding: 1rem; border-radius: 0.5rem; text-align: center; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-listening {
            color: #ef4444;
            animation: pulse-red 1.5s infinite;
            border-radius: 50%;
        }
        .action-btn {
            color: #6b7280;
            padding: 0.25rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            flex-grow: 1;
            text-align: center;
        }
        .action-btn:hover {
            background-color: #f3f4f6;
            color: #10b981;
        }
        .dark .action-btn {
            color: #9ca3af;
        }
        .dark .action-btn:hover {
            background-color: #334155;
            color: white;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css?v=2">
</head>
<body class="dark bg-gray-100 dark:bg-slate-900 text-gray-900 dark:text-gray-100">
<div class="flex h-screen">
    <main class="flex-1 flex flex-col h-screen">
        <div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4">
            <div class="w-full flex justify-start">
                <div class="ai-message w-fit max-w-xs md:max-w-md lg:max-w-2xl p-3 rounded-2xl shadow">
                    ¬°Hola! Soy Andes, tu gu√≠a personal en la Comarca Andina. Estoy aqu√≠ para ayudarte a descubrir los mejores lugares, planificar tu d√≠a o simplemente contarte sobre el clima. ¬øEn qu√© puedo ayudarte hoy?
                </div>
            </div>
        </div>
        <div class="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
            <div id="suggestions" class="flex flex-wrap gap-2 mb-2"></div>
            <form id="chat-form" class="flex items-center gap-2">
                <div class="relative w-full">
                    <input type="text" id="chat-input" placeholder="Preg√∫ntame algo..." class="w-full p-3 pr-20 rounded-lg border border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    <button type="button" id="mic-btn" class="absolute inset-y-0 right-10 flex items-center p-3 text-gray-500 hover:text-emerald-500">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                    </button>
                </div>
                <button type="submit" class="bg-emerald-500 text-white p-3 rounded-lg hover:bg-emerald-600 disabled:bg-emerald-300">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.544l4.25-1.214a.75.75 0 01.44 1.392l-4.25 1.214a.75.75 0 00-.95.544l-1.414 4.949a.75.75 0 00.826.95l14.083-4.024a.75.75 0 000-1.425L3.105 2.289z" /></svg>
                </button>
            </form>
        </div>
        <div id="action-bar" class="bg-white dark:bg-slate-800 p-2 border-t border-gray-200 dark:border-slate-700">
            <div class="flex justify-around items-center">
                <button id="action-map-btn" class="action-btn">
                    <svg class="h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.1.4-.223.654-.369.26-.15.552-.333.865-.55C12.864 17.113 14 15.823 14 14c0-2.21-1.79-4-4-4S6 11.79 6 14c0 1.823 1.136 3.113 1.966 3.868.313.217.605.4.865.55.254.146.468.269.654.369a5.741 5.741 0 00.28.14l.018.008.006.003zM10 11.25a2.75 2.75 0 100 5.5 2.75 2.75 0 000-5.5z" clip-rule="evenodd" /><path d="M10 2C4.477 2 0 6.477 0 12s4.477 10 10 10 10-4.477 10-10S15.523 2 10 2zM8 14a2 2 0 114 0 2 2 0 01-4 0z" /></svg>
                    <span class="text-xs">Mapa</span>
                </button>
                <button id="action-planner-btn" class="action-btn">
                    <svg class="h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                    <span class="text-xs">Plan</span>
                </button>
                <button id="action-rincon-btn" class="action-btn">
                    <svg class="h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zM6 8a2 2 0 11-4 0 2 2 0 014 0zM1.49 15.326a.78.78 0 01-.358-.442 3 3 0 014.308-3.516 6.484 6.484 0 00-1.905 3.959c-.023.222-.014.442.028.658a.78.78 0 01-.357.443 3.377 3.377 0 01-2.924.001zM18 8a2 2 0 11-4 0 2 2 0 014 0zm-1.808 1.054a6.458 6.458 0 00-1.905-3.959 3 3 0 014.308 3.516.78.78 0 01-.357-.443c.042-.216.051-.436.028-.658a.78.78 0 01-.358.442 3.377 3.377 0 01-2.924-.001zM10 18a3 3 0 100-6 3 3 0 000 6z" /></svg>
                    <span class="text-xs">Rinc√≥n</span>
                </button>
                <button id="action-admin-btn" class="action-btn">
                    <svg class="h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                    <span class="text-xs">Admin</span>
                </button>
            </div>
        </div>
    </main>
</div>

<!-- MODALES -->
<div id="planner-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <!-- ... contenido del modal planner ... -->
</div>
<div id="password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <!-- ... contenido del modal de contrase√±a ... -->
</div>
<div id="admin-panel-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <!-- ... contenido del panel de admin ... -->
</div>
<div id="contribution-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[65] transition-opacity duration-300">
    <!-- ... formulario de contribuci√≥n ... -->
</div>
<div id="manage-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[60] transition-opacity duration-300">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
        <div class="flex flex-wrap justify-between items-center mb-4 pb-2 border-b dark:border-slate-600 gap-2">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Gestionar Contenido</h3>
            <div class="flex items-center gap-2">
                <button id="restore-backup-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                    Restaurar Backup
                </button>
                <button id="download-backup-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Descargar Backup
                </button>
            </div>
        </div>
        <div id="manage-list" class="flex-grow overflow-y-auto pr-2"></div>
        <div class="items-center px-4 py-3 text-right mt-4 border-t dark:border-slate-600">
            <button id="close-manage-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600">Cerrar</button>
        </div>
    </div>
</div>
<div id="rincon-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <!-- ... rinc√≥n del viajero ... -->
</div>
<div id="rating-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
    <!-- ... valoraciones ... -->
</div>
<input type="file" id="backup-file-input" accept=".csv" class="hidden">
<div id="confirm-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
    <!-- ... confirmar eliminaci√≥n ... -->
</div>
<div id="confirm-restore-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <!-- ... confirmar restauraci√≥n ... -->
</div>
<div id="confirm-rubro-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
    <!-- ... confirmar borrado de rubro ... -->
</div>
<div id="map-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 h-full w-full hidden z-[80] transition-opacity duration-300 flex flex-col">
    <div class="bg-white dark:bg-slate-800 p-3 flex justify-between items-center shadow-md">
        <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Mapa Interactivo de la Comarca</h3>
        <button id="close-map-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-gray-200" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
    <div id="map-container" class="flex-grow">
        <div id="map"></div>
    </div>
</div>
<div id="vr-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[90] transition-opacity duration-300 flex flex-col">
    <!-- ... VR ... -->
</div>
<div id="ar-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[100] transition-opacity duration-300">
    <!-- ... AR ... -->
</div>
<audio id="radio-player" preload="none"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, updateDoc, deleteDoc, writeBatch, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENTOS HTML ---
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const suggestionsContainer = document.getElementById('suggestions');
    const micBtn = document.getElementById('mic-btn');
    
    // Modales
    const contributionModal = document.getElementById('contribution-modal');
    const manageModal = document.getElementById('manage-modal');
    const rinconModal = document.getElementById('rincon-modal');
    const ratingModal = document.getElementById('rating-modal');
    const mapModal = document.getElementById('map-modal');
    const vrModal = document.getElementById('vr-modal');
    const arModal = document.getElementById('ar-modal');
    const passwordModal = document.getElementById('password-modal');
    const adminPanelModal = document.getElementById('admin-panel-modal');
    const plannerModal = document.getElementById('planner-modal');
    const confirmDeleteModal = document.getElementById('confirm-delete-modal');
    const confirmRubroDeleteModal = document.getElementById('confirm-rubro-delete-modal');
    
    // Botones de acci√≥n
    const actionMapBtn = document.getElementById('action-map-btn');
    const actionPlannerBtn = document.getElementById('action-planner-btn');
    const actionRinconBtn = document.getElementById('action-rincon-btn');
    const actionAdminBtn = document.getElementById('action-admin-btn');
    
    // Botones de cierre
    const closeContributionModalBtn = document.getElementById('close-contribution-modal-btn');
    const closeManageModalBtn = document.getElementById('close-manage-modal-btn');
    const closeRinconModalBtn = document.getElementById('close-rincon-modal-btn');
    const closeRatingModalBtn = document.getElementById('close-rating-modal-btn');
    const closeMapModalBtn = document.getElementById('close-map-modal-btn');
    const closeVrModalBtn = document.getElementById('close-vr-modal-btn');
    const closeArModalBtn = document.getElementById('close-ar-modal-btn');
    const closePasswordModalBtn = document.getElementById('close-password-modal-btn');
    const closeAdminPanelBtn = document.getElementById('close-admin-panel-btn');
    const closePlannerModalBtn = document.getElementById('close-planner-modal-btn');
    
    // Admin
    const passwordForm = document.getElementById('password-form');
    const passwordInput = document.getElementById('password-input');
    const passwordError = document.getElementById('password-error');
    const adminAddBtn = document.getElementById('admin-add-btn');
    const adminManageBtn = document.getElementById('admin-manage-btn');
    
    // Formularios
    const contributionForm = document.getElementById('contribution-form');
    const tipForm = document.getElementById('tip-form');
    const tipInput = document.getElementById('tip-input');
    const plannerForm = document.getElementById('planner-form');
    const manageList = document.getElementById('manage-list');
    const rinconList = document.getElementById('rincon-list');
    
    // Radio
    const radioPlayer = document.getElementById('radio-player');
    const streamUrl = 'https://streaming6.locucionar.com:24140/stream';
    
    // --- VARIABLES GLOBALES ---
    let db, auth, userId;
    let lugaresCollectionRef, consejosCollectionRef;
    let dynamicKnowledgeBase = {}, placesCache = [], chatHistory = [], tipsCache = [];
    let isAdmin = false, isDataReady = false, mapInitialized = false, map = null;
    let markersLayer = null, markersById = {};
    let editingPlaceId = null;
    const geminiApiKey = "AIzaSyCTgtEQ2SorpvrLjm8ntBbPDZVKAxTz6ZI";
    const appId = 'default-app-id';
    
    // --- ESTADO INICIAL ---
    const submitButton = chatForm.querySelector('button[type="submit"]');
    chatInput.disabled = true;
    chatInput.placeholder = "Conectando...";
    submitButton.disabled = true;
    
    // --- INICIALIZAR FIREBASE ---
    function initializeFirebase() {
        const firebaseConfig = {
            apiKey: "AIzaSyB2Z9PnT0bz9SI47_BW1BcW1tjqbQjYnC0",
            authDomain: "andes-app-turismo.firebaseapp.com",
            projectId: "andes-app-turismo",
            storageBucket: "andes-app-turismo.appspot.com",
            messagingSenderId: "685878856963",
            appId: "1:685878856963:web:660823dfdac24a0c39ed36"
        };
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
            }
            lugaresCollectionRef = collection(db, `/artifacts/${appId}/public/data/lugares`);
            consejosCollectionRef = collection(db, `/artifacts/${appId}/public/data/consejos`);
            listenForNewPlaces();
            listenForTips();
        });
    }
    
    // --- RENDERIZADO ---
    function renderTipsList() {
        if (!rinconList) return;
        rinconList.innerHTML = '';
        if (tipsCache.length === 0) {
            rinconList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">A√∫n no hay consejos. ¬°S√© el primero en compartir uno!</p>';
            return;
        }
        tipsCache.forEach(tip => {
            const tipElement = document.createElement('div');
            tipElement.className = "bg-gray-100 dark:bg-slate-700 p-3 rounded-lg";
            const date = tip.createdAt ? new Date(tip.createdAt.seconds * 1000).toLocaleDateString() : 'hace un momento';
            tipElement.innerHTML = `
                <p class="text-sm">${tip.text || 'Consejo vac√≠o.'}</p>
                <p class="text-xs text-gray-400 text-right mt-1">An√≥nimo - ${date}</p>
            `;
            rinconList.appendChild(tipElement);
        });
    }
    
    function renderManagementList() {
        if (!manageList) return;
        manageList.innerHTML = '';
        if (placesCache.length === 0) {
            manageList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No hay lugares para gestionar.</p>';
            return;
        }
        const groupedByLocalidad = placesCache.reduce((acc, place) => {
            const localidad = place.localidad || 'Sin Localidad';
            if (!acc[localidad]) acc[localidad] = [];
            acc[localidad].push(place);
            return acc;
        }, {});
        Object.keys(groupedByLocalidad).sort().forEach(localidad => {
            const placesInLocalidad = groupedByLocalidad[localidad];
            let localidadHtml = `
                <details class="bg-gray-100 dark:bg-slate-800 rounded-lg mb-2" open>
                    <summary class="flex justify-between items-center p-3 cursor-pointer font-bold">
                        ${localidad} <span class="text-sm font-normal text-gray-500">(${placesInLocalidad.length} lugares)</span>
                    </summary>
                    <div class="pl-4 pr-2 pb-2 space-y-2">
            `;
            placesInLocalidad.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(place => {
                localidadHtml += `
                    <div class="flex justify-between items-center p-2 rounded-md bg-gray-50 dark:bg-slate-700">
                        <span class="truncate">${place.esAuspiciante ? '‚≠ê ' : ''}${place.nombre}</span>
                        <div class="flex gap-1">
                            <button class="edit-place-btn text-xs bg-blue-500 text-white py-1 px-2 rounded" data-id="${place.id}">Editar</button>
                            <button class="delete-place-btn text-xs bg-red-500 text-white py-1 px-2 rounded" data-id="${place.id}" data-name="${place.nombre}">Borrar</button>
                        </div>
                    </div>
                `;
            });
            localidadHtml += `</div></details>`;
            manageList.innerHTML += localidadHtml;
        });
    }
    
    function formatPlaceForAI(place) {
        let html = `
            <div class="bg-gray-100 dark:bg-slate-700 rounded-xl p-4 mb-3 border border-gray-200 dark:border-slate-600 shadow-sm">
                <h3 class="font-bold text-lg mb-1">${place.esAuspiciante ? '‚≠ê ' : ''}${place.nombre}</h3>
                <p class="text-sm mb-2">${place.descripcion}</p>
                ${place.datosClave ? `<div class="text-xs bg-gray-200 dark:bg-slate-600 p-2 rounded mb-2"><strong>Datos clave:</strong><br>${place.datosClave.replace(/\n/g, '<br>')}</div>` : ''}
                ${place.direccion || place.telefono ? `<div class="text-xs mb-2">
                    ${place.direccion ? `<strong>Direcci√≥n:</strong> ${place.direccion}<br>` : ''}
                    ${place.telefono ? `<strong>Tel√©fono:</strong> ${place.telefono}` : ''}
                </div>` : ''}
                ${place.imagenURL ? `<img src="${place.imagenURL}" alt="${place.nombre}" class="mt-2 rounded-lg max-h-40 w-full object-cover">` : ''}
                <div class="mt-3 flex gap-2">
                    <button class="rate-place-btn text-xs bg-amber-500 text-white py-1.5 px-3 rounded-lg hover:bg-amber-600" data-id="${place.id}">Ver/Dejar Opiniones</button>
                    <button class="view-on-map-btn text-xs bg-blue-500 text-white py-1.5 px-3 rounded-lg hover:bg-blue-600" data-id="${place.id}">Ver en el Mapa</button>
                </div>
            </div>
        `;
        return html;
    }
    
    // --- MAPA ---
    function initMap() {
        if (mapInitialized) return;
        map = L.map('map').setView([-41.96, -71.53], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        markersLayer = L.layerGroup().addTo(map);
        mapInitialized = true;
    }
    
    function updateMapMarkers() {
        if (!map || !markersLayer) return;
        markersLayer.clearLayers();
        markersById = {};
        const placesWithCoords = placesCache.filter(p => p.latitud && p.longitud);
        placesWithCoords.forEach(place => {
            try {
                const lat = parseFloat(place.latitud);
                const lon = parseFloat(place.longitud);
                if (!isNaN(lat) && !isNaN(lon)) {
                    const marker = L.marker([lat, lon]).addTo(markersLayer);
                    marker.bindPopup(`
                        <b>${place.nombre}</b><br>
                        ${place.subtipo || place.tipo}<br>
                        <button class="mt-2 px-2 py-1 bg-green-500 text-white rounded text-xs how-to-get-there-btn" 
                                data-lat="${lat}" data-lon="${lon}">
                            C√≥mo llegar
                        </button>
                    `);
                    markersById[place.id] = marker;
                }
            } catch (e) {
                console.warn(`Coordenadas inv√°lidas para ${place.nombre}`);
            }
        });
        if (placesWithCoords.length > 0) {
            map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
        }
    }
    
    // --- LISTENERS ---
    actionMapBtn.addEventListener('click', () => {
        mapModal.classList.remove('hidden');
        if (!mapInitialized) initMap();
        setTimeout(() => {
            if(map) {
                map.invalidateSize();
                updateMapMarkers();
            }
        }, 200);
    });
    
    actionPlannerBtn.addEventListener('click', () => plannerModal.classList.remove('hidden'));
    
    actionRinconBtn.addEventListener('click', () => {
        renderTipsList();
        rinconModal.classList.remove('hidden');
    });
    
    actionAdminBtn.addEventListener('click', () => {
        if (isAdmin) {
            adminPanelModal.classList.remove('hidden');
        } else {
            passwordModal.classList.remove('hidden');
        }
    });
    
    adminAddBtn.addEventListener('click', () => {
        contributionForm.reset();
        editingPlaceId = null;
        document.getElementById('contribution-submit-btn').textContent = 'A√±adir Lugar';
        contributionModal.classList.remove('hidden');
        adminPanelModal.classList.add('hidden');
    });
    
    adminManageBtn.addEventListener('click', () => {
        renderManagementList(); 
        manageModal.classList.remove('hidden');
        adminPanelModal.classList.add('hidden');
    });
    
    // Listener para "Ver en el Mapa"
    chatWindow.addEventListener('click', function(e) {
        const viewOnMapBtn = e.target.closest('.view-on-map-btn');
        if (viewOnMapBtn) {
            const placeId = viewOnMapBtn.dataset.id;
            const place = placesCache.find(p => p.id === placeId);
            if (place && place.latitud && place.longitud) {
                mapModal.classList.remove('hidden');
                if (!mapInitialized) initMap();
                setTimeout(() => {
                    const lat = parseFloat(place.latitud);
                    const lon = parseFloat(place.longitud);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        map.setView([lat, lon], 16);
                        if (markersById[placeId]) {
                            markersById[placeId].openPopup();
                        } else {
                            const tempMarker = L.marker([lat, lon]).addTo(map);
                            tempMarker.bindPopup(`
                                <b>${place.nombre}</b><br>
                                ${place.subtipo || place.tipo}<br>
                                <button class="mt-2 px-2 py-1 bg-green-500 text-white rounded text-xs how-to-get-there-btn" 
                                        data-lat="${lat}" data-lon="${lon}">
                                    C√≥mo llegar
                                </button>
                            `).openPopup();
                        }
                    }
                }, 300);
            } else {
                addMessage({ text: "Lo siento, no tengo las coordenadas de este lugar para mostrarlo en el mapa." }, 'ai');
            }
        }
    });
    
    // Listener global para "C√≥mo llegar"
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('how-to-get-there-btn')) {
            const lat = e.target.dataset.lat;
            const lon = e.target.dataset.lon;
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
            window.open(url, '_blank');
        }
    });
    
    // --- CHAT ---
    function addMessage(message, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
        const messageContent = document.createElement('div');
        messageContent.className = `${sender === 'user' ? 'user-message' : 'ai-message'} w-fit max-w-xs md:max-w-md lg:max-w-2xl p-3 rounded-2xl shadow`;
        if (message.isHtml) {
            messageContent.innerHTML = message.text;
        } else {
            messageContent.textContent = message.text;
        }
        messageDiv.appendChild(messageContent);
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const userMessage = chatInput.value.trim();
        if (userMessage === '') return;
        addMessage({ text: userMessage }, 'user');
        chatInput.value = '';
        processUserMessage(userMessage);
    });
    
    async function processUserMessage(userMessage) {
        const typingIndicator = showTypingIndicator();
        chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
        const systemPrompt = generateSystemPrompt();
        const aiResponseData = await getAIResponse(chatHistory, systemPrompt);
        chatWindow.removeChild(typingIndicator);
        addMessage({
            text: aiResponseData.text,
            isHtml: aiResponseData.isHtml,
            isSponsored: aiResponseData.isSponsored
        }, 'ai');
        chatHistory.push({ role: "model", parts: [{ text: aiResponseData.text }] });
    }
    
    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'w-full flex justify-start';
        typingDiv.innerHTML = `
            <div class="ai-message w-fit p-3 rounded-2xl shadow">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatWindow.appendChild(typingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return typingDiv;
    }
    
    // --- INTELIGENCIA ARTIFICIAL ---
    async function getAIResponse(history, systemInstructions) {
        try {
            const payload = {
                contents: history,
                systemInstruction: { parts: [{ text: systemInstructions }] }
            };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            return processAIResponseText(text);
        } catch (error) {
            console.error("Error calling AI API:", error);
            return { text: "Lo siento, tuve un problema para conectarme. Por favor, intenta de nuevo m√°s tarde." };
        }
    }
    
    function processAIResponseText(text) {
        let isHtml = false;
        let isSponsored = false;
        const linkRegex = /\[\[(.*?)\]\]/g;
        let processedText = text.replace(linkRegex, (match, placeName) => {
            const foundPlace = findPlaceByName(placeName.trim());
            if (foundPlace) {
                isHtml = true;
                if (foundPlace.esAuspiciante) isSponsored = true;
                return `<a class="place-link" data-id="${foundPlace.id}">${placeName}</a>`;
            }
            return placeName;
        });
        if (processedText.includes('*') || processedText.includes('\n-')) {
            isHtml = true;
            processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            processedText = processedText.replace(/^\s*-\s*(.*)/gm, '<li>$1</li>');
            if(processedText.includes('<li>')){
                processedText = `<ul>${processedText}</ul>`;
            }
        }
        return { text: processedText, isHtml, isSponsored };
    }
    
    function findPlaceByName(name) {
        return placesCache.find(place => place.nombre.toLowerCase() === name.toLowerCase());
    }
    
    function generateSystemPrompt() {
        return `
        Eres "Andes", un asistente de IA amigable y experto en la Comarca Andina del Paralelo 42 (El Bols√≥n, Lago Puelo, El Hoyo, etc.).
        Tu objetivo es ser el mejor gu√≠a tur√≠stico. Eres conversador, √∫til y un poco informal. Usas emojis para darle personalidad a tus respuestas.
        REGLAS FUNDAMENTALES:
        1.  **USA TU CONOCIMIENTO INTERNO PRIMERO:** La siguiente base de datos es tu fuente principal y m√°s confiable. Siempre que un usuario pregunte por lugares, busca en esta lista primero.
            \`\`\`json
            ${JSON.stringify(dynamicKnowledgeBase, null, 2)}
            \`\`\`
        2.  **C√ìMO RESPONDER SOBRE LUGARES:**
            - Si encuentras un lugar EXACTO en tu base de datos, menciona su nombre entre corchetes dobles, as√≠: [[Nombre Exacto del Lugar]]. NO inventes nombres. El nombre debe ser id√©ntico al de la base de datos. Esto lo convertir√° en un enlace.
            - Si el usuario pregunta por un tipo de lugar (ej. "restaurantes en El Bols√≥n"), dale una lista de 2 o 3 opciones de tu base de datos y menci√≥nalos con [[Nombre Exacto]].
            - Si el lugar es "esAuspiciante: true", menci√≥nalo como un "lugar recomendado por la comunidad" o "un favorito de los viajeros" y ponle un emoji de estrella ‚≠ê.
        3.  **SI NO SABES, BUSCA EN LA WEB:** Si la pregunta no se puede responder con tu base de datos (ej. "clima", "historia del l√∫pulo", "horarios del colectivo"), puedes usar tu conocimiento general. Siempre aclara que la informaci√≥n puede variar.
        4.  **S√â BREVE Y AL GRANO:** No escribas p√°rrafos largos. Usa listas con guiones (-) si es necesario.
        5.  **NO DES INFORMACI√ìN PRIVADA:** Nunca des la URL de una imagen o datos que no est√©n expl√≠citamente en la descripci√≥n.
        EJEMPLOS DE RESPUESTA:
        - Usuario: "busco un lugar para comer"
        - Andes: "¬°Claro! En El Bols√≥n te puedo recomendar [[Jauja]] que es un cl√°sico, o si buscas algo m√°s r√∫stico, [[La Gorda]]. ¬øTe gustar√≠a saber m√°s de alguno de ellos? üçî"
        - Usuario: "contame sobre el cerro piltriquitron"
        - Andes: "El Piltriquitr√≥n es el cerro guardi√°n de El Bols√≥n. ¬°Las vistas desde arriba son incre√≠bles! ü§© Puedes subir en auto una parte y luego hacer un trekking. Hay un bosque tallado muy famoso en el camino. ¬°No te lo pierdas!"
    `;
    }
    
    // --- SUGERENCIAS ---
    function updateSuggestions() {
        suggestionsContainer.innerHTML = '';
        const suggestions = [
            "¬øQu√© puedo hacer hoy?",
            "Restaurantes en El Bols√≥n",
            "Caba√±as en Lago Puelo",
            "Clima para ma√±ana"
        ];
        suggestions.forEach(text => {
            const button = document.createElement('button');
            button.className = "bg-gray-200 dark:bg-slate-700 text-sm px-3 py-1 rounded-full hover:bg-gray-300 dark:hover:bg-slate-600";
            button.textContent = text;
            button.onclick = () => {
                chatInput.value = text;
                chatForm.dispatchEvent(new Event('submit'));
            };
            suggestionsContainer.appendChild(button);
        });
    }
    
    // --- FIREBASE LISTENERS ---
    function listenForTips() {
        if (!consejosCollectionRef) return;
        onSnapshot(query(consejosCollectionRef, orderBy('createdAt', 'desc')), (snapshot) => {
            tipsCache = [];
            snapshot.docs.forEach(doc => {
                tipsCache.push({ id: doc.id, ...doc.data() });
            });
            if (!rinconModal.classList.contains('hidden')) {
                renderTipsList();
            }
        });
    }
    
    function listenForNewPlaces() {
        if (!lugaresCollectionRef) return;
        onSnapshot(lugaresCollectionRef, (snapshot) => {
            placesCache = [];
            dynamicKnowledgeBase = {
                restaurantes: {},
                alojamiento: {},
                actividades: {},
                lugaresParaVisitar: {}
            };
            snapshot.docs.forEach(doc => {
                const place = { id: doc.id, ...doc.data() };
                placesCache.push(place);
                const tipo = place.tipo;
                if (dynamicKnowledgeBase[tipo]) {
                    if (!dynamicKnowledgeBase[tipo][place.localidad]) {
                        dynamicKnowledgeBase[tipo][place.localidad] = [];
                    }
                    dynamicKnowledgeBase[tipo][place.localidad].push(place);
                }
            });
            if (!isDataReady) {
                chatInput.disabled = false;
                submitButton.disabled = false;
                chatInput.placeholder = "Preg√∫ntame algo...";
                isDataReady = true;
            }
            if(!manageModal.classList.contains('hidden')){
                renderManagementList();
            }
        });
    }
    
    // --- CIERRE DEL MAPA Y ADMIN ---
    closeMapModalBtn.addEventListener('click', () => mapModal.classList.add('hidden'));
    
    passwordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (passwordInput.value === 'andesadmin') {
            isAdmin = true;
            passwordModal.classList.add('hidden');
            adminPanelModal.classList.remove('hidden');
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordInput.classList.remove('border-red-500');
        } else {
            passwordError.classList.remove('hidden');
            passwordInput.classList.add('border-red-500');
        }
    });
    
    // --- INICIALIZAR ---
    initializeFirebase();
    updateSuggestions();
});
</script>
</body>
</html>
