<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andes - Tu Guía en la Comarca</title>
    <script src="https://cdn.tailwindcss.com?v=2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=2" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=2" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js?v=2"></script>

    <style>
        :root {
            --emerald-500: #10b981;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --slate-700: #334155;
            --gray-100: #f3f4f6;
            --white: #ffffff;
        }
        .dark {
            --bg-color: var(--slate-800);
            --text-color: var(--gray-100);
            --card-bg: var(--slate-700);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color, var(--gray-100));
            color: var(--text-color, var(--slate-900));
        }
        .user-message { background-color: var(--emerald-500); color: white; border-radius: 20px 20px 5px 20px; }
        .ai-message { background-color: var(--card-bg, var(--white)); border-radius: 20px 20px 20px 5px; }
        .sponsored-message {
            background-color: var(--card-bg, var(--white));
            border: 2px solid #facc15;
            box-shadow: 0 4px 14px 0 rgba(250, 204, 21, 0.3);
        }
        .place-link { color: var(--emerald-500); font-weight: 500; cursor: pointer; }
        .place-link:hover { text-decoration: underline; }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af;
            border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        /* Estilos para el Rating Modal */
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 2.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating:not(:checked) > label:hover, .star-rating:not(:checked) > label:hover ~ label { color: #f59e0b; }
        /* Mapa */
        #map { height: 100%; width: 100%; }
        .leaflet-container { height: 100%; width: 100%; }
        /* AR */
        .ar-top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 0.5rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .ar-pill { background-color: rgba(0, 0, 0, 0.6); color: white; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; }
        #ar-status { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; color: white; background-color: rgba(0,0,0,0.7); padding: 1rem; border-radius: 0.5rem; text-align: center; }
        
        /* Estilo para el micrófono cuando está escuchando */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-listening {
            color: #ef4444; /* red-500 */
            animation: pulse-red 1.5s infinite;
            border-radius: 50%;
        }

        /* Estilos para la nueva Barra de Acciones */
        .action-btn {
            color: #6b7280; /* gray-500 */
            padding: 0.25rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            flex-grow: 1;
            text-align: center;
        }
        .action-btn:hover {
            background-color: #f3f4f6; /* gray-100 */
            color: #10b981; /* emerald-500 */
        }
        .dark .action-btn {
            color: #9ca3af; /* gray-400 */
        }
        .dark .action-btn:hover {
            background-color: #334155; /* slate-700 */
            color: white;
        }

    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css?v=2">
</head>
<body class="dark bg-gray-100 dark:bg-slate-900 text-gray-900 dark:text-gray-100">

<div class="flex h-screen">
    <main class="flex-1 flex flex-col h-screen">
        <div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4">
            <div class="w-full flex justify-start">
                <div class="ai-message w-fit max-w-xs md:max-w-md lg:max-w-2xl p-3 rounded-2xl shadow">
                    ¡Hola! Soy Andes, tu guía personal en la Comarca Andina. Estoy aquí para ayudarte a descubrir los mejores lugares, planificar tu día o simplemente contarte sobre el clima. ¿En qué puedo ayudarte hoy?
                </div>
            </div>
        </div>

        <div class="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
            <div id="suggestions" class="flex flex-wrap gap-2 mb-2">
                </div>
            <form id="chat-form" class="flex items-center gap-2">
                <div class="relative w-full">
                    <input type="text" id="chat-input" placeholder="Pregúntame algo..." class="w-full p-3 pr-20 rounded-lg border border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    <button type="button" id="mic-btn" class="absolute inset-y-0 right-10 flex items-center p-3 text-gray-500 hover:text-emerald-500">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                    </button>
                </div>
                <button type="submit" class="bg-emerald-500 text-white p-3 rounded-lg hover:bg-emerald-600 disabled:bg-emerald-300">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.544l4.25-1.214a.75.75 0 01.44 1.392l-4.25 1.214a.75.75 0 00-.95.544l-1.414 4.949a.75.75 0 00.826.95l14.083-4.024a.75.75 0 000-1.425L3.105 2.289z" /></svg>
                </button>
            </form>
        </div>

        <div id="action-bar" class="bg-white dark:bg-slate-800 p-2 border-t border-gray-200 dark:border-slate-700">
            <div class="flex justify-around items-center">
                <button id="action-map-btn" class="action-btn">
                    <svg class="h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.1.4-.223.654-.369.26-.15.552-.333.865-.55C12.864 17.113 14 15.823 14 14c0-2.21-1.79-4-4-4S6 11.79 6 14c0 1.823 1.136 3.113 1.966 3.868.313.217.605.4.865.55.254.146.468.269.654.369a5.741 5.741 0 00.28.14l.018.008.006.003zM10 11.25a2.75 2.75 0 100 5.5 2.75 2.75 0 000-5.5z" clip-rule="evenodd" /><path d="M10 2C4.477 2 0 6.477 0 12s4.477 10 10 10 10-4.477 10-10S15.523 2 10 2zM8 14a2 2 0 114 0 2 2 0 01-4 0z" /></svg>
                    <span class="text-xs">Mapa</span>
                </button>
                <button id="action-planner-btn" class="action-btn">
                    <svg class="h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                    <span class="text-xs">Plan</span>
                </button>
                <button id="action-rincon-btn" class="action-btn">
                    <svg class="h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zM6 8a2 2 0 11-4 0 2 2 0 014 0zM1.49 15.326a.78.78 0 01-.358-.442 3 3 0 014.308-3.516 6.484 6.484 0 00-1.905 3.959c-.023.222-.014.442.028.658a.78.78 0 01-.357.443 3.377 3.377 0 01-2.924.001zM18 8a2 2 0 11-4 0 2 2 0 014 0zm-1.808 1.054a6.458 6.458 0 00-1.905-3.959 3 3 0 014.308 3.516.78.78 0 01-.357-.443c.042-.216.051-.436.028-.658a.78.78 0 01-.358.442 3.377 3.377 0 01-2.924-.001zM10 18a3 3 0 100-6 3 3 0 000 6z" /></svg>
                    <span class="text-xs">Rincón</span>
                </button>
                <button id="action-admin-btn" class="action-btn">
                    <svg class="h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                    <span class="text-xs">Admin</span>
                </button>
            </div>
        </div>
    </main>
</div>

<audio id="radio-player" preload="none"></audio>
<script type="module">
    // --- CÓDIGO JAVASCRIPT COMPLETO ---
    // (Este es el bloque que te daré en la Parte 2)
</script>
</body>
</html>
<audio id="radio-player" preload="none"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, setLogLevel, doc, updateDoc, deleteDoc, writeBatch, getDocs, query, orderBy, runTransaction, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

document.addEventListener('DOMContentLoaded', function() {

    // --- OBTENER ELEMENTOS DEL HTML (SECCIÓN 1: ELEMENTOS PRINCIPALES) ---
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const suggestionsContainer = document.getElementById('suggestions');
    const micBtn = document.getElementById('mic-btn');
    
    // --- OBTENER ELEMENTOS DEL HTML (SECCIÓN 2: MODALES) ---
    const contributionModal = document.getElementById('contribution-modal');
    const manageModal = document.getElementById('manage-modal');
    const rinconModal = document.getElementById('rincon-modal');
    const ratingModal = document.getElementById('rating-modal');
    const mapModal = document.getElementById('map-modal');
    const vrModal = document.getElementById('vr-modal');
    const arModal = document.getElementById('ar-modal');
    const passwordModal = document.getElementById('password-modal');
    const adminPanelModal = document.getElementById('admin-panel-modal');
    const plannerModal = document.getElementById('planner-modal');

    // --- OBTENER ELEMENTOS DEL HTML (SECCIÓN 3: BOTONES DE ACCIÓN Y CIERRE) ---
    const actionMapBtn = document.getElementById('action-map-btn');
    const actionPlannerBtn = document.getElementById('action-planner-btn');
    const actionRinconBtn = document.getElementById('action-rincon-btn');
    const actionAdminBtn = document.getElementById('action-admin-btn');
    
    const closeContributionModalBtn = document.getElementById('close-contribution-modal-btn');
    const closeManageModalBtn = document.getElementById('close-manage-modal-btn');
    const closeRinconModalBtn = document.getElementById('close-rincon-modal-btn');
    const closeRatingModalBtn = document.getElementById('close-rating-modal-btn');
    const closeMapModalBtn = document.getElementById('close-map-modal-btn');
    const closeVrModalBtn = document.getElementById('close-vr-modal-btn');
    const closeArModalBtn = document.getElementById('close-ar-modal-btn');
    const closePasswordModalBtn = document.getElementById('close-password-modal-btn');
    const closeAdminPanelBtn = document.getElementById('close-admin-panel-btn');
    const closePlannerModalBtn = document.getElementById('close-planner-modal-btn');

    // --- OBTENER ELEMENTOS DEL HTML (SECCIÓN 4: FORMULARIOS Y PANELES) ---
    const passwordForm = document.getElementById('password-form');
    const passwordInput = document.getElementById('password-input');
    const passwordError = document.getElementById('password-error');
    const adminAddBtn = document.getElementById('admin-add-btn');
    const adminManageBtn = document.getElementById('admin-manage-btn');
    const contributionForm = document.getElementById('contribution-form');
    const tipForm = document.getElementById('tip-form');
    const tipInput = document.getElementById('tip-input');
    const plannerForm = document.getElementById('planner-form');
    const vrSky = document.getElementById('vr-sky');
    const manageList = document.getElementById('manage-list');
    const rinconList = document.getElementById('rincon-list');
    const radioBtn = document.getElementById('radio-btn');
    const radioPlayer = document.getElementById('radio-player');
    const radioLogo = document.getElementById('radio-logo');
    const radioIconOverlay = document.getElementById('radio-icon-overlay');
    const radioStatusText = document.getElementById('radio-status-text');
    const submitButton = chatForm.querySelector('button[type="submit"]');

    // --- VARIABLES GLOBALES ---
    let db, auth, userId;
    let lugaresCollectionRef, consejosCollectionRef;
    let dynamicKnowledgeBase = {}, placesCache = [], chatHistory = [], tipsCache = [];
    let isAdmin = false, isDataReady = false, mapInitialized = false, map = null;
    let markersLayer = null, highlightedMarkerLayer = null, markersById = {};
    let mainRecognition, isMainMicListening = false, activeSpeechInput = null;
    let editingPlaceId = null;
    
    const streamUrl = 'https://streaming6.locucionar.com:24140/stream';
    const geminiApiKey = "AIzaSyCTgtEQ2SorpvrLjm8ntBbPDZVKAxTz6ZI"; 
    const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // --- INICIALIZACIÓN DE LA APP ---
    chatInput.disabled = true;
    chatInput.placeholder = "Conectando...";
    submitButton.disabled = true;
    initializeFirebase();

    // ===============================================================
    // ================ SECCIÓN DE CONEXIÓN DE BOTONES ===============
    // ===============================================================

    actionMapBtn.addEventListener('click', () => {
        mapModal.classList.remove('hidden');
        setTimeout(() => {
            if (!mapInitialized) initMap();
        }, 50);
        setTimeout(() => {
            if(map) map.invalidateSize();
        }, 200);
    });
    actionPlannerBtn.addEventListener('click', () => plannerModal.classList.remove('hidden'));
    actionRinconBtn.addEventListener('click', () => {
        renderTipsList();
        rinconModal.classList.remove('hidden');
    });
    actionAdminBtn.addEventListener('click', () => {
        if (isAdmin) adminPanelModal.classList.remove('hidden');
        else passwordModal.classList.remove('hidden');
    });

    closePlannerModalBtn.addEventListener('click', () => plannerModal.classList.add('hidden'));
    closeRinconModalBtn.addEventListener('click', () => rinconModal.classList.add('hidden'));
    closePasswordModalBtn.addEventListener('click', () => passwordModal.classList.add('hidden'));
    closeAdminPanelBtn.addEventListener('click', () => adminPanelModal.classList.add('hidden'));
    closeManageModalBtn.addEventListener('click', () => manageModal.classList.add('hidden'));
    closeContributionModalBtn.addEventListener('click', () => contributionModal.classList.add('hidden'));
    closeRatingModalBtn.addEventListener('click', () => ratingModal.classList.add('hidden'));
    closeVrModalBtn.addEventListener('click', () => vrModal.classList.add('hidden'));
    closeArModalBtn.addEventListener('click', () => arModal.classList.add('hidden'));
    closeMapModalBtn.addEventListener('click', () => mapModal.classList.add('hidden'));

    passwordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (passwordInput.value === 'andesadmin') {
            isAdmin = true;
            passwordModal.classList.add('hidden');
            adminPanelModal.classList.remove('hidden');
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordInput.classList.remove('border-red-500');
        } else {
            passwordError.classList.remove('hidden');
            passwordInput.classList.add('border-red-500');
        }
    });
    adminAddBtn.addEventListener('click', () => {
        contributionForm.reset();
        editingPlaceId = null;
        document.getElementById('contribution-submit-btn').textContent = 'Añadir Lugar';
        contributionModal.classList.remove('hidden');
        adminPanelModal.classList.add('hidden');
    });
    adminManageBtn.addEventListener('click', () => {
        renderManagementList(); 
        manageModal.classList.remove('hidden');
        adminPanelModal.classList.add('hidden');
    });

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const userMessage = chatInput.value.trim();
        if (userMessage === '') return;
        addMessage({ text: userMessage }, 'user');
        chatInput.value = '';
        processUserMessage(userMessage);
    });

    tipForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const tipText = tipInput.value.trim();
        if (tipText === '' || !consejosCollectionRef) return;
        const submitBtn = tipForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        try {
            await addDoc(consejosCollectionRef, { text: tipText, userId: userId, createdAt: serverTimestamp() });
            tipInput.value = '';
        } catch (error) { console.error("Error al añadir consejo:", error); }
        finally { submitBtn.disabled = false; }
    });
    
    plannerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const style = document.querySelector('#planner-style-group .bg-emerald-500')?.dataset.value || 'Aventura';
        const days = document.getElementById('planner-days').value;
        const energy = document.querySelector('#planner-energy-group .bg-emerald-500')?.dataset.value || 'Medio';
        plannerModal.classList.add('hidden');
        const userMessage = `Quiero un plan de viaje para ${days} días, con un estilo ${style} y nivel de energía ${energy}.`;
        addMessage({ text: userMessage }, 'user');
        processUserMessage(userMessage);
    });

    // ===============================================================
    // ==================== SECCIÓN DE FUNCIONES =====================
    // ===============================================================

    // --- FUNCIONES DE FIREBASE ---
    function initializeFirebase() { /* (El código completo va aquí) */ }
    function getCollectionRef(name) { /* (El código completo va aquí) */ }
    function listenForNewPlaces() { /* (El código completo va aquí) */ }
    function listenForTips() { /* (El código completo va aquí) */ }

    // --- FUNCIONES DEL CHAT ---
    function addMessage(message, sender) { /* (El código completo va aquí) */ }
    async function processUserMessage(userMessage) { /* (El código completo va aquí) */ }
    
    // --- FUNCIONES DE LA IA (GEMINI) ---
    async function getAIResponse(history, systemInstructions) { /* (El código completo va aquí) */ }
    function generateSystemPrompt() { /* (El código completo va aquí) */ }

    // --- MÓDULO DEL CLIMA ---
    const comarcaCoordinates = { /* (El código completo va aquí) */ };
    async function getWeatherData(location) { /* (El código completo va aquí) */ }
    async function formatWeatherResponse(weatherInfo, timeframe) { /* (El código completo va aquí) */ }

    // --- FUNCIONES DEL MAPA ---
    function initMap() { /* (El código completo va aquí) */ }
    function updateMapMarkers() { /* (El código completo va aquí) */ }
    function showPlaceOnMap(place) { /* (El código completo va aquí) */ }
    
    // --- FUNCIONES DE RENDERIZADO Y UI ---
    function renderManagementList() { /* (El código completo va aquí) */ }
    function renderTipsList() { /* (El código completo va aquí) */ }
    function updateSuggestions() { /* (El código completo va aquí) */ }
    function showTypingIndicator() { /* (El código completo va aquí) */ }

    // --- LÓGICA DEL MICRÓFONO ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        // (Toda la lógica del micrófono va aquí)
    } else {
        console.warn("La API de reconocimiento de voz no es compatible con este navegador.");
        micBtn.style.display = 'none';
    }

    // --- LÓGICA DE LA RADIO ---
    function setRadioState(state) { /* (El código completo va aquí) */ }
    radioBtn.addEventListener('click', () => { /* (El código completo va aquí) */ });
    // (Listeners de la radio van aquí)

});
</script>
</body>
</html>
