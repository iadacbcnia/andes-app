<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Turístico: Comarca Andina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Leaflet (para mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qljJZRGuk2/Z9VM+kNiyxNV1IvTIZBo=" crossorigin=""></script>
    <!-- A-Frame (para Realidad Aumentada y Virtual) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }

        /* Estilos para los mensajes del chat */
        .user-message {
            background-color: #059669; /* emerald-600 */
            color: white;
        }

        .ai-message {
            background-color: #dcfce7; /* green-100 */
            color: #064e3b; /* emerald-900 */
        }

        .dark .ai-message {
            background-color: #064e3b; /* emerald-900 */
            color: #dcfce7; /* green-100 */
        }

        .sponsored-message {
            background-color: #fefce8; /* yellow-50 */
            border: 1px solid #facc15; /* yellow-400 */
            color: #713f12; /* yellow-900 */
        }

        .dark .sponsored-message {
            background-color: #422006; /* yellow-900/darker */
            border: 1px solid #facc15; /* yellow-400 */
            color: #fefce8; /* yellow-50 */
        }

        /* Indicador de "escribiendo..." */
        .typing-indicator span {
            height: 8px;
            width: 8px;
            float: left;
            margin: 0 1px;
            background-color: #9ca3af;
            display: block;
            border-radius: 50%;
            opacity: 0.4;
            animation: 1s blink infinite .3333s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: .6666s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: .9999s;
        }

        @keyframes blink {
            50% {
                opacity: 1;
            }
        }

        /* Animación para el botón de la radio */
        @keyframes pulse {
            50% {
                transform: scale(1.1);
            }
        }

        .playing-animation {
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* Estilos de la barra de scroll */
        #chat-window::-webkit-scrollbar,
        #manage-list::-webkit-scrollbar,
        #rincon-list::-webkit-scrollbar,
        #comments-list::-webkit-scrollbar,
        #map-container::-webkit-scrollbar,
        #planner-list-container::-webkit-scrollbar {
            width: 8px;
        }

        #chat-window::-webkit-scrollbar-track,
        #manage-list::-webkit-scrollbar-track,
        #rincon-list::-webkit-scrollbar-track,
        #comments-list::-webkit-scrollbar-track,
        #map-container::-webkit-scrollbar-track,
        #planner-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .dark #chat-window::-webkit-scrollbar-track,
        .dark #manage-list::-webkit-scrollbar-track,
        .dark #rincon-list::-webkit-scrollbar-track,
        .dark #comments-list::-webkit-scrollbar-track,
        .dark #map-container::-webkit-scrollbar-track,
        .dark #planner-list-container::-webkit-scrollbar-track {
            background: #2d3748;
        }

        #chat-window::-webkit-scrollbar-thumb,
        #manage-list::-webkit-scrollbar-thumb,
        #rincon-list::-webkit-scrollbar-thumb,
        #comments-list::-webkit-scrollbar-thumb,
        #map-container::-webkit-scrollbar-thumb,
        #planner-list-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        #chat-window::-webkit-scrollbar-thumb:hover,
        #manage-list::-webkit-scrollbar-thumb:hover,
        #rincon-list::-webkit-scrollbar-thumb:hover,
        #comments-list::-webkit-scrollbar-thumb:hover,
        #map-container::-webkit-scrollbar-thumb:hover,
        #planner-list-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Estilos para notificaciones (toasts) */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: white;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease-in-out;
            display: flex;
            align-items: center;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }
        .toast.info { background-color: #3B82F6; }

        /* Estilos para Valoraciones y Comentarios */
        .place-link {
            font-weight: bold;
            text-decoration: underline;
            color: #059669; /* emerald-600 */
            cursor: pointer;
        }

        .dark .place-link {
            color: #34d399; /* emerald-400 */
        }
        .star-rating {
            display: inline-flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .star-rating input { display: none; }

        .star-rating label {
            cursor: pointer;
            color: #d1d5db; /* gray-300 */
            font-size: 1.5rem;
            transition: color 0.2s;
        }

        .star-rating input:checked ~ label,
        .star-rating:not(:checked) > label:hover,
        .star-rating:not(:checked) > label:hover ~ label {
            color: #f59e0b; /* amber-500 */
        }
        
        /* Estilos para el Mapa */
        #map { height: 100%; width: 100%; z-index: 1; }
        
        .leaflet-popup-content-wrapper {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .dark .leaflet-popup-content-wrapper {
            background: #1f2937; /* slate-800 */
            color: #e5e7eb; /* gray-200 */
        }
        .dark .leaflet-popup-tip {
            background: #1f2937;
        }
        .leaflet-popup-content {
            margin: 10px;
            font-family: 'Inter', sans-serif;
            max-height: 200px;
            overflow-y: auto;
        }
        .leaflet-popup-content p {
            margin: 5px 0;
        }
        .popup-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .popup-description { font-size: 0.9em; margin-bottom: 10px; }
        .popup-vr-button {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background-color: #059669;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }
        .popup-directions-button {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background-color: #3B82F6; /* blue-500 */
            color: white;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            border: none;
            cursor: pointer;
            margin-left: 5px;
        }

        .custom-leaflet-icon {
            background-color: white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            width: 32px !important;
            height: 32px !important;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        .custom-leaflet-icon svg {
            width: 18px;
            height: 18px;
            transform: rotate(45deg);
            color: #059669; /* Icon color */
        }

        /* Estilos para el modal de AR */
        #ar-modal-content {
            position: relative;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #ar-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1200;
            font-size: 1.1rem;
            max-width: 90%;
        }
        .ar-top-bar {
            position: absolute;
            left: 12px;
            top: 12px;
            z-index: 1100;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .ar-pill {
            background: rgba(255, 255, 255, .08);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 13px;
            color: #d8fff0;
        }

        /* Estilos del Planificador */
        .task-card {
            transition: all 0.3s ease;
        }
        .task-card.completed {
            background-color: #f0fdf4; /* green-50 */
            border-left-color: #22c55e; /* green-500 */
        }
        .dark .task-card.completed {
            background-color: #052e16; /* dark green */
            border-left-color: #4ade80; /* green-400 */
        }
        .task-card.completed h3 {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }
        .dark .task-card.completed h3 {
            color: #9ca3af; /* gray-400 */
        }

        .planner-option-btn {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .planner-option-btn.selected {
            border-color: #10b981; /* emerald-500 */
            background-color: #ecfdf5; /* emerald-50 */
            color: #065f46; /* emerald-800 */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .dark .planner-option-btn.selected {
            background-color: #064e3b; /* emerald-900 */
            color: #a7f3d0; /* emerald-200 */
        }

        /* Estilos para el scroll horizontal de sugerencias */
        .horizontal-scroll::-webkit-scrollbar {
            display: none;
        }
        .horizontal-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Estilos para Acordeón de Gestión */
        .accordion-header {
            cursor: pointer;
            transition: background-color: 0.2s ease-out;
        }
        .accordion-header:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .dark .accordion-header:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .accordion-header svg.accordion-arrow {
            transition: transform 0.3s ease-in-out;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-gray-200 flex flex-col h-screen font-sans">

    <!-- Encabezado -->
    <header class="bg-white dark:bg-slate-800 shadow-md z-10 border-b border-gray-200 dark:border-slate-700">
        <div class="container mx-auto px-4 sm:px-6 py-3 flex flex-wrap justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center text-white font-bold text-xl ring-2 ring-offset-2 ring-emerald-500 ring-offset-white dark:ring-offset-slate-800">A</div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 dark:text-gray-100">Andes: Asistente de la Comarca</h1>
                    <p class="text-gray-600 dark:text-gray-400 text-sm">Tu guía experto en el Paralelo 42</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <!-- Botones de acción -->
                <button id="planner-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700" title="Mi Planificador de Viaje">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm-1 6a1 1 0 112 0v1h8V8a1 1 0 112 0v1a1 1 0 01-1 1H6a1 1 0 01-1-1V8z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="ar-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700" title="Vista de Realidad Aumentada">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="map-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700" title="Mapa Interactivo">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <button id="rincon-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700" title="El Rincón del Viajero">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
                        <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2.172l3-3v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
                    </svg>
                </button>
                <!-- Widget de Radio -->
                <div id="radio-widget" class="flex items-center space-x-2 bg-white dark:bg-slate-700 p-1.5 rounded-full shadow-sm border dark:border-slate-600">
                    <button id="play-pause-btn" class="w-8 h-8 flex items-center justify-center bg-emerald-500 text-white rounded-full hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-500"></button>
                    <div class="flex items-center space-x-2 pr-2">
                        <img src="https://i.postimg.cc/8cLnSv8c/Logo-Fm-Paraiso-42.png" alt="Logo FM Paraiso 42" class="w-8 h-8 rounded-full">
                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-200 hidden sm:inline">FM Paraíso 42</span>
                    </div>
                </div>
                <!-- Controles de Administrador -->
                <div id="admin-controls" class="flex space-x-2 hidden">
                    <button id="manage-btn" class="bg-gray-200 dark:bg-slate-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors duration-300">Gestionar</button>
                    <button id="contribute-btn" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition-colors duration-300">Contribuir</button>
                </div>
                <button id="admin-login-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Contenido Principal (Chat) -->
    <main class="flex-1 overflow-y-auto p-4 sm:p-6">
        <div id="chat-window" class="space-y-4 max-w-4xl mx-auto flex flex-col"></div>
    </main>

    <!-- Área de Sugerencias -->
    <div id="suggestions" class="p-4 border-t border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800">
        <div class="max-w-4xl mx-auto flex flex-nowrap gap-2 overflow-x-auto justify-start horizontal-scroll"></div>
    </div>

    <!-- Pie de Página (Input de Chat) -->
    <footer class="bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 p-4">
        <form id="chat-form" class="container mx-auto flex items-center space-x-2 max-w-4xl">
            <input type="text" id="chat-input" placeholder="Conectando con Andes..." class="flex-1 p-3 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-full focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-300" autocomplete="off" disabled>
            <button type="button" id="mic-btn" class="text-gray-500 dark:text-gray-400 rounded-full p-3 hover:bg-gray-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-300" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
            <button type="submit" class="bg-emerald-500 text-white rounded-full p-3 hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-300" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                </svg>
            </button>
        </form>
    </footer>

    <!-- Contenedor para las notificaciones -->
    <div id="toast-container"></div>
    
    <!-- Modal del Planificador de Viaje -->
    <div id="planner-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                <h3 class="text-xl leading-6 font-medium text-gray-900 dark:text-gray-100">Planificador de Viaje Inteligente</h3>
                <button id="close-planner-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2" id="planner-list-container">
                <p class="text-center text-gray-600 dark:text-gray-400 mb-6">Andes creará un plan a tu medida con solo 3 preguntas.</p>
                <form id="smart-planner-form" class="p-4 space-y-8">
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200 text-center">1. Elige tu estilo de viaje</h4>
                        <div id="travel-style-options" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <button type="button" data-style="Aventura" class="planner-option-btn flex flex-col items-center p-4 bg-gray-100 dark:bg-slate-700 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.022 2.222a.75.75 0 011.111 0l3.968 4.25a.75.75 0 01-.555 1.278H.555A.75.75 0 010 6.472l3.968-4.25a.75.75 0 011.054 0z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M5.5 10a.5.5 0 01.5-.5h8a.5.5 0 010 1H6a.5.5 0 01-.5-.5z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M3 13.5a.5.5 0 01.5-.5h13a.5.5 0 010 1H3.5a.5.5 0 01-.5-.5z" clip-rule="evenodd" /></svg>
                                <span class="font-semibold">Aventura</span>
                            </button>
                            <button type="button" data-style="Relax" class="planner-option-btn flex flex-col items-center p-4 bg-gray-100 dark:bg-slate-700 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 00-1-1v-.5a1.5 1.5 0 01-3 0v.5a1 1 0 00-1 1H6a1 1 0 01-1-1v-3a1 1 0 011-1h.5a1.5 1.5 0 000-3H6a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" /></svg>
                                <span class="font-semibold">Relax</span>
                            </button>
                            <button type="button" data-style="Familiar" class="planner-option-btn flex flex-col items-center p-4 bg-gray-100 dark:bg-slate-700 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 00-1-1v-.5a1.5 1.5 0 01-3 0v.5a1 1 0 00-1 1H6a1 1 0 01-1-1v-3a1 1 0 011-1h.5a1.5 1.5 0 000-3H6a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" /></svg>
                                <span class="font-semibold">Familiar</span>
                            </button>
                        </div>
                    </div>
                    <div class="text-center">
                        <label for="planner-days" class="block text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">2. ¿Cuántos días te quedas?</label>
                        <input type="number" id="planner-days" min="1" max="15" value="3" class="w-32 p-2 text-center border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md focus:ring-2 focus:ring-emerald-500 text-lg">
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200 text-center">3. ¿Cuál es tu nivel de energía?</h4>
                        <div id="energy-level-options" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <button type="button" data-energy="Bajo" class="planner-option-btn p-3 bg-gray-100 dark:bg-slate-700 rounded-lg font-semibold">Bajo</button>
                            <button type="button" data-energy="Medio" class="planner-option-btn p-3 bg-gray-100 dark:bg-slate-700 rounded-lg font-semibold">Medio</button>
                            <button type="button" data-energy="Alto" class="planner-option-btn p-3 bg-gray-100 dark:bg-slate-700 rounded-lg font-semibold">Alto</button>
                        </div>
                    </div>
                    <div class="pt-4 text-center">
                        <button type="submit" class="bg-emerald-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-emerald-600 transition-transform transform hover:scale-105 duration-300">
                            + Generar mi Plan Inteligente
                        </button>
                    </div>
                </form>
                <div id="planner-result-container" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Login de Administrador -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-40 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white dark:bg-slate-800">
            <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Acceso de Administrador</h3>
            <form id="admin-login-form" class="mt-4 space-y-4">
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Contraseña</label>
                    <input type="password" id="admin-password" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                    <p id="admin-error-msg" class="text-red-500 text-sm mt-1 hidden">Contraseña incorrecta.</p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-admin-login-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-500 text-white rounded-md hover:bg-emerald-600">Ingresar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Contribución de Datos -->
    <div id="contribution-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                <h3 id="contribution-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Añadir conocimiento a Andes</h3>
                <button id="close-contribution-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-2">
                <div id="contribution-tabs" class="border-b border-gray-200 dark:border-slate-600">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-single" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-emerald-500 border-emerald-500">Añadir Uno</button>
                        <button id="tab-bulk" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">Carga Rápida</button>
                    </nav>
                </div>
                <form id="contribution-form" class="mt-4 space-y-4 text-left">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="lugar-tipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Lugar</label>
                            <select id="lugar-tipo" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                                <option value="restaurantes" data-subtype="Restaurante">Restaurante</option>
                                <option value="restaurantes" data-subtype="Bar">Bar</option>
                                <option value="restaurantes" data-subtype="Confitería">Confitería</option>
                                <option value="restaurantes" data-subtype="Casa de Té">Casa de Té</option>
                                <option value="alojamiento" data-subtype="Apart Hotel">Apart Hotel</option>
                                <option value="alojamiento" data-subtype="Cabañas">Cabañas</option>
                                <option value="alojamiento" data-subtype="Campings">Campings</option>
                                <option value="alojamiento" data-subtype="Hoteles">Hoteles</option>
                                <option value="alojamiento" data-subtype="Hosterias">Hosterias</option>
                                <option value="alojamiento" data-subtype="Hospedajes">Hospedajes</option>
                                <option value="alojamiento" data-subtype="Hostels">Hostels</option>
                                <option value="alojamiento" data-subtype="Alquiler de Casas">Alquiler de Casas</option>
                                <option value="alojamiento" data-subtype="Alquiler de Departamentos">Alquiler de Departamentos</option>
                                <option value="alojamiento" data-subtype="Bread & Breakfast">Bread & Breakfast</option>
                                <option value="actividades">Actividades</option>
                                <option value="lugares Para Visitar">Lugar para Visitar</option>
                            </select>
                        </div>
                        <div>
                            <label for="lugar-localidad" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Localidad</label>
                            <select id="lugar-localidad" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                                <option>El Bolsón</option>
                                <option>Lago Puelo</option>
                                <option>El Hoyo</option>
                                <option>Epuyén</option>
                                <option>El Maitén</option>
                                <option>Cholila</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="lugar-nombre" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre del Lugar</label>
                        <div class="relative w-full mt-1">
                            <input type="text" id="lugar-nombre" required class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                            <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="lugar-direccion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dirección (Opcional)</label>
                        <div class="relative w-full mt-1">
                            <input type="text" id="lugar-direccion" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                            <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="lugar-telefono" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Teléfono (Opcional)</label>
                        <div class="relative w-full mt-1">
                            <input type="text" id="lugar-telefono" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                            <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="lugar-latitud" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Latitud (Opcional)</label>
                            <input type="text" id="lugar-latitud" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="-41.9669">
                        </div>
                        <div>
                            <label for="lugar-longitud" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Longitud (Opcional)</label>
                            <input type="text" id="lugar-longitud" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="-71.5333">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Busca el lugar en Google Maps, haz clic derecho y copia las coordenadas (ej: -41.96, -71.53).</p>
                    <div>
                        <label for="lugar-imagen" class="block text-sm font-medium text-gray-700 dark:text-gray-300">URL de Imagen (Opcional)</label>
                        <input type="url" id="lugar-imagen" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="https://ejemplo.com/foto.jpg">
                    </div>
                    <div>
                        <label for="lugar-imagen360" class="block text-sm font-medium text-gray-700 dark:text-gray-300">URL de Imagen 360° (Opcional)</label>
                        <input type="url" id="lugar-imagen360" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="https://ejemplo.com/foto_360.jpg">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Pega aquí el link a una foto equirectangular (formato 360°).</p>
                    </div>
                    <div>
                        <label for="lugar-descripcion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descripción Principal</label>
                        <div class="relative w-full mt-1">
                            <textarea id="lugar-descripcion" rows="3" required class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm"></textarea>
                            <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="lugar-datos-clave" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Datos Clave / Puntos a Destacar (Opcional)</label>
                        <div class="relative w-full mt-1">
                            <textarea id="lugar-datos-clave" rows="3" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="Ej: Horario: 9 a 18hs. No se aceptan mascotas. Aclaración: No hay un laberinto para niños."></textarea>
                            <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input id="lugar-sponsor" type="checkbox" class="h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                        <label for="lugar-sponsor" class="ml-2 block text-sm text-gray-900 dark:text-gray-300"> Es un lugar recomendado</label>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button id="contribution-submit-btn" type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 flex items-center justify-center min-w-[120px]">Añadir Lugar</button>
                    </div>
                </form>
                <div id="bulk-entry-form-container" class="hidden mt-4 text-left">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Pega cada lugar en una nueva línea. Separa cada dato con una coma. <strong class="dark:text-gray-200">La descripción siempre debe ir al final.</strong></p>
                    <p class="text-xs text-gray-500 dark:text-gray-300 mb-2">Si no tienes un dato (ej: teléfono o coordenadas), deja el espacio vacío entre las comas.</p>
                    <p class="text-xs text-gray-500 dark:text-gray-300 bg-gray-100 dark:bg-slate-700 p-2 rounded-md mb-4"><code>Tipo: Nombre, Localidad, Dirección, Teléfono, Latitud, Longitud, Descripción completa...</code></p>
                    <div class="relative w-full mt-1">
                        <textarea id="bulk-input" rows="8" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Restaurante: A Gusto, El Bolsón, Av. San Martin 2500, 2944112233, -41.963, -71.534, Excelente lugar para comer pastas, abierto mediodía y noche."></textarea>
                        <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    <div class="pt-4 flex justify-end">
                        <button type="button" id="process-bulk-btn" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Procesar</button>
                    </div>
                    <div id="bulk-review-container" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Gestión de Contenido -->
    <div id="manage-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
            <div class="flex flex-wrap justify-between items-center mb-4 pb-2 border-b dark:border-slate-600 gap-2">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Gestionar Contenido</h3>
                <div class="flex items-center gap-2">
                    <button id="restore-backup-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        Restaurar Backup
                    </button>
                    <button id="download-backup-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Descargar Backup
                    </button>
                </div>
            </div>
            <div id="manage-list" class="flex-grow overflow-y-auto pr-2"></div>
            <div class="items-center px-4 py-3 text-right mt-4 border-t dark:border-slate-600">
                <button id="close-manage-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal "El Rincón del Viajero" -->
    <div id="rincon-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">El Rincón del Viajero</h3>
                <button id="close-rincon-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <form id="tip-form" class="mb-4">
                <label for="tip-input" class="sr-only">Deja tu consejo</label>
                <textarea id="tip-input" rows="3" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Comparte un dato, una recomendación o un consejo para otros viajeros..."></textarea>
                <div class="text-right mt-2">
                    <button type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Compartir Consejo</button>
                </div>
            </form>
            <div id="rincon-list" class="flex-grow overflow-y-auto pr-2 space-y-4"></div>
        </div>
    </div>
    
    <!-- Modal de Calificaciones y Comentarios -->
    <div id="rating-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                <h3 id="rating-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Opiniones y Valoraciones</h3>
                <button id="close-rating-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2">
                <div id="average-rating-container" class="text-center mb-4"></div>
                <div id="comments-list" class="space-y-4"></div>
            </div>
            <form id="rating-form" class="mt-4 border-t dark:border-slate-600 pt-4">
                <h4 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Deja tu valoración</h4>
                <div class="star-rating mb-2">
                    <input type="radio" id="5-stars" name="rating" value="5" /><label for="5-stars">★</label>
                    <input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars">★</label>
                    <input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars">★</label>
                    <input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars">★</label>
                    <input type="radio" id="1-star" name="rating" value="1" /><label for="1-star">★</label>
                </div>
                <textarea id="comment-input" rows="3" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Escribe tu comentario aquí..."></textarea>
                <div class="text-right mt-2">
                    <button type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Enviar Opinión</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Input oculto para subir archivos de backup -->
    <input type="file" id="backup-file-input" accept=".csv" class="hidden">
    
    <!-- Modales de Confirmación -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[60] transition-opacity duration-300">
        <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
            <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Confirmar Eliminación</h3>
            <p id="delete-confirmation-text" class="mt-2 text-sm text-gray-600 dark:text-gray-300">¿Estás seguro de que quieres eliminar este elemento?</p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>
    <div id="confirm-restore-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[60] transition-opacity duration-300">
        <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
            <h3 class="text-lg font-medium text-red-600 dark:text-red-400">¡Acción Irreversible!</h3>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                Estás a punto de <strong class="font-bold">BORRAR TODOS</strong> los datos actuales y reemplazarlos por el contenido del archivo de backup.
                <br><br>
                ¿Estás completamente seguro?
            </p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="cancel-restore-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                <button id="confirm-restore-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Sí, restaurar</button>
            </div>
        </div>
    </div>
    <div id="confirm-rubro-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[60] transition-opacity duration-300">
        <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
            <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Confirmar Eliminación de Rubro</h3>
            <p id="rubro-delete-confirmation-text" class="mt-2 text-sm text-gray-600 dark:text-gray-300"></p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="cancel-rubro-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                <button id="confirm-rubro-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Sí, eliminar rubro</button>
            </div>
        </div>
    </div>
    
    <!-- Modal del Mapa -->
    <div id="map-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 h-full w-full hidden z-[80] transition-opacity duration-300 flex flex-col">
        <div class="bg-white dark:bg-slate-800 p-3 flex justify-between items-center shadow-md">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Mapa Interactivo de la Comarca</h3>
            <button id="close-map-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-gray-200" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div id="map-container" class="flex-grow">
            <div id="map"></div>
        </div>
    </div>

    <!-- Modal de Vista 360 (VR) -->
    <div id="vr-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[90] transition-opacity duration-300 flex flex-col">
        <div class="absolute top-0 right-0 p-2 z-10">
            <button id="close-vr-modal-btn" class="p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <a-scene id="vr-scene" embedded>
            <a-sky id="vr-sky" radius="100"></a-sky>
        </a-scene>
    </div>

    <!-- Modal de Realidad Aumentada (AR) -->
    <div id="ar-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[100] transition-opacity duration-300">
        <div id="ar-top-bar" class="ar-top-bar" style="display: none;">
            <button id="close-ar-modal-btn" class="p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            <div id="ar-permissions-pill" class="ar-pill"></div>
        </div>
        <div id="ar-status"></div>
        <div id="ar-modal-content"></div>
    </div>
    
    <!-- Reproductor de audio para la radio -->
    <audio id="radio-player" preload="none"></audio>
    
    <script type="module">
        // --- MÓDULO DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, setLogLevel, doc, updateDoc, deleteDoc, writeBatch, getDocs, getDoc, query, where, orderBy, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CÓDIGO PRINCIPAL ---
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- VARIABLES DE CONFIGURACIÓN Y ESTADO ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            let db, auth, userId, lugaresCollectionRef, consejosCollectionRef;
            let isAdmin = false;
            let map; // Variable para guardar la instancia del mapa
            let consejoIdToDelete = null;
            let placeIdToEdit = null;
            let placeIdToDelete = null;
            let rubroToDelete = { localidad: null, tipo: null };

            // --- REFERENCIAS A ELEMENTOS DEL DOM ---
            const chatWindow = document.getElementById('chat-window');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const micBtn = document.getElementById('mic-btn');
            const submitBtn = chatForm.querySelector('button[type="submit"]');
            const plannerBtn = document.getElementById('planner-btn');
            const arBtn = document.getElementById('ar-btn');
            const mapBtn = document.getElementById('map-btn');
            const rinconBtn = document.getElementById('rincon-btn');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const manageBtn = document.getElementById('manage-btn');
            const contributeBtn = document.getElementById('contribute-btn');
            const adminControls = document.getElementById('admin-controls');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const radioPlayer = document.getElementById('radio-player');
            const manageList = document.getElementById('manage-list');

            // Modales
            const plannerModal = document.getElementById('planner-modal');
            const adminLoginModal = document.getElementById('admin-login-modal');
            const contributionModal = document.getElementById('contribution-modal');
            const manageModal = document.getElementById('manage-modal');
            const rinconModal = document.getElementById('rincon-modal');
            const rinconList = document.getElementById('rincon-list');
            const mapModal = document.getElementById('map-modal');
            const arModal = document.getElementById('ar-modal');
            const confirmDeleteModal = document.getElementById('confirm-delete-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmRubroDeleteModal = document.getElementById('confirm-rubro-delete-modal');
            const confirmRubroDeleteBtn = document.getElementById('confirm-rubro-delete-btn');
            const tipForm = document.getElementById('tip-form');
            const contributionForm = document.getElementById('contribution-form');

            // --- INICIALIZACIÓN DE FIREBASE ---
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            lugaresCollectionRef = getCollectionRef('lugares');
                            consejosCollectionRef = getCollectionRef('consejos');
                            
                            setupRealtimeListeners(); // Configurar listeners de Firestore

                            // Habilitar el chat una vez autenticado
                            chatInput.disabled = false;
                            micBtn.disabled = false;
                            submitBtn.disabled = false;
                            chatInput.placeholder = "Ej: ¿Qué puedo hacer hoy en El Bolsón?";
                        } else {
                            console.log("No user signed in, attempting to sign in.");
                            if (initialAuthToken) {
                                signInWithCustomToken(auth, initialAuthToken).catch(error => console.error("Error with custom token sign-in:", error));
                            } else {
                                signInAnonymously(auth).catch(error => console.error("Error with anonymous sign-in:", error));
                            }
                        }
                    });
                } else {
                    throw new Error("Firebase config is empty.");
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                chatWindow.innerHTML = '<div class="text-red-500 p-4">Error: No se pudo conectar con la base de datos. La configuración de Firebase es incorrecta o está ausente.</div>';
            }

            // --- LÓGICA DE LA RADIO ---
            const streamUrl = 'https://streaming6.locucionar.com:24140/stream';
            const playIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
            const pauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
            
            radioPlayer.src = streamUrl;
            playPauseBtn.innerHTML = playIcon;

            playPauseBtn.addEventListener('click', () => {
                if (radioPlayer.paused) {
                    radioPlayer.play().catch(e => {
                         console.error("Error al reproducir audio:", e);
                         showToast("No se pudo iniciar la radio. Intenta de nuevo.", "error");
                    });
                } else {
                    radioPlayer.pause();
                }
            });

            radioPlayer.addEventListener('play', () => {
                playPauseBtn.innerHTML = pauseIcon;
                playPauseBtn.classList.add('playing-animation');
                showToast("FM Paraíso 42 - En vivo", "info");
            });

            radioPlayer.addEventListener('pause', () => {
                playPauseBtn.innerHTML = playIcon;
                playPauseBtn.classList.remove('playing-animation');
            });

            radioPlayer.addEventListener('error', (e) => {
                console.error("Error en el reproductor de audio:", e);
                showToast("Error en la transmisión de la radio.", "error");
                playPauseBtn.innerHTML = playIcon;
                playPauseBtn.classList.remove('playing-animation');
            });


            // --- LÓGICA DEL CHAT ---
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const userMessage = chatInput.value.trim();
                if (userMessage) {
                    addMessageToChat('user', userMessage);
                    chatInput.value = "";
                    setTimeout(() => generateAndesResponse(userMessage), 500);
                }
            });

            function addMessageToChat(sender, message) {
                const messageElement = document.createElement('div');
                const isUser = sender === 'user';
                messageElement.className = `p-3 rounded-lg max-w-lg ${isUser ? 'user-message self-end' : 'ai-message self-start'}`;
                messageElement.textContent = message;
                chatWindow.appendChild(messageElement);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function showTypingIndicator() {
                const typingElement = document.createElement('div');
                typingElement.id = 'typing-indicator';
                typingElement.className = 'ai-message self-start p-3 rounded-lg';
                typingElement.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
                chatWindow.appendChild(typingElement);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            async function generateAndesResponse(userInput) {
                showTypingIndicator();
                const response = await getBasicResponse(userInput.toLowerCase());
                removeTypingIndicator();
                addMessageToChat('ai', response);
            }

            async function getBasicResponse(input) {
                if (input.includes('hola') || input.includes('buenos dias')) {
                    return '¡Hola! Soy Andes, tu asistente virtual para la Comarca Andina. ¿En qué puedo ayudarte hoy?';
                }
                if (input.includes('cabañas') || input.includes('alojamiento')) {
                    return 'Claro, ¿en qué localidad estás buscando cabañas o alojamiento? Por ejemplo: El Bolsón, Lago Puelo, etc.';
                }
                if (input.includes('comer') || input.includes('restaurante')) {
                    return '¡Excelente idea! Tenemos muchas opciones gastronómicas. ¿Buscas algún tipo de comida en particular?';
                }
                if (input.includes('gracias')) {
                    return '¡De nada! Si necesitas algo más, no dudes en preguntar.';
                }
                return 'No estoy seguro de cómo ayudarte con eso. Intenta preguntarme sobre alojamientos, lugares para comer o actividades en la Comarca.';
            }

            // --- LÓGICA DE MODALES (ABRIR/CERRAR) ---
            document.querySelectorAll('[id^="close-"], [id^="cancel-"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.fixed');
                    if (modal) {
                        if (modal.id === 'contribution-modal') {
                            resetContributionForm();
                        }
                        closeModal(modal);
                    }
                });
            });

            // Botones principales
            plannerBtn.addEventListener('click', () => openModal(plannerModal));
            rinconBtn.addEventListener('click', () => openModal(rinconModal));
            manageBtn.addEventListener('click', () => {
                openModal(manageModal);
                populateManageModal();
            });
            contributeBtn.addEventListener('click', () => openModal(contributionModal));
            arBtn.addEventListener('click', () => {
                showToast("La Realidad Aumentada se está preparando...", "info");
            });
            
            mapBtn.addEventListener('click', () => {
                openModal(mapModal);
            
                const initMap = () => {
                    if (typeof L === 'undefined' || typeof L.map !== 'function') {
                        setTimeout(initMap, 100);
                        return;
                    }
            
                    if (!map) {
                        try {
                            map = L.map('map').setView([-41.9653, -71.5348], 13);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(map);
                        } catch(e) {
                            console.error("Error al inicializar el mapa de Leaflet:", e);
                            showToast("No se pudo crear el mapa.", "error");
                            return;
                        }
                    }
                    
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize();
                        }
                    }, 150);
                };
            
                initMap();
            });

            adminLoginBtn.addEventListener('click', () => openModal(adminLoginModal));

            // LÓGICA DE LOGIN DE ADMINISTRADOR
            const adminLoginForm = document.getElementById('admin-login-form');
            adminLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const password = document.getElementById('admin-password').value;
                const errorMsg = document.getElementById('admin-error-msg');
                if (password === 'andesadmin') {
                    isAdmin = true;
                    showToast('¡Bienvenido, Administrador!', 'success');
                    adminControls.classList.remove('hidden');
                    adminLoginBtn.classList.add('hidden');
                    closeModal(adminLoginModal);
                    adminLoginForm.reset();
                    errorMsg.classList.add('hidden');
                    // Actualizar vistas que dependen del estado de admin
                    setupRealtimeListeners(); 
                } else {
                    errorMsg.classList.remove('hidden');
                }
            });

            // --- LÓGICA DEL PLANIFICADOR INTELIGENTE ---
            const travelStyleOptions = document.getElementById('travel-style-options');
            const energyLevelOptions = document.getElementById('energy-level-options');

            function handleOptionSelection(container, event) {
                const button = event.target.closest('.planner-option-btn');
                if (!button) return;
                container.querySelectorAll('.planner-option-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                button.classList.add('selected');
            }

            travelStyleOptions.addEventListener('click', (e) => handleOptionSelection(travelStyleOptions, e));
            energyLevelOptions.addEventListener('click', (e) => handleOptionSelection(energyLevelOptions, e));

            const smartPlannerForm = document.getElementById('smart-planner-form');
            const plannerResultContainer = document.getElementById('planner-result-container');
            smartPlannerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const style = travelStyleOptions.querySelector('.selected')?.dataset.style;
                const days = document.getElementById('planner-days').value;
                const energy = energyLevelOptions.querySelector('.selected')?.dataset.energy;

                if (!style || !days || !energy) {
                    showToast('Por favor, completa las 3 preguntas.', 'error');
                    return;
                }
                const plan = generateTravelPlan(style, days, energy);
                displayPlan(plan);
                smartPlannerForm.classList.add('hidden');
                plannerResultContainer.classList.remove('hidden');
            });

            function generateTravelPlan(style, days, energy) {
                const budgetMap = { 'Bajo': 15000, 'Medio': 25000, 'Alto': 40000 };
                const dailyBudget = budgetMap[energy] || 25000;
                let plan = { days: [], totalBudget: dailyBudget * days };
                for (let i = 1; i <= days; i++) {
                    let dayPlan = { day: i, activities: [] };
                    if (style === 'Aventura') {
                        dayPlan.activities.push(energy === 'Alto' ? 'Trekking al Cajón del Azul' : 'Paseo al Mirador del Río Azul');
                        if (i % 2 === 0) dayPlan.activities.push('Visita a una cervecería artesanal');
                    } else if (style === 'Relax') {
                        dayPlan.activities.push('Día de campo en chacra de agroturismo');
                        if (energy !== 'Bajo') dayPlan.activities.push('Paseo por la Feria de Artesanos');
                    } else { // Familiar
                        dayPlan.activities.push('Visita al Laberinto Patagonia');
                        if (i > 1) dayPlan.activities.push('Tarde en el Parque Nacional Lago Puelo');
                    }
                    plan.days.push(dayPlan);
                }
                return plan;
            }
            
            function displayPlan(plan) {
                let html = `<h3 class="text-xl font-bold text-center mb-4">Tu Plan de Viaje Sugerido</h3>`;
                plan.days.forEach(day => {
                    html += `<div class="mb-4 p-3 border rounded-lg dark:border-slate-600">
                                <h4 class="font-semibold text-lg text-emerald-600 dark:text-emerald-400">Día ${day.day}</h4>
                                <ul class="list-disc list-inside mt-2 text-gray-700 dark:text-gray-300">`;
                    day.activities.forEach(activity => {
                        html += `<li>${activity}</li>`;
                    });
                    html += '</ul></div>';
                });
                html += `<div class="text-center mt-6">
                            <p class="text-lg font-semibold">Presupuesto diario estimado: <span class="text-emerald-500">$${(plan.totalBudget / plan.days.length).toLocaleString('es-AR')} ARS</span></p>
                            <p class="text-gray-600 dark:text-gray-400">Presupuesto total: $${plan.totalBudget.toLocaleString('es-AR')} ARS</p>
                            <button id="reset-planner-btn" class="mt-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Crear un Nuevo Plan</button>
                         </div>`;
                plannerResultContainer.innerHTML = html;
                document.getElementById('reset-planner-btn').addEventListener('click', () => {
                    plannerResultContainer.classList.add('hidden');
                    smartPlannerForm.classList.remove('hidden');
                    plannerResultContainer.innerHTML = "";
                    travelStyleOptions.querySelectorAll('.selected').forEach(b => b.classList.remove('selected'));
                    energyLevelOptions.querySelectorAll('.selected').forEach(b => b.classList.remove('selected'));
                });
            }

            // --- Lógica de Gestión de Contenido ---
            
            async function populateManageModal() {
                 if (!lugaresCollectionRef) {
                    manageList.innerHTML = '<p class="text-red-500 p-4">Error al conectar con la base de datos.</p>';
                    return;
                }
                manageList.innerHTML = '<p class="text-center p-8 animate-pulse">Cargando lugares...</p>';
                try {
                    const querySnapshot = await getDocs(query(lugaresCollectionRef));
                    if (querySnapshot.empty) {
                        manageList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 p-8">Aún no has añadido ningún lugar.</p>';
                        return;
                    }
                    const groupedPlaces = {};
                    querySnapshot.forEach(doc => {
                        const place = { id: doc.id, ...doc.data() };
                        const { localidad, tipo } = place;
                        if (!localidad || !tipo) return;
                        if (!groupedPlaces[localidad]) {
                            groupedPlaces[localidad] = {};
                        }
                        if (!groupedPlaces[localidad][tipo]) {
                            groupedPlaces[localidad][tipo] = [];
                        }
                        groupedPlaces[localidad][tipo].push(place);
                    });

                    for (const localidad in groupedPlaces) {
                        for (const tipo in groupedPlaces[localidad]) {
                            groupedPlaces[localidad][tipo].sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""));
                        }
                    }

                    let placesHTML = '<div class="space-y-2">';
                    const sortedLocalidades = Object.keys(groupedPlaces).sort();

                    for (const localidad of sortedLocalidades) {
                        const rubrosCount = Object.keys(groupedPlaces[localidad]).length;
                        placesHTML += `
                        <div class="border border-gray-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 shadow-sm overflow-hidden accordion-container">
                            <div class="accordion-header p-4 flex justify-between items-center">
                                <div class="flex items-center gap-4">
                                    <h4 class="text-xl font-bold text-gray-900 dark:text-gray-100">${localidad}</h4>
                                    <span class="text-sm font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded-full">${rubrosCount} ${rubrosCount === 1 ? 'rubro' : 'rubros'}</span>
                                </div>
                                <svg class="w-6 h-6 text-gray-500 dark:text-gray-400 accordion-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="accordion-content bg-gray-50/50 dark:bg-slate-900/50">
                                <div class="p-4 space-y-3">`;

                        const sortedTipos = Object.keys(groupedPlaces[localidad]).sort();
                        for (const tipo of sortedTipos) {
                            const placesCount = groupedPlaces[localidad][tipo].length;
                            placesHTML += `
                            <div class="border border-gray-200 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 overflow-hidden accordion-container">
                                <div class="accordion-header p-3 flex justify-between items-center">
                                     <h5 class="font-semibold text-gray-700 dark:text-gray-300 capitalize flex items-center gap-2 pointer-events-none">
                                        ${tipo}
                                        <span class="text-xs font-bold text-white bg-emerald-500 px-2 py-0.5 rounded-full">${placesCount}</span>
                                    </h5>
                                    <div class="flex items-center gap-2">
                                         <button data-localidad="${localidad}" data-tipo="${tipo}" class="delete-rubro-btn text-gray-400 hover:text-red-500 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50" title="Eliminar todo el rubro '${tipo}'">
                                            <svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                        </button>
                                        <svg class="w-5 h-5 text-gray-400 accordion-arrow pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                                <div class="accordion-content bg-gray-50/50 dark:bg-slate-700/50">
                                     <div class="p-3 space-y-2">`;
                            groupedPlaces[localidad][tipo].forEach(place => {
                                placesHTML += `
                                <div class="flex justify-between items-center p-2 bg-white dark:bg-slate-800/60 rounded-md shadow-sm">
                                    <div>
                                        <p class="font-semibold text-sm text-gray-800 dark:text-gray-200">${place.nombre || 'Sin nombre'}</p>
                                        ${place.subtipo ? `<p class="text-xs text-gray-500 dark:text-gray-400">${place.subtipo}</p>` : ''}
                                    </div>
                                    <div class="flex-shrink-0">
                                        <button data-id="${place.id}" class="edit-place-btn text-blue-500 hover:text-blue-700 font-semibold py-1 px-2 text-xs">Editar</button>
                                        <button data-id="${place.id}" class="delete-place-btn text-red-500 hover:text-red-700 font-semibold py-1 px-2 text-xs">Eliminar</button>
                                    </div>
                                </div>`;
                            });
                            placesHTML += '</div></div></div>';
                        }
                        placesHTML += '</div></div></div>';
                    }
                    placesHTML += '</div>';
                    manageList.innerHTML = placesHTML;
                } catch (error) {
                    console.error("Error obteniendo lugares: ", error);
                    manageList.innerHTML = '<p class="text-red-500 p-4">Ocurrió un error al cargar los lugares.</p>';
                }
            }

            // --- Lógica para El Rincón del Viajero ---
            function setupRealtimeListeners() {
                if (consejosCollectionRef) {
                    const q = query(consejosCollectionRef, orderBy('creadoEn', 'desc'));
                    onSnapshot(q, (querySnapshot) => {
                        if (querySnapshot.empty) {
                            rinconList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 p-8">Nadie ha compartido un consejo todavía. ¡Sé el primero!</p>`;
                            return;
                        }
                        let consejosHTML = '';
                        querySnapshot.forEach((doc) => {
                            const consejo = doc.data();
                            const date = consejo.creadoEn?.toDate().toLocaleString('es-AR') || 'Hace un momento';
                            const deleteButtonHTML = isAdmin 
                                ? `<button data-id="${doc.id}" class="delete-consejo-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50" title="Eliminar consejo">
                                     <svg class="w-5 h-5 pointer-events-none" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                                   </button>`
                                : '';

                            consejosHTML += `
                                <div class="relative bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm border dark:border-slate-700">
                                    <p class="text-gray-800 dark:text-gray-200">${consejo.texto}</p>
                                    <p class="text-xs text-right text-gray-500 dark:text-gray-400 mt-2">- Anónimo, ${date}</p>
                                    ${deleteButtonHTML}
                                </div>
                            `;
                        });
                        rinconList.innerHTML = consejosHTML;
                    });
                }
            }
            
            rinconList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-consejo-btn');
                if (deleteBtn && isAdmin) {
                    consejoIdToDelete = deleteBtn.dataset.id;
                    document.getElementById('delete-confirmation-text').textContent = '¿Estás seguro de que quieres eliminar este consejo? No se podrá recuperar.';
                    openModal(confirmDeleteModal);
                }
            });

            tipForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const tipInput = document.getElementById('tip-input');
                const tipText = tipInput.value.trim();

                if (tipText && consejosCollectionRef) {
                    const submitButton = tipForm.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    try {
                        await addDoc(consejosCollectionRef, {
                            texto: tipText,
                            creadoEn: serverTimestamp(),
                            userId: userId 
                        });
                        tipInput.value = ''; // Clear the input
                        showToast('¡Gracias por tu consejo!', 'success');
                    } catch (error) {
                        console.error("Error al guardar el consejo: ", error);
                        showToast('No se pudo guardar tu consejo.', 'error');
                    } finally {
                        submitButton.disabled = false;
                    }
                }
            });
            
            function resetContributionForm() {
                const submitBtn = document.getElementById('contribution-submit-btn');
                if (submitBtn) { // Check if the button exists
                    contributionForm.reset();
                    document.getElementById('contribution-title').textContent = 'Añadir conocimiento a Andes';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Añadir Lugar';
                    placeIdToEdit = null;
                }
            }
             confirmDeleteBtn.addEventListener('click', async () => {
                if (consejoIdToDelete) {
                    try {
                        const docRef = doc(db, `/artifacts/${appId}/public/data/consejos`, consejoIdToDelete);
                        await deleteDoc(docRef);
                        showToast('Consejo eliminado correctamente.', 'success');
                    } catch (error) {
                        console.error("Error al eliminar el consejo:", error);
                        showToast('No se pudo eliminar el consejo.', 'error');
                    } finally {
                        consejoIdToDelete = null;
                        closeModal(confirmDeleteModal);
                    }
                }
            });

            cancelDeleteBtn.addEventListener('click', () => {
                consejoIdToDelete = null;
                placeIdToDelete = null;
            });
            
            // --- Lógica de Pestañas de Contribución (Single/Bulk) ---
            const tabSingle = document.getElementById('tab-single');
            const tabBulk = document.getElementById('tab-bulk');
            const bulkEntryForm = document.getElementById('bulk-entry-form-container');

            tabSingle.addEventListener('click', () => {
                tabSingle.classList.add('text-emerald-500', 'border-emerald-500');
                tabSingle.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                tabBulk.classList.remove('text-emerald-500', 'border-emerald-500');
                tabBulk.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                contributionForm.classList.remove('hidden');
                bulkEntryForm.classList.add('hidden');
            });
            
            tabBulk.addEventListener('click', () => {
                tabBulk.classList.add('text-emerald-500', 'border-emerald-500');
                tabBulk.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                tabSingle.classList.remove('text-emerald-500', 'border-emerald-500');
                tabSingle.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                bulkEntryForm.classList.remove('hidden');
                contributionForm.classList.add('hidden');
            });
            
            const processBulkBtn = document.getElementById('process-bulk-btn');
            const bulkInput = document.getElementById('bulk-input');
            const bulkReviewContainer = document.getElementById('bulk-review-container');

            processBulkBtn.addEventListener('click', () => {
                const lines = bulkInput.value.trim().split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) {
                    showToast('Por favor, pega al menos un lugar para procesar.', 'error');
                    return;
                }
                bulkReviewContainer.innerHTML = "";
                let reviewHTML = '<h4 class="text-md font-semibold mb-2 mt-4">Revisa los datos antes de confirmar:</h4>';
                let hasErrors = false;
                let placesToUpload = [];

                lines.forEach((line, index) => {
                    const parts = line.split(',');
                    if (parts.length < 3) { // Must have at least Type:Name, Location, Description
                        reviewHTML += `<div class="p-3 bg-red-100 dark:bg-red-900 rounded-lg mb-2 text-red-800 dark:text-red-200"><strong>Línea ${index + 1} (Error):</strong> Faltan datos. Se requiere al menos "Tipo: Nombre, Localidad, Descripción".</div>`;
                        hasErrors = true; return;
                    }
                    const [tipoNombre, localidad, ...rest] = parts;
                    const descripcion = rest.join(',').trim(); // Re-join description if it contained commas
                    const tipoNombreParts = tipoNombre.split(':');

                    if (tipoNombreParts.length < 2 || !tipoNombreParts[0].trim() || !tipoNombreParts[1].trim()) {
                        reviewHTML += `<div class="p-3 bg-red-100 dark:bg-red-900 rounded-lg mb-2 text-red-800 dark:text-red-200"><strong>Línea ${index + 1} (Error):</strong> Formato incorrecto. Asegúrate de que empieza con "Tipo: Nombre del lugar,".</div>`;
                        hasErrors = true;
                        return;
                    }
                    
                    const tipo = tipoNombreParts[0].trim();
                    const nombre = tipoNombreParts.slice(1).join(':').trim();

                    if (!tipo || !nombre || !localidad || !descripcion) {
                        reviewHTML += `<div class="p-3 bg-red-100 dark:bg-red-900 rounded-lg mb-2 text-red-800 dark:text-red-200"><strong>Línea ${index + 1} (Error):</strong> Faltan datos obligatorios (Tipo, Nombre, Localidad o Descripción).</div>`;
                        hasErrors = true; return;
                    }
                    placesToUpload.push({ tipo, nombre, localidad, descripcion });
                    reviewHTML += `<div class="p-3 bg-gray-100 dark:bg-slate-700 rounded-lg mb-2"><p class="font-bold text-emerald-700 dark:text-emerald-300">${nombre}</p><p><strong class="text-gray-600 dark:text-gray-400">Tipo:</strong> ${tipo}</p><p><strong class="text-gray-600 dark:text-gray-400">Localidad:</strong> ${localidad}</p><p><strong class="text-gray-600 dark:text-gray-400">Descripción:</strong> ${descripcion.substring(0, 50)}...</p></div>`;
                });
                
                if (!hasErrors) {
                    reviewHTML += `<div class="text-right mt-4"><button id="confirm-bulk-upload" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Confirmar y Guardar ${placesToUpload.length} Lugares</button></div>`;
                } else {
                    reviewHTML += '<p class="text-red-500 mt-4 font-semibold">Corrige los errores marcados en rojo antes de poder guardar.</p>';
                }
                bulkReviewContainer.innerHTML = reviewHTML;
                
                if (!hasErrors) {
                    const confirmBtn = document.getElementById('confirm-bulk-upload');
                    if (confirmBtn) {
                        confirmBtn.addEventListener('click', async (e) => {
                            confirmBtn.disabled = true;
                            confirmBtn.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
                            try {
                                const batch = writeBatch(db);
                                placesToUpload.forEach(place => {
                                    const newPlaceRef = doc(lugaresCollectionRef);
                                    batch.set(newPlaceRef, {
                                        ...place,
                                        creadoEn: serverTimestamp()
                                    });
                                });
                                await batch.commit();
                                showToast(`¡Se guardaron ${placesToUpload.length} lugares con éxito!`, 'success');
                                bulkReviewContainer.innerHTML = '<p class="text-green-500 p-4 text-center font-semibold">¡Datos guardados correctamente!</p>';
                                bulkInput.value = '';
                                populateManageModal(); // Refresh the list
                            } catch(error) {
                                console.error("Error al guardar en lote: ", error);
                                showToast('Ocurrió un error al guardar los lugares.', 'error');
                                confirmBtn.disabled = false;
                                confirmBtn.textContent = `Confirmar y Guardar ${placesToUpload.length} Lugares`;
                            }
                        });
                    }
                }
            });

            //--- FUNCIONES AUXILIARES ---
            function getCollectionRef(name) {
                if (!db) {
                    console.error("Firestore DB not initialized.");
                    return null;
                }
                return collection(db, `/artifacts/${appId}/public/data/${name}`);
            }

            function showToast(message, type = 'info', duration = 4000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        toast.remove();
                    }, 500);
                }, duration);
            }

            function openModal(modal) {
                modal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            function closeModal(modal) {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        });
    </script>
</body>
</html>

