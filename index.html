<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andes - Tu Gu√≠a en la Comarca</title>
    <script src="https://cdn.tailwindcss.com?v=2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=2" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=2" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js?v=2"></script>
    <!-- html2pdf para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --emerald-500: #10b981;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --slate-700: #334155;
            --gray-100: #f3f4f6;
            --white: #ffffff;
        }
        .dark {
            --bg-color: var(--slate-800);
            --text-color: var(--gray-100);
            --card-bg: var(--slate-700);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color, var(--gray-100));
            color: var(--text-color, var(--slate-900));
            margin: 0;
            padding: 0;
            overflow: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .user-message { background-color: var(--emerald-500); color: white; border-radius: 20px 20px 5px 20px; }
        .ai-message {
            background-color: var(--slate-700);
            color: #ffffff;
            border-radius: 20px 20px 20px 5px;
            padding: 1rem;
            line-height: 1.5;
        }
        .sponsored-message {
            background-color: var(--card-bg, var(--white));
            border: 2px solid #facc15;
            box-shadow: 0 4px 14px 0 rgba(250, 204, 21, 0.3);
        }
        .place-link { color: var(--emerald-500); font-weight: 500; cursor: pointer; }
        .place-link:hover { text-decoration: underline; }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af;
            border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 2.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating:not(:checked) > label:hover, .star-rating:not(:checked) > label:hover ~ label { color: #f59e0b; }
        #map { height: 100%; width: 100%; }
        .ar-top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 0.5rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .ar-pill { background-color: rgba(0, 0, 0, 0.6); color: white; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; }
        #ar-status { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; color: white; background-color: rgba(0,0,0,0.7); padding: 1rem; border-radius: 0.5rem; text-align: center; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-listening {
            color: #ef4444;
            animation: pulse-red 1.5s infinite;
            border-radius: 50%;
        }
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--bg-color, var(--gray-100));
            border-top: 1px solid var(--slate-700);
            padding: 0.5rem 0;
            z-index: 50;
        }
        .bottom-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-color, var(--slate-900));
            font-size: 0.75rem;
            padding: 0.25rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .bottom-nav-btn.active, .bottom-nav-btn:hover {
            color: var(--emerald-500);
        }
        .bottom-nav-btn svg {
            width: 1.5rem;
            height: 1.5rem;
            margin-bottom: 0.25rem;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        .input-container {
            padding: 1rem;
            background-color: var(--bg-color, var(--gray-100));
            border-top: 1px solid var(--slate-700);
        }
        .radio-player-container {
            padding: 0.5rem 1rem;
            background-color: var(--card-bg, var(--white));
            border-top: 1px solid var(--slate-700);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .radio-logo-container {
            position: relative;
            width: 2.5rem;
            height: 2.5rem;
            background-color: black;
            border-radius: 50%;
        }
        .radio-logo {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            opacity: 0.7;
        }
        .radio-icon-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        /* Estilos para Storybook */
        #storybook-dropzone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        #storybook-dropzone.error {
            border-color: #ef4444;
        }
        #storybook-dropzone:hover {
            border-color: var(--emerald-500);
        }
        #storybook-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .storybook-photo-item {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .storybook-photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .storybook-delete-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        #storybook-story-output {
            margin-top: 1.5rem;
        }
        /* Nuevos estilos para el libro */
        #storybook-result-container {
            background: #fdfaf4; /* Creamy paper color */
            border: 1px solid #ddd;
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            padding: 2rem;
            border-radius: 5px;
            color: #333; /* Dark text for readability */
        }
        .storybook-book-layout {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .storybook-left-page, .storybook-right-page {
            flex: 1;
        }
        .storybook-story-title {
            font-family: Georgia, 'Times New Roman', Times, serif;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--emerald-500);
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .storybook-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }
        .storybook-photos-grid img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .storybook-story-text {
            font-family: Georgia, 'Times New Roman', Times, serif;
            white-space: pre-wrap;
            line-height: 1.7;
            font-size: 1.1rem;
            color: #333;
        }
        @media (min-width: 768px) {
            .storybook-book-layout {
                flex-direction: row;
                gap: 2rem;
            }
            .storybook-left-page {
                border-right: 1px dashed #ccc;
                padding-right: 2rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css?v=2">
</head>
<body class="dark bg-gray-100 dark:bg-slate-900 text-gray-900 dark:text-gray-100">
    <!-- Pantalla de Bienvenida -->
    <div id="welcome-screen" class="flex flex-col items-center justify-center p-4 bg-gradient-to-b from-emerald-500 to-emerald-700 text-white w-full min-h-[100dvh] fixed inset-0 z-50 transition-opacity duration-500 box-border">
        <div class="max-w-sm w-full flex flex-col items-center justify-center" style="max-height: calc(100dvh - env(safe-area-inset-top, 10px) - env(safe-area-inset-bottom, 80px)); overflow-y: auto; padding-bottom: env(safe-area-inset-bottom, 80px); padding-top: env(safe-area-inset-top, 10px);">
            <img src="https://i.postimg.cc/4d45rq7k/Chat-GPT-Image-28-sept-2025-19-09-13.png" alt="Andes, el Pudu Pudu gu√≠a" class="w-full rounded-xl shadow-lg mb-3">
            <h1 class="text-xl md:text-2xl font-bold mb-3 text-center">¬°Bienvenido, soy Andes!</h1>
            <p class="text-sm mb-4 text-center">Tu gu√≠a personal en la Comarca Andina.</p>
            <div class="space-y-2 mb-6">
                <div class="flex items-center justify-center gap-2">
                    <span class="bg-white text-emerald-600 px-2 py-0.5 rounded-full text-xs font-bold">‚ú®</span>
                    <span>Preg√∫ntame por lugares o planes</span>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="bg-white text-emerald-600 px-2 py-0.5 rounded-full text-xs font-bold">üó∫Ô∏è</span>
                    <span>Explora el mapa interactivo</span>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="bg-white text-emerald-600 px-2 py-0.5 rounded-full text-xs font-bold">üìª</span>
                    <span>Escucha FM Para√≠so 42 en vivo</span>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="bg-white text-emerald-600 px-2 py-0.5 rounded-full text-xs font-bold">üìñ</span>
                    <span>Crea tu Storybook de viaje</span>
                </div>
            </div>
            <button id="start-chat-btn" class="bg-white text-emerald-600 font-bold py-2.5 px-6 rounded-full text-base shadow-lg hover:bg-gray-100 transition-transform transform hover:scale-105 whitespace-nowrap">
                Comenzar
            </button>
        </div>
    </div>

    <!-- App principal -->
    <div id="main-app" class="hidden flex flex-col h-dvh">
        <!-- Chat y resto del contenido -->
        <div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4">
            <div class="w-full flex justify-start">
                <div class="ai-message w-fit max-w-xs md:max-w-md lg:max-w-2xl p-3 rounded-2xl shadow">
                    ¬°Hola! Soy Andes, tu gu√≠a personal en la Comarca Andina. Estoy aqu√≠ para ayudarte a descubrir los mejores lugares, planificar tu d√≠a o simplemente contarte sobre el clima. ¬øEn qu√© puedo ayudarte hoy?
                </div>
            </div>
        </div>
        <div class="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
            <div id="suggestions" class="flex flex-wrap gap-2 mb-2"></div>
            <form id="chat-form" class="flex items-center gap-2">
                <div class="relative w-full">
                    <input type="text" id="chat-input" placeholder="Conectando..." class="w-full p-3 pr-20 rounded-lg border border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 focus:outline-none" disabled>
                    <button type="button" id="mic-btn" class="absolute inset-y-0 right-10 flex items-center p-3 text-gray-500 hover:text-emerald-500">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                    </button>
                </div>
                <button type="submit" class="bg-emerald-500 text-white p-3 rounded-lg hover:bg-emerald-600 disabled:bg-emerald-300" disabled>
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.544l4.25-1.214a.75.75 0 01.44 1.392l-4.25 1.214a.75.75 0 00-.95.544l-1.414 4.949a.75.75 0 00.826.95l14.083-4.024a.75.75 0 000-1.425L3.105 2.289z" /></svg>
                </button>
            </form>
        </div>
        <div class="bg-gray-100 dark:bg-slate-700 p-2 border-t border-gray-200 dark:border-slate-600">
            <button id="radio-btn" class="w-full flex items-center justify-center">
                <div id="radio-logo-container" class="relative flex-shrink-0 w-8 h-8">
                    <img id="radio-logo" src="https://i.postimg.cc/8cLnSv8c/Logo-Fm-Paraiso-42.png" alt="Logo FM Para√≠so 42" class="w-full h-full rounded-full object-cover transition-opacity duration-300 opacity-70">
                    <div id="radio-icon-overlay" class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white"></div>
                </div>
                <div class="ml-2 overflow-hidden">
                    <p class="font-semibold text-sm truncate">FM Para√≠so 42</p>
                    <p id="radio-status-text" class="text-xs text-gray-500 dark:text-gray-400">Click para escuchar</p>
                </div>
            </button>
        </div>
        <div class="flex justify-around items-center p-2 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-600">
            <button id="planner-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                <span>Plan</span>
            </button>
            <button id="rincon-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zM6 8a2 2 0 11-4 0 2 2 0 014 0zM1.49 15.326a.78.78 0 01-.358-.442 3 3 0 014.308-3.516 6.484 6.484 0 00-1.905 3.959c-.023.222-.014.442.028.658a.78.78 0 01-.357.443 3.377 3.377 0 01-2.924.001zM18 8a2 2 0 11-4 0 2 2 0 014 0zm-1.808 1.054a6.458 6.458 0 00-1.905-3.959 3 3 0 014.308 3.516.78.78 0 01-.357-.443c.042-.216.051-.436.028-.658a.78.78 0 01-.358.442 3.377 3.377 0 01-2.924-.001zM10 18a3 3 0 100-6 3 3 0 000 6z" /></svg>
                <span>Rinc√≥n</span>
            </button>
            <button id="map-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.1.4-.223.654-.369.26-.15.552-.333.865-.55C12.864 17.113 14 15.823 14 14c0-2.21-1.79-4-4-4S6 11.79 6 14c0 1.823 1.136 3.113 1.966 3.868.313.217.605.4.865.55.254.146.468.269.654.369a5.741 5.741 0 00.28.14l.018.008.006.003zM10 11.25a2.75 2.75 0 100 5.5 2.75 2.75 0 000-5.5z" clip-rule="evenodd" /><path d="M10 2C4.477 2 0 6.477 0 12s4.477 10 10 10 10-4.477 10-10S15.523 2 10 2zM8 14a2 2 0 114 0 2 2 0 01-4 0z" /></svg>
                <span>Mapa</span>
            </button>
            <button id="storybook-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <span>Storybook</span>
            </button>
            <button id="ar-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 1a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 1zM4.879 4.879a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061L4.879 5.94a.75.75 0 010-1.06zM1 8a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5H1.75A.75.75 0 011 8zm3.879 4.182a.75.75 0 010 1.06l-1.06 1.06a.75.75 0 11-1.06-1.06l1.06-1.061a.75.75 0 011.06 0zM8 15a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 15zm4.182-3.879a.75.75 0 011.06 0l1.06 1.06a.75.75 0 11-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zM15 8a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 0115 8zm3.121-3.121a.75.75 0 010 1.06l-1.06 1.06a.75.75 0 01-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zM10 5a5 5 0 100 10 5 5 0 000-10zM5 10a5 5 0 1110 0 5 5 0 01-10 0z" clip-rule="evenodd" /></svg>
                <span>AR</span>
            </button>
            <button id="admin-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                <span>Admin</span>
            </button>
        </div>

        <!-- MODAL STORYBOOK -->
        <div id="storybook-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-1/2 -translate-y-1/2 mx-auto p-6 w-full max-w-2xl xl:max-w-4xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">üìñ Mi Storybook de Viaje</h3>
                    <button id="close-storybook-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Sube hasta 10 fotos de tu viaje y responde 3 preguntas. Andes crear√° una historia √∫nica para ti.</p>

                <!-- Formulario y Preview lado a lado en pantallas grandes -->
                <div class="md:flex md:gap-6">
                    <!-- Columna Izquierda: Formulario -->
                    <div class="md:w-1/2">
                        <!-- Subida de fotos -->
                        <div id="storybook-dropzone" class="mb-4">
                            <p>Arrastra tus fotos aqu√≠ o haz clic para seleccionar</p>
                            <input type="file" id="storybook-file-input" accept="image/*" multiple class="hidden">
                        </div>
                        <div id="storybook-preview" class="mb-6"></div>

                        <!-- Formulario -->
                        <form id="storybook-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. ¬øCu√°l fue el destino principal de tu viaje?</label>
                                <input type="text" id="q1" class="w-full p-2 rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">2. ¬øCon qui√©n viajaste?</label>
                                <input type="text" id="q2" class="w-full p-2 rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">3. ¬øQu√© momento fue el m√°s inolvidable?</label>
                                <input type="text" id="q3" class="w-full p-2 rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Informaci√≥n adicional (opcional)</label>
                                <textarea id="extra" rows="3" class="w-full p-2 rounded border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-emerald-500 text-white py-2 rounded-lg hover:bg-emerald-600">Generar mi historia</button>
                        </form>
                    </div>

                    <!-- Columna Derecha: Resultado -->
                    <div class="md:w-1/2 mt-6 md:mt-0">
                         <div id="storybook-result" class="hidden">
                            <div id="storybook-story-output"></div>
                            <div class="flex gap-3 mt-4">
                                <button id="download-pdf-btn" class="flex-1 bg-blue-500 text-white py-2 rounded-lg">üì• Descargar PDF</button>
                                <button id="share-whatsapp-btn" class="flex-1 bg-green-500 text-white py-2 rounded-lg">üì≤ WhatsApp</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modales restantes -->
        <div id="planner-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-1/2 -translate-y-1/2 mx-auto p-8 border-0 w-full max-w-2xl shadow-2xl rounded-2xl bg-white dark:bg-slate-800">
                <div class="text-center mb-8">
                    <div class="inline-block bg-emerald-100 dark:bg-emerald-900/50 p-3 rounded-full mb-3">
                        <svg class="h-10 w-10 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.5-13.5-3.432 3.432-3.432-3.432s.5-1.5 1.5-1.5 2.432 1.5 3.432 1.5 1.932-1.5 1.932-1.5ZM8.25 18.75h7.5" />
                        </svg>
                    </div>
                    <h3 class="text-2xl leading-6 font-bold text-gray-900 dark:text-gray-100">Crea tu Aventura Perfecta</h3>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Solo necesitamos 3 datos para dise√±arte un plan a medida.</p>
                </div>
                <button id="close-planner-modal-btn" class="absolute top-4 left-4 p-2 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700 hover:text-gray-600 dark:hover:text-gray-200">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                   </svg>
                </button>
                <form id="planner-form" class="space-y-6">
                    <div>
                        <label class="flex items-center text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
                            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white font-bold mr-3">1</span>
                            Tu estilo de viaje
                        </label>
                        <div id="planner-style-group" class="grid grid-cols-3 gap-4 mt-2">
                            <button type="button" data-value="Aventura" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-emerald-500 text-white border-emerald-500">
                                <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg>
                                <span class="font-semibold">Aventura</span>
                            </button>
                            <button type="button" data-value="Relax" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-slate-600">
                                <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" /></svg>
                                <span class="font-semibold">Relax</span>
                            </button>
                            <button type="button" data-value="Familiar" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-slate-600">
                                <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962A3.75 3.75 0 0115 12a3.75 3.75 0 01-2.25 3.512m-9.75-2.962c0-.552.246-1.631 1.25-2.262a25.814 25.814 0 017.5 0c1.004.631 1.25 1.71 1.25 2.262m-9.75 1.068c0 .551.246 1.631 1.25 2.261a25.814 25.814 0 007.5 0c1.004-.63 1.25-1.71 1.25-2.261M12 6a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5z" /></svg>
                                <span class="font-semibold">Familiar</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="planner-days" class="flex items-center text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
                            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white font-bold mr-3">2</span>
                            ¬øCu√°ntos d√≠as te quedas?
                        </label>
                        <input type="number" id="planner-days" value="3" min="1" max="14" class="mt-1 block w-full p-3 border-2 border-gray-200 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 rounded-lg shadow-sm text-base text-center font-bold text-xl focus:border-emerald-500 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="flex items-center text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
                            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white font-bold mr-3">3</span>
                            Tu nivel de energ√≠a
                        </label>
                        <div id="planner-energy-group" class="grid grid-cols-3 gap-4 mt-2">
                            <button type="button" data-value="Bajo" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-slate-600">
                                <span class="text-2xl">üê¢</span>
                                <span class="font-semibold">Bajo</span>
                            </button>
                            <button type="button" data-value="Medio" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-emerald-500 text-white border-emerald-500">
                                <span class="text-2xl">üö∂‚Äç‚ôÇÔ∏è</span>
                                <span class="font-semibold">Medio</span>
                            </button>
                            <button type="button" data-value="Alto" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-slate-600">
                                <span class="text-2xl">‚ö°</span>
                                <span class="font-semibold">Alto</span>
                            </button>
                        </div>
                    </div>
                    <div class="pt-6">
                        <button type="submit" class="w-full flex items-center justify-center gap-3 bg-emerald-500 text-white font-bold py-4 px-4 rounded-xl hover:bg-emerald-600 text-lg transition-transform transform hover:scale-105 shadow-lg">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M3.5 2.75a.75.75 0 00-1.5 0v14.5a.75.75 0 001.5 0v-4.392l1.657-.348a6.44 6.44 0 014.231.575l.256.102a.75.75 0 00.868-.133l4.25-4.25a.75.75 0 00-.133-.868l-.102-.256a6.44 6.44 0 01-.575-4.231l.348-1.657V2.75z" />
                            </svg>
                            Generar Mi Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div id="password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white dark:bg-slate-800">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Acceso de Administrador</h3>
                    <form id="password-form" class="mt-4 space-y-4">
                        <div>
                            <label for="password-input" class="sr-only">Contrase√±a</label>
                            <input type="password" id="password-input" placeholder="Ingresa la contrase√±a" class="w-full p-2 rounded-md border border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700">
                            <p id="password-error" class="text-red-500 text-xs mt-1 hidden">Contrase√±a incorrecta.</p>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" id="close-password-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-emerald-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-emerald-600">Entrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="admin-panel-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
                <div class="flex justify-between items-center pb-3 border-b dark:border-slate-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Panel de Administraci√≥n</h3>
                    <button id="close-admin-panel-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="mt-4 space-y-3">
                    <p class="text-sm text-gray-600 dark:text-gray-300">Desde aqu√≠ puedes a√±adir nuevo contenido y gestionar la informaci√≥n existente.</p>
                    <button id="admin-add-btn" class="w-full flex items-center justify-center text-left p-3 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-medium">
                        <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        A√±adir Nuevo Lugar
                    </button>
                    <button id="admin-manage-btn" class="w-full flex items-center justify-center text-left p-3 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium">
                        <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2.5 4A1.5 1.5 0 001 5.5v9A1.5 1.5 0 002.5 16h15a1.5 1.5 0 001.5-1.5v-9A1.5 1.5 0 0017.5 4h-15zM2 5.5a.5.5 0 01.5-.5h15a.5.5 0 01.5.5v9a.5.5 0 01-.5.5h-15a.5.5 0 01-.5-.5v-9zM8 8a.75.75 0 000 1.5h4a.75.75 0 000-1.5H8z" clip-rule="evenodd" /></svg>
                        Gestionar Contenido
                    </button>
                </div>
            </div>
        </div>
        <div id="contribution-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[65] transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="mt-3 text-center">
                    <h3 id="contribution-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">A√±adir conocimiento a Andes</h3>
                    <div class="mt-2 flex-grow overflow-y-auto p-2">
                        <div id="contribution-tabs" class="border-b border-gray-200 dark:border-slate-600">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <button id="tab-single" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-emerald-500 border-emerald-500">A√±adir Uno</button>
                                <button id="tab-bulk" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">Carga R√°pida</button>
                            </nav>
                        </div>
                        <form id="contribution-form" class="mt-4 space-y-4 text-left">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="lugar-tipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Lugar</label>
                                    <select id="lugar-tipo" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                        <option value="restaurantes" data-subtype="Restaurante">Restaurante</option>
                                        <option value="restaurantes" data-subtype="Bar">Bar</option>
                                        <option value="restaurantes" data-subtype="Confiter√≠a">Confiter√≠a</option>
                                        <option value="restaurantes" data-subtype="Casa de T√©">Casa de T√©</option>
                                        <option value="alojamiento" data-subtype="Apart Hotel">Apart Hotel</option>
                                        <option value="alojamiento" data-subtype="Caba√±as">Caba√±as</option>
                                        <option value="alojamiento" data-subtype="Campings">Campings</option>
                                        <option value="alojamiento" data-subtype="Hoteles">Hoteles</option>
                                        <option value="alojamiento" data-subtype="Hosterias">Hosterias</option>
                                        <option value="alojamiento" data-subtype="Hospedajes">Hospedajes</option>
                                        <option value="alojamiento" data-subtype="Hostels">Hostels</option>
                                        <option value="alojamiento" data-subtype="Alquiler de Casas">Alquiler de Casas</option>
                                        <option value="alojamiento" data-subtype="Alquiler de Departamentos">Alquiler de Departamentos</option>
                                        <option value="alojamiento" data-subtype="Bread & Breakfast">Bread & Breakfast</option>
                                        <option value="actividades">Actividades</option>
                                        <option value="lugaresParaVisitar">Lugar para Visitar</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="lugar-localidad" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Localidad</label>
                                    <select id="lugar-localidad" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                        <option>El Bols√≥n</option>
                                        <option>Lago Puelo</option>
                                        <option>El Hoyo</option>
                                        <option>Epuy√©n</option>
                                        <option>El Mait√©n</option>
                                        <option>Cholila</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="lugar-nombre" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre del Lugar</label>
                                <div class="relative w-full mt-1">
                                    <input type="text" id="lugar-nombre" required class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="lugar-direccion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Direcci√≥n (Opcional)</label>
                                <div class="relative w-full mt-1">
                                    <input type="text" id="lugar-direccion" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="lugar-telefono" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tel√©fono (Opcional)</label>
                                <div class="relative w-full mt-1">
                                    <input type="text" id="lugar-telefono" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="lugar-latitud" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Latitud (Opcional)</label>
                                    <input type="text" id="lugar-latitud" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="-41.9669">
                                </div>
                                <div>
                                    <label for="lugar-longitud" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Longitud (Opcional)</label>
                                    <input type="text" id="lugar-longitud" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="-71.5333">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Busca el lugar en Google Maps, haz clic derecho y copia las coordenadas (ej: -41.96, -71.53).</p>
                            <div>
                                <label for="lugar-imagen" class="block text-sm font-medium text-gray-700 dark:text-gray-300">URL de Imagen (Opcional)</label>
                                <input type="url" id="lugar-imagen" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="https://ejemplo.com/foto.jpg">
                            </div>
                            <div>
                                <label for="lugar-imagen360" class="block text-sm font-medium text-gray-700 dark:text-gray-300">URL de Imagen 360¬∞ (Opcional)</label>
                                <input type="url" id="lugar-imagen360" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="https://ejemplo.com/foto_360.jpg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Pega aqu√≠ el link a una foto equirectangular (formato 360¬∞).</p>
                            </div>
                            <div>
                                <label for="lugar-descripcion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descripci√≥n Principal</label>
                                <div class="relative w-full mt-1">
                                   <textarea id="lugar-descripcion" rows="3" required class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm"></textarea>
                                   <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                       <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                   </button>
                                </div>
                            </div>
                            <div>
                                <label for="lugar-datos-clave" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Datos Clave / Puntos a Destacar (Opcional)</label>
                                <div class="relative w-full mt-1">
                                    <textarea id="lugar-datos-clave" rows="3" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="Ej: Horario: 9 a 18hs.
No se aceptan mascotas.
Aclaraci√≥n: No hay un laberinto para ni√±os."></textarea>
                                    <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                       <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                   </button>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <input id="lugar-sponsor" type="checkbox" class="h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                <label for="lugar-sponsor" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">‚≠ê Es un lugar recomendado</label>
                            </div>
                            <div class="pt-4 flex justify-end">
                                <button id="contribution-submit-btn" type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 flex items-center justify-center min-w-[120px]">A√±adir Lugar</button>
                            </div>
                        </form>
                        <div id="bulk-entry-form-container" class="hidden mt-4 text-left">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Pega cada lugar en una nueva l√≠nea. Separa cada dato con una coma. <strong class="dark:text-gray-200">La descripci√≥n siempre debe ir al final.</strong></p>
                            <p class="text-xs text-gray-500 dark:text-gray-300 mb-2">Si no tienes un dato (ej: tel√©fono o coordenadas), deja el espacio vac√≠o entre las comas.</p>
                            <p class="text-xs text-gray-500 dark:text-gray-300 bg-gray-100 dark:bg-slate-700 p-2 rounded-md mb-4"><code>Tipo: Caba√±as, Nombre: Mi Caba√±a, Localidad: El Bols√≥n, ... , Descripci√≥n completa...: Texto libre.</code></p>
                            <div class="relative w-full mt-1">
                                <textarea id="bulk-input" rows="8" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md" placeholder="Tipo: Caba√±as, Nombre: Caba√±a La Escondida, Localidad: El Hoyo, Direcci√≥n: Curva de fin de la recta de El Pedregoso, Tel√©fono: +54 (294) 459-7157, Latitud: -42.007621, Longitud: -71.522818, Descripci√≥n completa...: Caba√±a con capacidad para 4 personas, ideal para el descanso"></textarea>
                                <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                </button>
                            </div>
                            <div class="pt-4 flex justify-end">
                                <button type="button" id="process-bulk-btn" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Procesar</button>
                            </div>
                            <div id="bulk-review-container" class="mt-4"></div>
                        </div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-contribution-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="manage-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[60] transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="flex flex-wrap justify-between items-center mb-4 pb-2 border-b dark:border-slate-600 gap-2">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Gestionar Contenido</h3>
                    <div class="flex items-center gap-2">
                        <button id="restore-backup-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                            Restaurar Backup
                        </button>
                        <button id="download-backup-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Descargar Backup
                        </button>
                    </div>
                </div>
                <div id="manage-list" class="flex-grow overflow-y-auto pr-2">
                </div>
                <div class="items-center px-4 py-3 text-right mt-4 border-t dark:border-slate-600">
                    <button id="close-manage-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600">Cerrar</button>
                </div>
            </div>
        </div>
        <div id="rincon-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">El Rinc√≥n del Viajero</h3>
                    <button id="close-rincon-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <form id="tip-form" class="mb-4">
                    <label for="tip-input" class="sr-only">Deja tu consejo</label>
                    <textarea id="tip-input" rows="3" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Comparte un dato, una recomendaci√≥n o un consejo para otros viajeros..."></textarea>
                    <div class="text-right mt-2">
                        <button type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Compartir Consejo</button>
                    </div>
                </form>
                <div id="rincon-list" class="flex-grow overflow-y-auto pr-2 space-y-4">
                </div>
            </div>
        </div>
        <div id="rating-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                    <h3 id="rating-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Opiniones y Valoraciones</h3>
                    <button id="close-rating-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div class="flex-grow overflow-y-auto pr-2">
                    <div id="average-rating-container" class="text-center mb-4"></div>
                    <div id="comments-list" class="space-y-4"></div>
                </div>
                <form id="rating-form" class="mt-4 border-t dark:border-slate-600 pt-4">
                    <h4 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Deja tu valoraci√≥n</h4>
                    <div class="star-rating mb-2">
                        <input type="radio" id="5-stars" name="rating" value="5" /><label for="5-stars">‚òÖ</label>
                        <input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars">‚òÖ</label>
                        <input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars">‚òÖ</label>
                        <input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars">‚òÖ</label>
                        <input type="radio" id="1-star" name="rating" value="1" /><label for="1-star">‚òÖ</label>
                    </div>
                    <textarea id="comment-input" rows="3" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Escribe tu comentario aqu√≠..."></textarea>
                    <div class="text-right mt-2">
                        <button type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Enviar Opini√≥n</button>
                    </div>
                </form>
            </div>
        </div>
        <input type="file" id="backup-file-input" accept=".csv" class="hidden">
        <div id="confirm-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
            <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Confirmar Eliminaci√≥n</h3>
                <p id="delete-confirmation-text" class="mt-2 text-sm text-gray-600 dark:text-gray-300">¬øEst√°s seguro de que quieres eliminar este elemento?</p>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Eliminar</button>
                </div>
            </div>
        </div>
        <div id="confirm-restore-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
                <h3 class="text-lg font-medium text-red-600 dark:text-red-400">¬°Acci√≥n Irreversible!</h3>
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                    Est√°s a punto de <strong class="font-bold">BORRAR TODOS</strong> los datos actuales y reemplazarlos por el contenido del archivo de backup.
                    <br><br>
                    ¬øEst√°s completamente seguro?
                </p>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancel-restore-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                    <button id="confirm-restore-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">S√≠, restaurar</button>
                </div>
            </div>
        </div>
        <div id="confirm-rubro-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
            <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
                <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Confirmar Eliminaci√≥n de Rubro</h3>
                <p id="rubro-delete-confirmation-text" class="mt-2 text-sm text-gray-600 dark:text-gray-300"></p>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancel-rubro-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                    <button id="confirm-rubro-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">S√≠, eliminar rubro</button>
                </div>
            </div>
        </div>
        <div id="map-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 h-full w-full hidden z-[80] transition-opacity duration-300 flex flex-col">
            <div class="bg-white dark:bg-slate-800 p-3 flex justify-between items-center shadow-md">
                <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Mapa Interactivo de la Comarca</h3>
                <button id="close-map-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-gray-200" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div id="map-container" class="flex-grow">
                <div id="map"></div>
            </div>
        </div>
        <div id="vr-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[90] transition-opacity duration-300 flex flex-col">
            <div class="absolute top-0 right-0 p-2 z-10">
                <button id="close-vr-modal-btn" class="p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <a-scene id="vr-scene" embedded>
                <a-sky id="vr-sky" radius="100"></a-sky>
            </a-scene>
        </div>
        <div id="ar-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[100] transition-opacity duration-300">
            <div id="ar-top-bar" class="ar-top-bar" style="display: none;">
                <button id="close-ar-modal-btn" class="p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="ar-permissions-pill" class="ar-pill"></div>
            </div>
            <div id="ar-status"></div>
            <div id="ar-modal-content">
            </div>
        </div>
        <audio id="radio-player" preload="none"></audio>
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, updateDoc, deleteDoc, writeBatch, getDocs, query, orderBy, runTransaction, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            document.addEventListener('DOMContentLoaded', function() {
                // --- ELEMENTOS ---
                const chatWindow = document.getElementById('chat-window');
                const chatForm = document.getElementById('chat-form');
                const chatInput = document.getElementById('chat-input');
                const suggestionsContainer = document.getElementById('suggestions');
                const micBtn = document.getElementById('mic-btn');
                const contributionModal = document.getElementById('contribution-modal');
                const manageModal = document.getElementById('manage-modal');
                const rinconModal = document.getElementById('rincon-modal');
                const ratingModal = document.getElementById('rating-modal');
                const mapModal = document.getElementById('map-modal');
                const vrModal = document.getElementById('vr-modal');
                const arModal = document.getElementById('ar-modal');
                const passwordModal = document.getElementById('password-modal');
                const adminPanelModal = document.getElementById('admin-panel-modal');
                const plannerModal = document.getElementById('planner-modal');
                const confirmDeleteModal = document.getElementById('confirm-delete-modal');
                const confirmRubroDeleteModal = document.getElementById('confirm-rubro-delete-modal');
                const deleteConfirmationText = document.getElementById('delete-confirmation-text');
                const rubroDeleteConfirmationText = document.getElementById('rubro-delete-confirmation-text');
                const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
                const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
                const cancelRubroDeleteBtn = document.getElementById('cancel-rubro-delete-btn');
                const confirmRubroDeleteBtn = document.getElementById('confirm-rubro-delete-btn');
                const ratingModalTitle = document.getElementById('rating-modal-title');
                const averageRatingContainer = document.getElementById('average-rating-container');
                const commentsList = document.getElementById('comments-list');
                const ratingForm = document.getElementById('rating-form');
                const commentInput = document.getElementById('comment-input');
                const rinconBtn = document.getElementById('rincon-btn');
                const mapBtn = document.getElementById('map-btn');
                const arBtn = document.getElementById('ar-btn');
                const adminBtn = document.getElementById('admin-btn');
                const plannerBtn = document.getElementById('planner-btn');
                const storybookBtn = document.getElementById('storybook-btn');
                const closeContributionModalBtn = document.getElementById('close-contribution-modal-btn');
                const closeManageModalBtn = document.getElementById('close-manage-modal-btn');
                const closeRinconModalBtn = document.getElementById('close-rincon-modal-btn');
                const closeRatingModalBtn = document.getElementById('close-rating-modal-btn');
                const closeMapModalBtn = document.getElementById('close-map-modal-btn');
                const closeVrModalBtn = document.getElementById('close-vr-modal-btn');
                const closeArModalBtn = document.getElementById('close-ar-modal-btn');
                const closePasswordModalBtn = document.getElementById('close-password-modal-btn');
                const closeAdminPanelBtn = document.getElementById('close-admin-panel-btn');
                const closePlannerModalBtn = document.getElementById('close-planner-modal-btn');
                const passwordForm = document.getElementById('password-form');
                const passwordInput = document.getElementById('password-input');
                const passwordError = document.getElementById('password-error');
                const adminAddBtn = document.getElementById('admin-add-btn');
                const adminManageBtn = document.getElementById('admin-manage-btn');
                const contributionForm = document.getElementById('contribution-form');
                const tipForm = document.getElementById('tip-form');
                const tipInput = document.getElementById('tip-input');
                const plannerForm = document.getElementById('planner-form');
                const vrSky = document.getElementById('vr-sky');
                const manageList = document.getElementById('manage-list');
                const rinconList = document.getElementById('rincon-list');
                const submitButton = chatForm.querySelector('button[type="submit"]');
                const radioBtn = document.getElementById('radio-btn');
                const radioPlayer = document.getElementById('radio-player');
                const radioLogo = document.getElementById('radio-logo');
                const radioIconOverlay = document.getElementById('radio-icon-overlay');
                const radioStatusText = document.getElementById('radio-status-text');
                const streamUrl = 'https://streaming6.locucionar.com:24140/stream';
                
                // --- STORYBOOK ELEMENTS ---
                const storybookModal = document.getElementById('storybook-modal');
                const closeStorybookModal = document.getElementById('close-storybook-modal');

                chatInput.disabled = true;
                chatInput.placeholder = "Conectando...";
                submitButton.disabled = true;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let db;
                let auth;
                let userId;
                let lugaresCollectionRef;
                let consejosCollectionRef;
                let dynamicKnowledgeBase = {};
                let placesCache = [];
                let chatHistory = [];
                let tipsCache = [];
                let isAdmin = false; 
                let isDataReady = false;
                let map = null;
                let mapInitialized = false;
                let parsedBulkData = []; 
                let editingBulkIndex = null;
                let editingPlaceId = null; 
                let deleteAction = null; 
                let currentPlaceIdForRating = null;
                let currentPlaceCommentsUnsubscribe = null;
                let markersLayer = null;
                let markersById = {};
                let mainRecognition;
                let isMainMicListening = false;
                let activeSpeechInput = null;

                // Variables para Storybook
                let storybookPhotos = [];

                // --- INICIALIZAR FIREBASE ---
                function initializeFirebase() {
                    try {
                        let firebaseConfig;
                        let initialAuthToken = null;
                        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                            firebaseConfig = JSON.parse(__firebase_config);
                            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        } else {
                            firebaseConfig = {
                                apiKey: "AIzaSyB2Z9PnT0bz9SI47_BW1BcW1tjqbQjYnC0",
                                authDomain: "andes-app-turismo.firebaseapp.com",
                                projectId: "andes-app-turismo",
                                storageBucket: "andes-app-turismo.appspot.com",
                                messagingSenderId: "685878856963",
                                appId: "1:685878856963:web:660823dfdac24a0c39ed36"
                            };
                        }
                        if (!firebaseConfig || !firebaseConfig.apiKey) {
                             throw new Error("La configuraci√≥n de Firebase es inv√°lida o no fue encontrada.");
                        }
                        const app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        auth = getAuth(app);
                        onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                userId = user.uid;
                                lugaresCollectionRef = getCollectionRef('lugares');
                                consejosCollectionRef = getCollectionRef('consejos');
                                if (lugaresCollectionRef) listenForNewPlaces();
                                if (consejosCollectionRef) listenForTips();
                            } else {
                                 try {
                                     if (initialAuthToken) {
                                         await signInWithCustomToken(auth, initialAuthToken);
                                     } else {
                                         await signInAnonymously(auth);
                                     }
                                 } catch (authError) {
                                     console.error("Error durante el inicio de sesi√≥n:", authError);
                                     if (authError.code === 'auth/configuration-not-found') {
                                        chatWindow.innerHTML = `<div class="ai-message text-red-500 p-4"><strong>Error de Configuraci√≥n:</strong> No se encontr√≥ una configuraci√≥n de autenticaci√≥n v√°lida. Verifica las reglas de tu proyecto Firebase.</div>`;
                                     }
                                 }
                            }
                        });
                    } catch (error) {
                        console.error("Error grave al inicializar Firebase:", error);
                        chatWindow.innerHTML = `<div class="ai-message text-red-500 p-4"><strong>Error de Conexi√≥n:</strong> No se pudo inicializar la base de datos. Por favor, recarga la p√°gina. <br><small>${error.message}</small></div>`;
                    }
                }

                function getCollectionRef(name) {
                    if (!db) {
                        console.error("Firestore DB not initialized.");
                        return null;
                    }
                    const path = `/artifacts/${appId}/public/data/${name}`;
                    return collection(db, path);
                };

                // --- MODALES ---
                function setupModalToggle(openBtn, modal, closeBtn) {
                    if (openBtn) openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
                    if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
                }
                setupModalToggle(rinconBtn, rinconModal, closeRinconModalBtn);
                setupModalToggle(plannerBtn, plannerModal, closePlannerModalBtn);
                setupModalToggle(null, ratingModal, closeRatingModalBtn); 
                setupModalToggle(null, contributionModal, closeContributionModalBtn);
                setupModalToggle(null, manageModal, closeManageModalBtn);
                setupModalToggle(storybookBtn, storybookModal, closeStorybookModal);

                adminBtn.addEventListener('click', () => {
                    if (isAdmin) {
                        adminPanelModal.classList.remove('hidden');
                    } else {
                        passwordModal.classList.remove('hidden');
                    }
                });
                closePasswordModalBtn.addEventListener('click', () => passwordModal.classList.add('hidden'));
                closeAdminPanelBtn.addEventListener('click', () => adminPanelModal.classList.add('hidden'));
                passwordForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (passwordInput.value === 'andesadmin') {
                        isAdmin = true;
                        passwordModal.classList.add('hidden');
                        adminPanelModal.classList.remove('hidden');
                        passwordInput.value = '';
                        passwordError.classList.add('hidden');
                        passwordInput.classList.remove('border-red-500');
                    } else {
                        passwordError.classList.remove('hidden');
                        passwordInput.classList.add('border-red-500');
                    }
                });
                adminAddBtn.addEventListener('click', () => {
                    contributionForm.reset();
                    editingPlaceId = null;
                    editingBulkIndex = null;
                    document.getElementById('contribution-title').textContent = 'A√±adir Lugar';
                    document.getElementById('contribution-submit-btn').textContent = 'A√±adir Lugar';
                    contributionModal.classList.remove('hidden');
                    adminPanelModal.classList.add('hidden');
                });
                adminManageBtn.addEventListener('click', () => {
                    renderManagementList(); 
                    manageModal.classList.remove('hidden');
                    adminPanelModal.classList.add('hidden');
                });
                arBtn.addEventListener('click', () => arModal.classList.remove('hidden'));
                closeArModalBtn.addEventListener('click', () => arModal.classList.add('hidden'));
                closeVrModalBtn.addEventListener('click', () => vrModal.classList.add('hidden'));
                closeMapModalBtn.addEventListener('click', () => mapModal.classList.add('hidden'));

                // --- STORYBOOK LOGIC ---
                function setupStorybook() {
                    const storybookDropzone = document.getElementById('storybook-dropzone');
                    const storybookFileInput = document.getElementById('storybook-file-input');
                    const storybookPreview = document.getElementById('storybook-preview');
                    const storybookForm = document.getElementById('storybook-form');
                    const storybookResult = document.getElementById('storybook-result');
                    const storybookStoryOutput = document.getElementById('storybook-story-output');
                    
                    storybookDropzone.addEventListener('click', () => {
                        if (storybookPhotos.length < 10) storybookFileInput.click();
                    });

                    storybookFileInput.addEventListener('change', (e) => handleFiles(e.target.files));
                    storybookDropzone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        storybookDropzone.style.borderColor = '#10b981';
                    });

                    storybookDropzone.addEventListener('dragleave', () => {
                        storybookDropzone.style.borderColor = '#cbd5e1';
                    });

                    storybookDropzone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        storybookDropzone.style.borderColor = '#cbd5e1';
                        if (storybookPhotos.length < 10) handleFiles(e.dataTransfer.files);
                    });

                    function handleFiles(files) {
                        const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                        const newFiles = validFiles.slice(0, 10 - storybookPhotos.length);
                        newFiles.forEach(file => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                storybookPhotos.push({ file, preview: e.target.result });
                                renderStorybookPreview();
                            };
                            reader.readAsDataURL(file);
                        });
                        storybookFileInput.value = '';
                    }

                    function renderStorybookPreview() {
                        storybookPreview.innerHTML = '';
                        storybookPhotos.forEach((photo, index) => {
                            const div = document.createElement('div');
                            div.className = 'storybook-photo-item';
                            div.innerHTML = `<img src="${photo.preview}" alt="Foto ${index+1}"><div class="storybook-delete-btn" data-index="${index}">√ó</div>`;
                            storybookPreview.appendChild(div);
                        });
                    }

                    storybookPreview.addEventListener('click', (e) => {
                        const deleteBtn = e.target.closest('.storybook-delete-btn');
                        if (deleteBtn) {
                            storybookPhotos.splice(deleteBtn.dataset.index, 1);
                            renderStorybookPreview();
                        }
                    });

                    storybookForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        storybookDropzone.classList.remove('error');
                        if (storybookPhotos.length === 0) {
                            storybookDropzone.classList.add('error');
                            setTimeout(() => storybookDropzone.classList.remove('error'), 2000);
                            return;
                        }

                        const q1 = document.getElementById('q1').value;
                        const q2 = document.getElementById('q2').value;
                        const q3 = document.getElementById('q3').value;
                        const extra = document.getElementById('extra').value;

                        storybookResult.classList.remove('hidden');
                        storybookStoryOutput.innerHTML = `<div class="flex justify-center items-center h-full"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;

                        const base64Photos = await Promise.all(storybookPhotos.map(photo => new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(photo.file);
                        })));

                        const prompt = `Eres Andes, un narrador de viajes experto. Basado en las siguientes fotos y respuestas, crea una historia emotiva y detallada del viaje del usuario, como si fuera un libro de recuerdos.\n\nDestino: ${q1}\nCompa√±√≠a: ${q2}\nMomento inolvidable: ${q3}\nInformaci√≥n adicional: ${extra || "Ninguna"}\n\nDescribe los paisajes, emociones, colores, sonidos y momentos especiales. Usa un tono c√°lido, po√©tico y personal. La historia debe tener entre 300 y 500 palabras.`;

                        try {
                            const apiKey = "AIzaSyCH9o4_vc4ih8G95AEXGnk7fF3ZnP1aYas"; // Ser√° inyectada por el entorno de ejecuci√≥n
                            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: prompt }, ...base64Photos.map(b64 => ({ inlineData: { mimeType: 'image/jpeg', data: b64 } }))] }]
                                })
                            });
                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error.message || `Error ${response.status}`);
                            }
                            const data = await response.json();
                            if (!data.candidates || !data.candidates[0].content.parts[0].text) {
                                throw new Error('La respuesta de la API no tuvo el formato esperado.');
                            }
                            const story = data.candidates[0].content.parts[0].text;
                            
                            storybookStoryOutput.innerHTML = `
                                <div id="storybook-result-container">
                                    <div class="storybook-book-layout">
                                        <div class="storybook-left-page">
                                            <h3 class="storybook-story-title">Mi Viaje a ${q1}</h3>
                                            <div class="storybook-photos-grid">
                                                ${storybookPhotos.map(p => `<img src="${p.preview}" alt="Recuerdo de viaje">`).join('')}
                                            </div>
                                        </div>
                                        <div class="storybook-right-page">
                                            <p class="storybook-story-text">${story}</p>
                                        </div>
                                    </div>
                                </div>`;
                        } catch (error) {
                            console.error('Error generando historia:', error);
                            storybookStoryOutput.innerHTML = `<p class="text-red-500">Hubo un error al generar tu historia. Por favor, intenta de nuevo.<br><small>${error.message}</small></p>`;
                        }
                    });
                    
                    storybookResult.addEventListener('click', (e) => {
                        const downloadPdfBtn = e.target.closest('#download-pdf-btn');
                        const shareWhatsappBtn = e.target.closest('#share-whatsapp-btn');
                        
                        if (downloadPdfBtn) {
                            const storyContainer = document.getElementById('storybook-result-container');
                            const q1 = document.getElementById('q1').value || 'viaje';
                             if (storyContainer) {
                                const elementToPrint = storyContainer.cloneNode(true);
                                // Asegurarnos de que el texto sea negro en el PDF
                                const textElement = elementToPrint.querySelector('.storybook-story-text');
                                if (textElement) textElement.style.color = '#000';

                                html2pdf().from(elementToPrint).set({
                                    margin: 0.5,
                                    filename: `mi-viaje-${q1.replace(/\s+/g, '-')}.pdf`,
                                    image: { type: 'jpeg', quality: 0.98 },
                                    html2canvas: { scale: 2, useCORS: true },
                                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                                }).save();
                            }
                        }
                        if (shareWhatsappBtn) {
                            const storyTextElement = storybookResult.querySelector('.storybook-story-text');
                            if(storyTextElement) {
                                const introText = "¬°Mira la historia de mi viaje que cre√≥ Andes! üåÑ\n\n";
                                const storyText = storyTextElement.textContent;
                                const text = encodeURIComponent(introText + storyText);
                                window.open(`https://wa.me/?text=${text}`, '_blank');
                            }
                        }
                    });
                }
                setupStorybook();

                async function getWeatherData(location) {
                    const locationKey = location.toLowerCase().trim();
                    const smnLocationMap = {
                        "el bols√≥n": 87765, 
                        "lago puelo": 87765,
                        "el hoyo": 87765,
                        "epuy√©n": 87828,
                        "el mait√©n": 87828,
                        "cholila": 87828,
                        "bariloche": 87765,
                        "san carlos de bariloche": 87765
                    };
                    const stationId = smnLocationMap[locationKey];
                
                    if (!stationId) {
                        return { error: "Lo siento, solo puedo darte el clima de las localidades de la Comarca Andina." };
                    }
                
                    try {
                        const proxyUrl = 'https://api.allorigins.win/raw?url=';
                        const targetUrl = encodeURIComponent('https://ws.smn.gob.ar/map_items/weather');
                        const response = await fetch(proxyUrl + targetUrl);

                        if (!response.ok) throw new Error("No se pudo conectar al SMN a trav√©s del proxy.");
                        const data = await response.json();
                        
                        const cityData = data.find(item => item.station_id == stationId);
                        
                        if (!cityData || !cityData.weather) {
                           throw new Error("No se encontraron datos para la estaci√≥n.");
                        }
                        
                        return {
                            data: {
                                temp: cityData.weather.temperature,
                                description: cityData.weather.description
                            },
                            location: cityData.name,
                            requestedLocation: location
                        };
                    } catch (error) {
                        console.error("Error fetching SMN weather via proxy:", error);
                        return { error: "Tuve un problema para conectarme con el Servicio Meteorol√≥gico. Intenta de nuevo en un momento." };
                    }
                }

                async function formatWeatherResponse(weatherInfo) {
                    if (weatherInfo.error) {
                        return weatherInfo.error;
                    }
                    const temp = Math.round(weatherInfo.data.temp);
                    const desc = weatherInfo.data.description;
                    const apiLocationName = weatherInfo.location;
                    const userLocationName = weatherInfo.requestedLocation.charAt(0).toUpperCase() + weatherInfo.requestedLocation.slice(1);

                    let responseText = `üå§Ô∏è En ${apiLocationName} (cercano a ${userLocationName}) la temperatura actual es de ${temp}¬∞C y est√° ${desc.toLowerCase()}.`;
                    if (apiLocationName.toLowerCase().includes(userLocationName.toLowerCase())) {
                       responseText = `üå§Ô∏è El clima actual en ${userLocationName} es de ${temp}¬∞C. Se presenta ${desc.toLowerCase()}.`;
                    }
                    return responseText;
                }

                function startApp() {
                    const welcomeScreen = document.getElementById('welcome-screen');
                    const mainApp = document.getElementById('main-app');
                    if (welcomeScreen) welcomeScreen.classList.add('hidden');
                    if (mainApp) mainApp.classList.remove('hidden');
                    initializeFirebase();
                    updateSuggestions();
                }
                const startChatBtn = document.getElementById('start-chat-btn');
                if (startChatBtn) {
                    startChatBtn.addEventListener('click', startApp);
                } else {
                    initializeFirebase();
                    updateSuggestions();
                }

                function showTypingIndicator() {
                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'w-full flex justify-start';
                    typingDiv.innerHTML = `
                        <div class="ai-message w-fit p-3 rounded-2xl shadow">
                            <div class="typing-indicator">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    `;
                    chatWindow.appendChild(typingDiv);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    return typingDiv;
                }

                function getCommentsCollectionRef(placeId) {
                    if (!placeId) return null;
                    return collection(db, `/artifacts/${appId}/public/data/lugares/${placeId}/comentarios`);
                }

                function openRatingModal(placeId) {
                    const place = placesCache.find(p => p.id === placeId);
                    if (!place) return;
                    currentPlaceIdForRating = placeId;
                    ratingModalTitle.textContent = `Opiniones de "${place.nombre}"`;
                    ratingForm.reset();
                    commentsList.innerHTML = '<p class="text-gray-500">Cargando comentarios...</p>';
                    averageRatingContainer.innerHTML = '';
                    ratingModal.classList.remove('hidden');
                    if (currentPlaceCommentsUnsubscribe) {
                        currentPlaceCommentsUnsubscribe();
                    }
                    const commentsRef = getCommentsCollectionRef(placeId);
                    if(commentsRef){
                        currentPlaceCommentsUnsubscribe = onSnapshot(query(commentsRef, orderBy('createdAt', 'desc')), (snapshot) => {
                            const comments = [];
                            let totalRating = 0;
                            snapshot.forEach(doc => {
                                const commentData = doc.data();
                                comments.push(commentData);
                                totalRating += commentData.rating || 0;
                            });
                            renderComments(comments);
                            if (comments.length > 0) {
                                const average = totalRating / comments.length;
                                renderAverageRating(average, comments.length);
                            } else {
                                averageRatingContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Este lugar a√∫n no tiene valoraciones.</p>';
                            }
                        });
                    }
                }

                function renderAverageRating(average, count) {
                    const stars = '‚òÖ'.repeat(Math.round(average)) + '‚òÜ'.repeat(5 - Math.round(average));
                    averageRatingContainer.innerHTML = `
                        <p class="text-3xl font-bold text-amber-500">${average.toFixed(1)} <span class="text-xl">${stars}</span></p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Basado en ${count} opiniones</p>
                    `;
                }

                function renderComments(comments) {
                    commentsList.innerHTML = '';
                    if (comments.length === 0) {
                        commentsList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">S√© el primero en dejar un comentario.</p>';
                        return;
                    }
                    comments.forEach(comment => {
                        const div = document.createElement('div');
                        div.className = 'p-3 bg-gray-100 dark:bg-slate-700 rounded-lg';
                        const stars = '‚òÖ'.repeat(comment.rating || 0) + '‚òÜ'.repeat(5 - (comment.rating || 0));
                        const date = comment.createdAt ? new Date(comment.createdAt.seconds * 1000).toLocaleDateString() : '';
                        div.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span class="text-amber-500">${stars}</span>
                                <span class="text-xs text-gray-400">${date}</span>
                            </div>
                            <p class="mt-1 text-sm text-gray-800 dark:text-gray-200">${comment.text || ''}</p>
                        `;
                        commentsList.appendChild(div);
                    });
                }

                ratingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const selectedRating = ratingForm.querySelector('input[name="rating"]:checked');
                    const commentText = commentInput.value.trim();
                    if (!selectedRating && commentText === '') {
                        alert('Por favor, selecciona una valoraci√≥n o escribe un comentario.');
                        return;
                    }
                    if (!currentPlaceIdForRating) return;
                    const commentsRef = getCommentsCollectionRef(currentPlaceIdForRating);
                    if(!commentsRef) return;
                    try {
                        await addDoc(commentsRef, {
                            rating: selectedRating ? parseInt(selectedRating.value) : null,
                            text: commentText,
                            userId: userId,
                            createdAt: serverTimestamp()
                        });
                        ratingForm.reset();
                    } catch (error) {
                        console.error("Error al guardar la valoraci√≥n:", error);
                        alert('Hubo un error al guardar tu opini√≥n.');
                    }
                });

                chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const userMessage = chatInput.value.trim();
                    if (userMessage === '') return;
                    addMessage({ text: userMessage }, 'user');
                    chatInput.value = '';
                    processUserMessage(userMessage);
                });

                function addMessage(message, sender) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                    const messageContent = document.createElement('div');
                    messageContent.className = `${sender === 'user' ? 'user-message' : 'ai-message'} w-fit max-w-xs md:max-w-md lg:max-w-2xl p-3 rounded-2xl shadow`;
                    if (message.isHtml) {
                        messageContent.innerHTML = message.text;
                    } else {
                        messageContent.textContent = message.text;
                    }
                    if (sender === 'ai' && message.isSponsored) {
                        messageContent.classList.add('sponsored-message');
                    }
                    messageDiv.appendChild(messageContent);
                    chatWindow.appendChild(messageDiv);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }

                async function processUserMessage(userMessage) {
                    const typingIndicator = showTypingIndicator();
                    chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
                    const systemPrompt = generateSystemPrompt();
                    const aiResponseData = await getAIResponse(chatHistory, systemPrompt);
                    chatWindow.removeChild(typingIndicator);

                    const weatherMatch = aiResponseData.text.match(/\[CLIMA:(.*?)(?::(.*?)?)?\]/);

                    if (weatherMatch) {
                        const location = weatherMatch[1].trim();
                        const weatherIndicator = showTypingIndicator();
                        const weatherInfo = await getWeatherData(location);
                        const finalText = await formatWeatherResponse(weatherInfo);
                        
                        chatWindow.removeChild(weatherIndicator);
                        addMessage({ text: finalText }, 'ai');
                        chatHistory.push({ role: "model", parts: [{ text: finalText }] });
                    } else {
                        addMessage({
                            text: aiResponseData.text,
                            isHtml: aiResponseData.isHtml,
                            isSponsored: aiResponseData.isSponsored
                        }, 'ai');
                        chatHistory.push({ role: "model", parts: [{ text: aiResponseData.text }] });
                    }
                }

                async function getAIResponse(history, systemInstructions) {
                    try {
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                        const payload = {
                            contents: history,
                            systemInstruction: { parts: [{ text: systemInstructions }] }
                        };
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorBody = await response.json();
                            console.error("Error de la API:", errorBody);
                            throw new Error(`API call failed with status: ${response.status}`);
                        }
                        const result = await response.json();
                        const text = result.candidates[0].content.parts[0].text;
                        return processAIResponseText(text);
                    } catch (error) {
                        console.error("Error calling AI API:", error);
                        return { text: "Lo siento, tuve un problema para conectarme. Por favor, intenta de nuevo m√°s tarde." };
                    }
                }

                function processAIResponseText(text) {
                    let isHtml = false;
                    let isSponsored = false;
                    const linkRegex = /\[\[(.*?)\]\]/g;
                    let processedText = text.replace(linkRegex, (match, placeName) => {
                        const foundPlace = findPlaceByName(placeName.trim());
                        if (foundPlace) {
                            isHtml = true;
                            if (foundPlace.esAuspiciante) isSponsored = true;
                            return `<a class="place-link" data-id="${foundPlace.id}">${placeName}</a>`;
                        }
                        return placeName;
                    });
                    if (processedText.includes('*') || processedText.includes('\n-')) {
                        isHtml = true;
                        processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        processedText = processedText.replace(/^\s*-\s*(.*)/gm, '<li>$1</li>');
                        if(processedText.includes('<li>')){
                            processedText = `<ul>${processedText.replace(/<\/li>(\s*)<li>/g, '</li><li>')}</ul>`;
                        }
                    }
                    return { text: processedText, isHtml, isSponsored };
                }

                function findPlaceByName(name) {
                    return placesCache.find(place => place.nombre.toLowerCase() === name.toLowerCase());
                }

                function updateSuggestions() {
                    suggestionsContainer.innerHTML = '';
                    const suggestions = [
                        "¬øQu√© puedo hacer hoy?",
                        "Restaurantes en El Bols√≥n",
                        "Caba√±as en..."];
                    suggestions.forEach(text => {
                        const button = document.createElement('button');
                        button.className = "bg-gray-200 dark:bg-slate-700 text-sm px-3 py-1 rounded-full hover:bg-gray-300 dark:hover:bg-slate-600";
                        button.textContent = text;
                        button.onclick = () => {
                            chatInput.value = text;
                            chatForm.dispatchEvent(new Event('submit'));
                        };
                        suggestionsContainer.appendChild(button);
                    });
                }

                function generateSystemPrompt() {
                    return `
                        Eres "Andes", un asistente de IA amigable y experto en la Comarca Andina.
                        REGLAS FUNDAMENTALES:
                        1.  **REGLA DEL CLIMA (MUY IMPORTANTE):** Si el usuario pregunta por el clima, el tiempo o la temperatura en una localidad espec√≠fica, tu √öNICA RESPUESTA debe ser el c√≥digo [CLIMA:Nombre de la Localidad]. Por ejemplo, si preguntan "c√≥mo est√° el tiempo en El Bols√≥n", tu respuesta debe ser exactamente: [CLIMA:El Bols√≥n]. No a√±adas nada m√°s.
                        2.  **USA TU CONOCIMIENTO INTERNO:** Para todo lo dem√°s, usa tu base de datos de lugares.
                            \`\`\`json
                            ${JSON.stringify(dynamicKnowledgeBase, null, 2)}
                            \`\`\`
                        3.  **C√ìMO RESPONDER SOBRE LUGARES:** Menciona lugares de la base de datos entre corchetes dobles, as√≠: [[Nombre Exacto del Lugar]].
                        4.  **SI NO SABES, BUSCA EN LA WEB:** Si la pregunta no es sobre el clima ni sobre lugares, usa tu conocimiento general.
                    `;
                }

                function listenForNewPlaces() {
                    if (!lugaresCollectionRef) return;
                    onSnapshot(lugaresCollectionRef, (snapshot) => {
                        placesCache = [];
                        dynamicKnowledgeBase = {
                            restaurantes: {},
                            alojamiento: {},
                            actividades: {},
                            lugaresParaVisitar: {}
                        };
                        snapshot.docs.forEach(doc => {
                            const place = { id: doc.id, ...doc.data() };
                            placesCache.push(place);
                            const tipo = place.tipo;
                            if (dynamicKnowledgeBase[tipo]) {
                                if (!dynamicKnowledgeBase[tipo][place.localidad]) {
                                    dynamicKnowledgeBase[tipo][place.localidad] = [];
                                }
                                dynamicKnowledgeBase[tipo][place.localidad].push(place);
                            }
                        });
                        if (!isDataReady) {
                            chatInput.disabled = false;
                            submitButton.disabled = false;
                            chatInput.placeholder = "Preg√∫ntame algo...";
                            isDataReady = true;
                        }
                        updateSuggestions();
                        if(!manageModal.classList.contains('hidden')){
                            renderManagementList();
                        }
                        if (!mapModal.classList.contains('hidden') && isDataReady) {
                            if (mapInitialized) {
                                updateMapMarkers();
                            }
                        }
                    }, (error) => console.error("Error listening for places:", error));
                }

                function listenForTips() {
                    if (!consejosCollectionRef) return;
                    onSnapshot(query(consejosCollectionRef, orderBy('createdAt', 'desc')), (snapshot) => {
                        tipsCache = [];
                        snapshot.docs.forEach(doc => {
                            tipsCache.push({ id: doc.id, ...doc.data() });
                        });
                        if (!rinconModal.classList.contains('hidden')) {
                            renderTipsList();
                        }
                    }, (error) => console.error("Error listening to tips:", error));
                }

                function renderTipsList() {
                    if (!rinconList) return;
                    rinconList.innerHTML = '';
                    if (tipsCache.length === 0) {
                        rinconList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">A√∫n no hay consejos. ¬°S√© el primero en compartir uno!</p>';
                        return;
                    }
                    tipsCache.forEach(tip => {
                        const tipElement = document.createElement('div');
                        tipElement.className = "bg-gray-100 dark:bg-slate-700 p-3 rounded-lg relative";
                        const date = tip.createdAt ? new Date(tip.createdAt.seconds * 1000).toLocaleDateString() : 'hace un momento';
                        let actionsHtml = '';
                        if (isAdmin && tip.id) {
                            actionsHtml = `
                                <button class="delete-tip-btn absolute top-2 right-2 p-1 text-red-500 hover:text-red-700" data-id="${tip.id}" title="Eliminar consejo">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            `;
                        }
                        tipElement.innerHTML = `
                            <p class="text-sm pr-6">${tip.text || 'Consejo vac√≠o.'}</p>
                            <p class="text-xs text-gray-400 text-right mt-1">An√≥nimo - ${date}</p>
                            ${actionsHtml}
                        `;
                        rinconList.appendChild(tipElement);
                    });
                }

                rinconList.addEventListener('click', async (e) => {
                    const deleteBtn = e.target.closest('.delete-tip-btn');
                    if (deleteBtn && isAdmin) {
                        const tipId = deleteBtn.dataset.id;
                        if (confirm("¬øEliminar este consejo? Esta acci√≥n no se puede deshacer.")) {
                            try {
                                await deleteDoc(doc(consejosCollectionRef, tipId));
                            } catch (error) {
                                console.error("Error al eliminar consejo:", error);
                                alert("No se pudo eliminar el consejo.");
                            }
                        }
                    }
                });

                tipForm.addEventListener('submit', async(e) => {
                    e.preventDefault();
                    const tipText = tipInput.value.trim();
                    if (tipText === '' || !consejosCollectionRef) return;
                    const submitBtn = tipForm.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    try {
                        await addDoc(consejosCollectionRef, {
                            text: tipText,
                            userId: userId,
                            createdAt: serverTimestamp()
                        });
                        tipInput.value = '';
                    } catch (error) {
                        console.error("Error al a√±adir consejo:", error);
                    } finally {
                        submitBtn.disabled = false;
                    }
                });

                plannerForm.addEventListener('click', (e) => {
                    const btn = e.target.closest('.planner-option-btn');
                    if (!btn) return;
                    const siblings = btn.parentElement.querySelectorAll('.planner-option-btn');
                    siblings.forEach(sibling => {
                        sibling.classList.remove('bg-emerald-500', 'text-white', 'border-emerald-500');
                        sibling.classList.add('bg-gray-50', 'dark:bg-slate-700', 'border-gray-200', 'dark:border-slate-600');
                    });
                    btn.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
                    btn.classList.remove('bg-gray-50', 'dark:bg-slate-700', 'border-gray-200', 'dark:border-slate-600');
                });

                plannerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const selectedStyleBtn = document.querySelector('#planner-style-group .bg-emerald-500');
                    const style = selectedStyleBtn ? selectedStyleBtn.dataset.value : 'Aventura';
                    const days = document.getElementById('planner-days').value;
                    const selectedEnergyBtn = document.querySelector('#planner-energy-group .bg-emerald-500');
                    const energy = selectedEnergyBtn ? selectedEnergyBtn.dataset.value : 'Medio';
                    plannerModal.classList.add('hidden');
                    const userMessage = `Quiero un plan de viaje para ${days} d√≠as, con un estilo ${style} y nivel de energ√≠a ${energy}.`;
                    addMessage({ text: userMessage }, 'user');
                    const typingIndicator = showTypingIndicator();
                    const plannerHistory = [{
                        role: "user",
                        parts: [{ text: `
                            - Estilo de Viaje: ${style}
                            - Duraci√≥n: ${days} d√≠as
                            - Nivel de Energ√≠a: ${energy}
                        ` }]
                    }];
                    const plannerSystemPrompt = generatePlannerPrompt(style, days, energy);
                    const aiResponseData = await getAIResponse(plannerHistory, plannerSystemPrompt);
                    chatWindow.removeChild(typingIndicator);
                    addMessage({
                        text: aiResponseData.text,
                        isHtml: true, // Planner response is always HTML
                        isPlannerResponse: true
                    }, 'ai');
                });

                function generatePlannerPrompt(style, days, energy) {
                    return `
                        Eres "Andes Planner", un experto en crear itinerarios de viaje para la Comarca Andina del Paralelo 42.
                        Recibir√°s las preferencias del usuario y tu √öNICA tarea es crear un itinerario detallado, d√≠a por d√≠a.
                        PREFERENCIAS DEL USUARIO:
                        - Estilo de Viaje: ${style}
                        - Duraci√≥n: ${days} d√≠as
                        - Nivel de Energ√≠a: ${energy}
                        BASE DE CONOCIMIENTO DISPONIBLE (LUGARES):
                        \`\`\`json
                        ${JSON.stringify(dynamicKnowledgeBase, null, 2)}
                        \`\`\`
                        INSTRUCCIONES PARA CREAR EL ITINERARIO:
                        1.  **Formato Obligatorio:** Usa Markdown. Crea un t√≠tulo para cada d√≠a (ej: "**D√≠a 1: Aventura y Sabores**"). Para cada d√≠a, sugiere 2 o 3 actividades/lugares. Usa listas con guiones.
                        2.  **Selecci√≥n Inteligente:**
                            - **Coherencia:** Elige lugares y actividades que coincidan con el *Estilo de Viaje* y *Nivel de Energ√≠a*. (Ej: si es "Relax" y "Bajo", no sugieras escalar una monta√±a).
                            - **Log√≠stica:** Agrupa actividades que est√©n en la misma localidad o cerca para evitar viajes largos e innecesarios en un mismo d√≠a.
                            - **Variedad:** Intenta incluir una mezcla de actividades, gastronom√≠a y paisajes a lo largo del plan.
                        3.  **REGLA ESPECIAL D√çA 1:** Para el **D√≠a 1** del plan, enf√≥cate en sugerir actividades y lugares para comer. **NO** sugieras un "alojamiento", ya que se asume que el viajero ya lo tiene resuelto para su llegada. La √∫nica excepci√≥n es que encuentres un alojamiento marcado como auspiciante de alta categor√≠a (lo cual se indicar√° en el futuro).
                        4.  **Menciona Lugares Correctamente:** Cuando sugieras un lugar de tu base de conocimiento, menci√≥nalo entre corchetes dobles: [[Nombre Exacto del Lugar]]. Esto es MUY IMPORTANTE.
                        5.  **Descripci√≥n Atractiva:** Para cada sugerencia, escribe una o dos frases cortas y atractivas que expliquen por qu√© es un buen plan.
                        6.  **No Saludes ni Despidas:** No digas "Hola", ni "Aqu√≠ est√° tu plan", ni "espero que te guste". Ve directo al itinerario. Tu respuesta debe empezar directamente con "**D√≠a 1:...**".
                        EJEMPLO DE RESPUESTA (para un plan de 2 d√≠as, Aventura, Alto):
                        **D√≠a 1: Monta√±a y Cerveza Artesanal**
                        - Comienza el d√≠a con el trekking al [[Caj√≥n del Azul]]. Es una caminata exigente pero el paisaje del r√≠o encajonado es una recompensa incre√≠ble.
                        - Por la tarde, rel√°jate y recarga energ√≠as en [[Patagonia Cervecer√≠a]]. Tienen una vista espectacular.
                        **D√≠a 2: Cultura y Sabor Local**
                        - Recorre la famosa [[Feria de Artesanos de El Bols√≥n]] para descubrir productos locales √∫nicos.
                        - Para la cena, te recomiendo probar las pastas caseras en [[Jauja]].
                    `;
                }

                function initMap() {
                    if (mapInitialized) return;
                    map = L.map('map').setView([-41.96, -71.53], 10); 
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                    markersLayer = L.layerGroup().addTo(map);
                    mapInitialized = true;
                }

                mapBtn.addEventListener('click', () => {
                    mapModal.classList.remove('hidden');
                    if (!mapInitialized) {
                        initMap();
                    }
                    setTimeout(() => {
                        map.invalidateSize();
                        if (isDataReady) { 
                            updateMapMarkers();
                        }
                    }, 100); 
                });

                function updateMapMarkers() {
                    if (!map || !markersLayer) return;
                    markersLayer.clearLayers();
                    markersById = {};
                    const placesWithCoords = placesCache.filter(p => p.latitud && p.longitud);
                    placesWithCoords.forEach(place => {
                        try {
                            const lat = parseFloat(place.latitud);
                            const lon = parseFloat(place.longitud);
                            if (isNaN(lat) || isNaN(lon)) {
                                console.warn(`Coordenadas inv√°lidas para ${place.nombre}: Lat ${place.latitud}, Lon ${place.longitud}`);
                                return; 
                            }
                            const marker = L.marker([lat, lon]).addTo(markersLayer);
                            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
                            let shortDescription = place.descripcion || '';
                            if (shortDescription.length > 100) {
                                shortDescription = shortDescription.substring(0, 100) + '...';
                            }
                            const popupContent = `
                                <div style="font-family: 'Inter', sans-serif; max-width: 200px;">
                                    <strong style="font-size: 1.1em;">${place.nombre}</strong>
                                    <p style="font-size: 0.9em; margin: 5px 0;">${shortDescription}</p>
                                    <a href="${googleMapsUrl}" target="_blank" style="display: block; width: 100%; padding: 8px; background-color: #10b981; color: white; text-align: center; border-radius: 5px; text-decoration: none; font-weight: bold;">
                                        C√≥mo llegar
                                    </a>
                                </div>
                            `;
                            marker.bindPopup(popupContent);
                            markersById[place.id] = marker;
                        } catch (e) {
                            console.error(`Error procesando el lugar ${place.nombre} para el mapa:`, e);
                        }
                    });
                }

                document.body.addEventListener('click', e => {
                    const placeLink = e.target.closest('.place-link');
                    if (placeLink) {
                        const placeId = placeLink.dataset.id;
                        const place = placesCache.find(p => p.id === placeId);
                        if (place) {
                            showPlaceOnMap(place);
                        }
                    }
                });

                function showPlaceOnMap(place) {
                    if (!place.latitud || !place.longitud) {
                        console.warn("Intento de mostrar en mapa un lugar sin coordenadas:", place.nombre);
                        return;
                    }
                    const lat = parseFloat(place.latitud);
                    const lon = parseFloat(place.longitud);
                    if (isNaN(lat) || isNaN(lon)) {
                        addMessage({ text: `Lo siento, las coordenadas para "${place.nombre}" no son v√°lidas y no se puede mostrar en el mapa.` }, 'ai');
                        return;
                    }
                    mapModal.classList.remove('hidden');
                    if (!mapInitialized) {
                        initMap();
                    }
                    setTimeout(() => {
                        map.invalidateSize(); 
                        map.setView([lat, lon], 16); 
                        if (markersById[place.id]) {
                            markersById[place.id].openPopup();
                        }
                    }, 200);
                }

                // --- RADIO ---
                let isPlaying = false;
                function setRadioState(state) {
                    if (state === 'playing') {
                        radioIconOverlay.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v4a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`;
                        radioLogo.classList.remove('opacity-70');
                        radioStatusText.textContent = 'Reproduciendo...';
                        isPlaying = true;
                    } else { // paused or stopped
                        radioIconOverlay.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 11-16 0 8 8 0 0116 0zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
                        radioLogo.classList.add('opacity-70');
                        radioStatusText.textContent = state === 'paused' ? 'En pausa' : 'Click para escuchar';
                        isPlaying = false;
                    }
                }

                radioBtn.addEventListener('click', () => {
                    if (!isPlaying) {
                        radioPlayer.src = streamUrl;
                        radioPlayer.play().catch(e => {
                            console.error("Error al reproducir radio:", e);
                            setRadioState('stopped');
                        });
                    } else {
                        radioPlayer.pause();
                        radioPlayer.src = ""; // Detener la carga
                    }
                });

                radioPlayer.addEventListener('play', () => setRadioState('playing'));
                radioPlayer.addEventListener('pause', () => setRadioState('paused'));
                radioPlayer.addEventListener('error', () => {
                    console.error("Error en el stream de radio");
                    setRadioState('stopped');
                });
                
                setRadioState('paused');

                // --- RECONOCIMIENTO DE VOZ ---
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    mainRecognition = new SpeechRecognition();
                    mainRecognition.continuous = false;
                    mainRecognition.lang = 'es-AR';
                    mainRecognition.interimResults = false;
                    mainRecognition.maxAlternatives = 1;
                    mainRecognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        if (activeSpeechInput) {
                            activeSpeechInput.value += transcript;
                        } else {
                            chatInput.value = transcript;
                            chatForm.dispatchEvent(new Event('submit'));
                        }
                    };
                    mainRecognition.onspeechend = () => {
                        mainRecognition.stop();
                    };
                    mainRecognition.onnomatch = () => {
                        console.log("No se pudo reconocer el audio.");
                    };
                    mainRecognition.onerror = (event) => {
                        console.error('Error en el reconocimiento de voz:', event.error);
                    };
                    mainRecognition.onstart = () => {
                        if (activeSpeechInput) {
                            const micButton = activeSpeechInput.closest('.relative').querySelector('.mic-input-btn');
                            if (micButton) micButton.classList.add('mic-listening');
                        } else {
                            isMainMicListening = true;
                            micBtn.classList.add('mic-listening');
                        }
                    };
                    mainRecognition.onend = () => {
                        document.querySelectorAll('.mic-input-btn, #mic-btn').forEach(btn => btn.classList.remove('mic-listening'));
                        isMainMicListening = false;
                        activeSpeechInput = null;
                    };
                    micBtn.addEventListener('click', () => {
                        if (isMainMicListening) {
                            mainRecognition.stop();
                        } else {
                            activeSpeechInput = null;
                            mainRecognition.start();
                        }
                    });
                    document.body.addEventListener('click', function(e) {
                        const micInputBtn = e.target.closest('.mic-input-btn');
                        if (micInputBtn) {
                            activeSpeechInput = micInputBtn.closest('.relative').querySelector('input, textarea');
                            mainRecognition.start();
                        }
                    });
                } else {
                    console.warn("La API de reconocimiento de voz no es compatible con este navegador.");
                    micBtn.style.display = 'none';
                    document.querySelectorAll('.mic-input-btn').forEach(b => b.style.display = 'none');
                }

                // --- GESTI√ìN DE CONTENIDO (BACKUP, etc.) ---
                const downloadBackupBtn = document.getElementById('download-backup-btn');
                const restoreBackupBtn = document.getElementById('restore-backup-btn');
                const backupFileInput = document.getElementById('backup-file-input');
                const confirmRestoreModal = document.getElementById('confirm-restore-modal');
                const cancelRestoreBtn = document.getElementById('cancel-restore-btn');
                const confirmRestoreBtn = document.getElementById('confirm-restore-btn');

                downloadBackupBtn.addEventListener('click', () => {
                    if (placesCache.length === 0) {
                        alert("No hay datos para respaldar.");
                        return;
                    }
                    const headers = [
                        'id', 'tipo', 'subtipo', 'localidad', 'nombre', 'direccion', 'telefono', 
                        'latitud', 'longitud', 'imagenURL', 'imagen360URL', 'descripcion', 
                        'datosClave', 'esAuspiciante'
                    ];
                    const escapeCSV = (value) => {
                        if (value === null || value === undefined) return '';
                        let str = String(value);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            str = `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    };
                    let csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n';
                    placesCache.forEach(place => {
                        const row = headers.map(header => escapeCSV(place[header]));
                        csvContent += row.join(',') + '\n';
                    });
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `backup_andes_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });

                restoreBackupBtn.addEventListener('click', () => {
                    backupFileInput.click();
                });

                backupFileInput.addEventListener('change', (event) => {
                    if (event.target.files.length > 0) {
                        confirmRestoreModal.classList.remove('hidden');
                    }
                });

                cancelRestoreBtn.addEventListener('click', () => {
                    confirmRestoreModal.classList.add('hidden');
                    backupFileInput.value = '';
                });

                confirmRestoreBtn.addEventListener('click', async () => {
                    confirmRestoreModal.classList.add('hidden');
                    const file = backupFileInput.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const text = e.target.result;
                        const deleteBatch = writeBatch(db);
                        placesCache.forEach(place => {
                            deleteBatch.delete(doc(lugaresCollectionRef, place.id));
                        });
                        try {
                            await deleteBatch.commit();
                            const addBatch = writeBatch(db);
                            const rows = text.split('\n');
                            const headers = rows[0].split(',').map(h => h.trim());
                            for (let i = 1; i < rows.length; i++) {
                                const row = rows[i];
                                if (row.trim() === '') continue;
                                const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(val => val.replace(/^"|"$/g, '').replace(/""/g, '"'));
                                const newPlace = {};
                                headers.forEach((header, index) => {
                                    if (header !== 'id') {
                                        if (header === 'esAuspiciante') {
                                            newPlace[header] = values[index] === 'true';
                                        } else {
                                            newPlace[header] = values[index] || '';
                                        }
                                    }
                                });
                                newPlace.createdAt = serverTimestamp();
                                addBatch.set(doc(lugaresCollectionRef), newPlace);
                            }
                            await addBatch.commit();
                            alert('Restauraci√≥n completada con √©xito.');
                        } catch (error) {
                            console.error("Error durante la restauraci√≥n: ", error);
                            alert('Ocurri√≥ un error durante la restauraci√≥n.');
                        } finally {
                            backupFileInput.value = '';
                        }
                    };
                    reader.readAsText(file);
                });

                // --- RENDER MANAGEMENT LIST ---
                function renderManagementList() {
                    if (!manageList) return;
                    manageList.innerHTML = '';
                    if (placesCache.length === 0) {
                        manageList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No hay lugares para gestionar.</p>';
                        return;
                    }
                    const groupedByLocalidad = placesCache.reduce((acc, place) => {
                        const localidad = place.localidad || 'Sin Localidad';
                        if (!acc[localidad]) {
                            acc[localidad] = [];
                        }
                        acc[localidad].push(place);
                        return acc;
                    }, {});
                    Object.keys(groupedByLocalidad).sort().forEach(localidad => {
                        const placesInLocalidad = groupedByLocalidad[localidad];
                        const groupedBySubtipo = placesInLocalidad.reduce((acc, place) => {
                            const subtipo = place.subtipo || place.tipo || 'Sin Rubro';
                            if (!acc[subtipo]) {
                                acc[subtipo] = [];
                            }
                            acc[subtipo].push(place);
                            return acc;
                        }, {});
                        let localidadHtml = `
                            <details class="bg-gray-100 dark:bg-slate-800 rounded-lg mb-2" open>
                                <summary class="flex justify-between items-center p-3 cursor-pointer font-bold text-lg">
                                    <div>
                                        ${localidad} <span class="text-sm font-normal text-gray-500 dark:text-gray-400">(${placesInLocalidad.length} lugares)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button class="edit-btn p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-600" data-edit-type="localidad" data-localidad="${localidad}" title="Renombrar Localidad">
                                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a1 1 0 00.46-.293l10.5-10.5a1.5 1.5 0 00-2.121-2.121L2.988 14.304a1 1 0 00-.293.46zM13.262 2.621l1.118 1.118-9.9 9.9-1.118-1.118a.5.5 0 010-.707l.707-.707a.5.5 0 01.707 0l9.394-9.394z" /></svg>
                                        </button>
                                        <button class="delete-btn p-1.5 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50" data-delete-type="localidad" data-localidad="${localidad}" title="Eliminar Localidad y todo su contenido">
                                            <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
                                        </button>
                                    </div>
                                </summary>
                                <div class="pl-4 pr-2 pb-2">
                        `;
                        Object.keys(groupedBySubtipo).sort().forEach(subtipo => {
                            const placesInSubtipo = groupedBySubtipo[subtipo];
                            localidadHtml += `
                                <details class="bg-white dark:bg-slate-700 rounded-lg mb-2" open>
                                    <summary class="flex justify-between items-center p-2.5 cursor-pointer font-semibold">
                                        <div>
                                            ${subtipo} <span class="text-sm font-normal text-gray-500 dark:text-gray-400">(${placesInSubtipo.length})</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button class="edit-btn p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-600" data-edit-type="subtipo" data-localidad="${localidad}" data-subtipo="${subtipo}" title="Renombrar Rubro">
                                                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a1 1 0 00.46-.293l10.5-10.5a1.5 1.5 0 00-2.121-2.121L2.988 14.304a1 1 0 00-.293.46zM13.262 2.621l1.118 1.118-9.9 9.9-1.118-1.118a.5.5 0 010-.707l.707-.707a.5.5 0 01.707 0l9.394-9.394z" /></svg>
                                            </button>
                                            <button class="delete-btn p-1.5 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50" data-delete-type="subtipo" data-localidad="${localidad}" data-subtipo="${subtipo}" title="Eliminar Rubro y su contenido">
                                                <svg class="h-4 w-4 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
                                            </button>
                                        </div>
                                    </summary>
                                    <div class="p-2 space-y-2">
                            `;
                            placesInSubtipo.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(place => {
                                localidadHtml += `
                                        <div class="flex justify-between items-center p-2 rounded-md bg-gray-50 dark:bg-slate-600/50">
                                            <span class="truncate pr-2">${place.esAuspiciante ? '‚≠ê ' : ''}${place.nombre}</span>
                                            <div class="flex-shrink-0 flex items-center gap-2">
                                                <button class="edit-btn p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-500" data-edit-type="place" data-id="${place.id}" title="Editar Lugar">
                                                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a1 1 0 00.46-.293l10.5-10.5a1.5 1.5 0 00-2.121-2.121L2.988 14.304a1 1 0 00-.293.46zM13.262 2.621l1.118 1.118-9.9 9.9-1.118-1.118a.5.5 0 010-.707l.707-.707a.5.5 0 01.707 0l9.394-9.394z" /></svg>
                                                </button>
                                                <button class="delete-btn p-1.5 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50" data-delete-type="place" data-id="${place.id}" data-name="${place.nombre}" title="Eliminar Lugar">
                                                    <svg class="h-4 w-4 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
                                                </button>
                                            </div>
                                        </div>
                                    `;
                            });
                            localidadHtml += `</div></details>`;
                        });
                        localidadHtml += `</div></details>`;
                        manageList.innerHTML += localidadHtml;
                    });
                }

                manageList.addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-btn');
                    const deleteBtn = e.target.closest('.delete-btn');
                    if (editBtn) {
                        const type = editBtn.dataset.editType;
                        if (type === 'place') {
                            const placeId = editBtn.dataset.id;
                            const placeToEdit = placesCache.find(p => p.id === placeId);
                            if (placeToEdit) {
                                editingPlaceId = placeId;
                                document.getElementById('lugar-nombre').value = placeToEdit.nombre || '';
                                document.getElementById('lugar-localidad').value = placeToEdit.localidad || 'El Bols√≥n';
                                document.getElementById('lugar-direccion').value = placeToEdit.direccion || '';
                                document.getElementById('lugar-telefono').value = placeToEdit.telefono || '';
                                document.getElementById('lugar-latitud').value = placeToEdit.latitud || '';
                                document.getElementById('lugar-longitud').value = placeToEdit.longitud || '';
                                document.getElementById('lugar-descripcion').value = placeToEdit.descripcion || '';
                                document.getElementById('lugar-datos-clave').value = placeToEdit.datosClave || '';
                                document.getElementById('lugar-imagen').value = placeToEdit.imagenURL || '';
                                document.getElementById('lugar-imagen360').value = placeToEdit.imagen360URL || '';
                                document.getElementById('lugar-sponsor').checked = placeToEdit.esAuspiciante || false;
                                const tipoSelect = document.getElementById('lugar-tipo');
                                for(let i=0; i < tipoSelect.options.length; i++) {
                                    const option = tipoSelect.options[i];
                                    if(option.value === placeToEdit.tipo && (option.dataset.subtype || '') === placeToEdit.subtipo) {
                                        tipoSelect.selectedIndex = i;
                                        break;
                                    }
                                }
                                document.getElementById('contribution-title').textContent = 'Editar Lugar';
                                document.getElementById('contribution-submit-btn').textContent = 'Actualizar Lugar';
                                manageModal.classList.add('hidden');
                                contributionModal.classList.remove('hidden');
                            }
                        } else if (type === 'localidad') {
                            const oldLocalidad = editBtn.dataset.localidad;
                            const newLocalidad = prompt(`Renombrar localidad "${oldLocalidad}":`, oldLocalidad);
                            if (newLocalidad && newLocalidad.trim() !== '' && newLocalidad !== oldLocalidad) {
                                updateBatch('localidad', oldLocalidad, newLocalidad, null);
                            }
                        } else if (type === 'subtipo') {
                            const localidad = editBtn.dataset.localidad;
                            const oldSubtipo = editBtn.dataset.subtipo;
                            const newSubtipo = prompt(`Renombrar rubro "${oldSubtipo}" en ${localidad}:`, oldSubtipo);
                            if (newSubtipo && newSubtipo.trim() !== '' && newSubtipo !== oldSubtipo) {
                                updateBatch('subtipo', oldSubtipo, newSubtipo, localidad);
                            }
                        }
                    }
                    if (deleteBtn) {
                        const type = deleteBtn.dataset.deleteType;
                        if(type === 'place'){
                            const placeId = deleteBtn.dataset.id;
                            const placeName = deleteBtn.dataset.name;
                            deleteAction = { type: 'place', id: placeId };
                            deleteConfirmationText.textContent = `¬øEst√°s seguro de que quieres eliminar "${placeName}"? Esta acci√≥n no se puede deshacer.`;
                            confirmDeleteModal.classList.remove('hidden');
                        } else if(type === 'localidad'){
                            const localidad = deleteBtn.dataset.localidad;
                            const placesToDelete = placesCache.filter(p => p.localidad === localidad);
                            deleteAction = { type: 'localidad', localidad: localidad, places: placesToDelete };
                            rubroDeleteConfirmationText.innerHTML = `Est√°s a punto de eliminar la localidad <strong class="font-bold">"${localidad}"</strong> y sus <strong class="font-bold">${placesToDelete.length}</strong> lugares asociados. <br><br>¬øEst√°s seguro?`;
                            confirmRubroDeleteModal.classList.remove('hidden');
                        } else if(type === 'subtipo'){
                            const localidad = deleteBtn.dataset.localidad;
                            const subtipo = deleteBtn.dataset.subtipo;
                            const placesToDelete = placesCache.filter(p => p.localidad === localidad && (p.subtipo || p.tipo || 'Sin Rubro') === subtipo);
                            deleteAction = { type: 'subtipo', localidad: localidad, subtipo: subtipo, places: placesToDelete };
                            rubroDeleteConfirmationText.innerHTML = `Est√°s a punto de eliminar el rubro <strong class="font-bold">"${subtipo}"</strong> en ${localidad} y sus <strong class="font-bold">${placesToDelete.length}</strong> lugares asociados. <br><br>¬øEst√°s seguro?`;
                            confirmRubroDeleteModal.classList.remove('hidden');
                        }
                    }
                });

                cancelDeleteBtn.addEventListener('click', () => {
                    confirmDeleteModal.classList.add('hidden');
                    deleteAction = null;
                });

                confirmDeleteBtn.addEventListener('click', async () => {
                    if(deleteAction && deleteAction.type === 'place'){
                        try {
                            await deleteDoc(doc(lugaresCollectionRef, deleteAction.id));
                        } catch (error) {
                            console.error("Error al eliminar el lugar:", error);
                        }
                    }
                    confirmDeleteModal.classList.add('hidden');
                    deleteAction = null;
                });

                cancelRubroDeleteBtn.addEventListener('click', () => {
                    confirmRubroDeleteModal.classList.add('hidden');
                    deleteAction = null;
                });

                confirmRubroDeleteBtn.addEventListener('click', async () => {
                    if(deleteAction && (deleteAction.type === 'localidad' || deleteAction.type === 'subtipo')){
                        const batch = writeBatch(db);
                        deleteAction.places.forEach(place => {
                            batch.delete(doc(lugaresCollectionRef, place.id));
                        });
                        try {
                            await batch.commit();
                        } catch (error) {
                            console.error(`Error al eliminar en lote:`, error);
                        }
                    }
                    confirmRubroDeleteModal.classList.add('hidden');
                    deleteAction = null;
                });

                async function updateBatch(fieldToUpdate, oldValue, newValue, filterLocalidad) {
                    const batch = writeBatch(db);
                    let placesToUpdate;
                    if (fieldToUpdate === 'localidad') {
                        placesToUpdate = placesCache.filter(p => p.localidad === oldValue);
                    } else if (fieldToUpdate === 'subtipo') {
                        placesToUpdate = placesCache.filter(p => p.localidad === filterLocalidad && (p.subtipo === oldValue || p.tipo === oldValue));
                    }
                    if (placesToUpdate && placesToUpdate.length > 0) {
                        placesToUpdate.forEach(place => {
                            const docRef = doc(lugaresCollectionRef, place.id);
                            const updateData = {};
                            if (fieldToUpdate === 'localidad') {
                                updateData.localidad = newValue;
                            } else if (fieldToUpdate === 'subtipo') {
                                updateData.subtipo = newValue;
                            }
                            batch.update(docRef, updateData);
                        });
                        try {
                            await batch.commit();
                        } catch (error) {
                            console.error("Error en la actualizaci√≥n por lotes:", error);
                        }
                    }
                }
            });
        </script>
    </div>
</body>
</html>

