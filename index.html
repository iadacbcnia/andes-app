<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andes - Tu Gu√≠a en la Comarca</title>
    <script src="https://cdn.tailwindcss.com?v=2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=2" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=2" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js?v=2"></script>
    <style>
        :root {
            --emerald-500: #10b981;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --slate-700: #334155;
            --gray-100: #f3f4f6;
            --white: #ffffff;
        }
        .dark {
            --bg-color: var(--slate-800);
            --text-color: var(--gray-100);
            --card-bg: var(--slate-700);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color, var(--gray-100));
            color: var(--text-color, var(--slate-900));
            margin: 0;
            padding: 0;
            overflow: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .user-message { background-color: var(--emerald-500); color: white; border-radius: 20px 20px 5px 20px; }
        .ai-message {
            background-color: var(--slate-700);
            color: #ffffff;
            border-radius: 20px 20px 20px 5px;
            padding: 1rem;
            line-height: 1.5;
        }
        .sponsored-message {
            background-color: var(--card-bg, var(--white));
            border: 2px solid #facc15;
            box-shadow: 0 4px 14px 0 rgba(250, 204, 21, 0.3);
        }
        .place-link { color: var(--emerald-500); font-weight: 500; cursor: pointer; }
        .place-link:hover { text-decoration: underline; }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af;
            border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 2.5rem; color: #d1d5db; cursor: pointer; transition: color 0.2s; }
        .star-rating input:checked ~ label, .star-rating:not(:checked) > label:hover, .star-rating:not(:checked) > label:hover ~ label { color: #f59e0b; }
        #map { height: 100%; width: 100%; }
        .ar-top-bar { position: absolute; top: 0; left: 0; right: 0; padding: 0.5rem; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .ar-pill { background-color: rgba(0, 0, 0, 0.6); color: white; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; }
        #ar-status { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; color: white; background-color: rgba(0,0,0,0.7); padding: 1rem; border-radius: 0.5rem; text-align: center; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-listening {
            color: #ef4444;
            animation: pulse-red 1.5s infinite;
            border-radius: 50%;
        }
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--bg-color, var(--gray-100));
            border-top: 1px solid var(--slate-700);
            padding: 0.5rem 0;
            z-index: 50;
        }
        .bottom-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-color, var(--slate-900));
            font-size: 0.75rem;
            padding: 0.25rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .bottom-nav-btn.active, .bottom-nav-btn:hover {
            color: var(--emerald-500);
        }
        .bottom-nav-btn svg {
            width: 1.5rem;
            height: 1.5rem;
            margin-bottom: 0.25rem;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        .input-container {
            padding: 1rem;
            background-color: var(--bg-color, var(--gray-100));
            border-top: 1px solid var(--slate-700);
        }
        .radio-player-container {
            padding: 0.5rem 1rem;
            background-color: var(--card-bg, var(--white));
            border-top: 1px solid var(--slate-700);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .radio-logo-container {
            position: relative;
            width: 2.5rem;
            height: 2.5rem;
            background-color: black;
            border-radius: 50%;
        }
        .radio-logo {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            opacity: 0.7;
        }
        .radio-icon-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .image-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 8px;
            border: 2px solid #10b981;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css?v=2">
</head>
<body class="dark bg-gray-100 dark:bg-slate-900 text-gray-900 dark:text-gray-100">
    <!-- Pantalla de Bienvenida -->
    <div id="welcome-screen" class="flex flex-col items-center justify-center p-4 bg-gradient-to-b from-emerald-500 to-emerald-700 text-white w-full min-h-[100dvh] fixed inset-0 z-50 transition-opacity duration-500 box-border">
        <div class="max-w-sm w-full flex flex-col items-center justify-center" style="max-height: calc(100dvh - env(safe-area-inset-top, 10px) - env(safe-area-inset-bottom, 80px)); overflow-y: auto; padding-bottom: env(safe-area-inset-bottom, 80px); padding-top: env(safe-area-inset-top, 10px);">
            <img src="https://i.postimg.cc/4d45rq7k/Chat-GPT-Image-28-sept-2025-19-09-13.png" alt="Andes, el Pudu Pudu gu√≠a" class="w-full rounded-xl shadow-lg mb-3">
            <h1 class="text-xl md:text-2xl font-bold mb-3 text-center">¬°Bienvenido, soy Andes!</h1>
            <p class="text-sm mb-4 text-center">Tu gu√≠a personal en la Comarca Andina.</p>
            <div class="space-y-2 mb-6">
                <div class="flex items-center justify-center gap-2">
                    <span class="bg-white text-emerald-600 px-2 py-0.5 rounded-full text-xs font-bold">‚ú®</span>
                    <span>Preg√∫ntame por lugares o planes</span>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="bg-white text-emerald-600 px-2 py-0.5 rounded-full text-xs font-bold">üó∫Ô∏è</span>
                    <span>Explora el mapa interactivo</span>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="bg-white text-emerald-600 px-2 py-0.5 rounded-full text-xs font-bold">üìª</span>
                    <span>Escucha FM Para√≠so 42 en vivo</span>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <span class="bg-white text-emerald-600 px-2 py-0.5 rounded-full text-xs font-bold">üìñ</span>
                    <span>Crea tu Storybook de viaje</span>
                </div>
            </div>
            <button id="start-chat-btn" class="bg-white text-emerald-600 font-bold py-2.5 px-6 rounded-full text-base shadow-lg hover:bg-gray-100 transition-transform transform hover:scale-105 whitespace-nowrap">
                Comenzar
            </button>
        </div>
    </div>
    <!-- App principal (oculta al inicio) -->
    <div id="main-app" class="hidden flex flex-col h-dvh">
        <div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4">
            <div class="w-full flex justify-start">
                <div class="ai-message w-fit max-w-xs md:max-w-md lg:max-w-2xl p-3 rounded-2xl shadow">
                    ¬°Hola! Soy Andes, tu gu√≠a personal en la Comarca Andina. Estoy aqu√≠ para ayudarte a descubrir los mejores lugares, planificar tu d√≠a o simplemente contarte sobre el clima. ¬øEn qu√© puedo ayudarte hoy?
                </div>
            </div>
        </div>
        <div class="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
            <div id="suggestions" class="flex flex-wrap gap-2 mb-2"></div>
            <form id="chat-form" class="flex items-center gap-2">
                <div class="relative w-full">
                    <input type="text" id="chat-input" placeholder="Conectando..." class="w-full p-3 pr-20 rounded-lg border border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 focus:ring-2 focus:ring-emerald-500 focus:outline-none" disabled>
                    <button type="button" id="mic-btn" class="absolute inset-y-0 right-10 flex items-center p-3 text-gray-500 hover:text-emerald-500">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                    </button>
                </div>
                <button type="submit" class="bg-emerald-500 text-white p-3 rounded-lg hover:bg-emerald-600 disabled:bg-emerald-300" disabled>
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.544l4.25-1.214a.75.75 0 01.44 1.392l-4.25 1.214a.75.75 0 00-.95.544l-1.414 4.949a.75.75 0 00.826.95l14.083-4.024a.75.75 0 000-1.425L3.105 2.289z" /></svg>
                </button>
            </form>
        </div>
        <div class="bg-gray-100 dark:bg-slate-700 p-2 border-t border-gray-200 dark:border-slate-600">
            <button id="radio-btn" class="w-full flex items-center justify-center">
                <div id="radio-logo-container" class="relative flex-shrink-0 w-8 h-8">
                    <img id="radio-logo" src="https://i.postimg.cc/8cLnSv8c/Logo-Fm-Paraiso-42.png" alt="Logo FM Para√≠so 42" class="w-full h-full rounded-full object-cover transition-opacity duration-300 opacity-70">
                    <div id="radio-icon-overlay" class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white"></div>
                </div>
                <div class="ml-2 overflow-hidden">
                    <p class="font-semibold text-sm truncate">FM Para√≠so 42</p>
                    <p id="radio-status-text" class="text-xs text-gray-500 dark:text-gray-400">Click para escuchar</p>
                </div>
            </button>
        </div>
        <div class="flex justify-around items-center p-2 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-600">
            <button id="planner-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                <span>Plan</span>
            </button>
            <button id="rincon-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zM6 8a2 2 0 11-4 0 2 2 0 014 0zM1.49 15.326a.78.78 0 01-.358-.442 3 3 0 014.308-3.516 6.484 6.484 0 00-1.905 3.959c-.023.222-.014.442.028.658a.78.78 0 01-.357.443 3.377 3.377 0 01-2.924.001zM18 8a2 2 0 11-4 0 2 2 0 014 0zm-1.808 1.054a6.458 6.458 0 00-1.905-3.959 3 3 0 014.308 3.516.78.78 0 01-.357-.443c.042-.216.051-.436.028-.658a.78.78 0 01-.358.442 3.377 3.377 0 01-2.924-.001zM10 18a3 3 0 100-6 3 3 0 000 6z" /></svg>
                <span>Rinc√≥n</span>
            </button>
            <button id="map-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.1.4-.223.654-.369.26-.15.552-.333.865-.55C12.864 17.113 14 15.823 14 14c0-2.21-1.79-4-4-4S6 11.79 6 14c0 1.823 1.136 3.113 1.966 3.868.313.217.605.4.865.55.254.146.468.269.654.369a5.741 5.741 0 00.28.14l.018.008.006.003zM10 11.25a2.75 2.75 0 100 5.5 2.75 2.75 0 000-5.5z" clip-rule="evenodd" /><path d="M10 2C4.477 2 0 6.477 0 12s4.477 10 10 10 10-4.477 10-10S15.523 2 10 2zM8 14a2 2 0 114 0 2 2 0 01-4 0z" /></svg>
                <span>Mapa</span>
            </button>
            <button id="storybook-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.5m0 0l-5.5-5.5m5.5 5.5l5.5-5.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Storybook</span>
            </button>
            <button id="ar-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 1a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 1zM4.879 4.879a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061L4.879 5.94a.75.75 0 010-1.06zM1 8a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5H1.75A.75.75 0 011 8zm3.879 4.182a.75.75 0 010 1.06l-1.06 1.06a.75.75 0 11-1.06-1.06l1.06-1.061a.75.75 0 011.06 0zM8 15a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 15zm4.182-3.879a.75.75 0 011.06 0l1.06 1.06a.75.75 0 11-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zM15 8a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 0115 8zm3.121-3.121a.75.75 0 010 1.06l-1.06 1.06a.75.75 0 01-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zM10 5a5 5 0 100 10 5 5 0 000-10zM5 10a5 5 0 1110 0 5 5 0 01-10 0z" clip-rule="evenodd" /></svg>
                <span>AR</span>
            </button>
            <button id="admin-btn" class="flex flex-col items-center text-xs">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                <span>Admin</span>
            </button>
        </div>

        <!-- MODAL PLANIFICADOR ACTUALIZADO -->
        <div id="planner-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-1/2 -translate-y-1/2 mx-auto p-8 border-0 w-full max-w-2xl shadow-2xl rounded-2xl bg-white dark:bg-slate-800">
                <div class="text-center mb-8">
                    <div class="inline-block bg-emerald-100 dark:bg-emerald-900/50 p-3 rounded-full mb-3">
                        <svg class="h-10 w-10 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.5-13.5-3.432 3.432-3.432-3.432s.5-1.5 1.5-1.5 2.432 1.5 3.432 1.5 1.932-1.5 1.932-1.5ZM8.25 18.75h7.5" />
                        </svg>
                    </div>
                    <h3 class="text-2xl leading-6 font-bold text-gray-900 dark:text-gray-100">Crea tu Aventura Perfecta</h3>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Solo necesitamos 4 datos para dise√±arte un plan a medida.</p>
                </div>
                <button id="close-planner-modal-btn" class="absolute top-4 left-4 p-2 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700 hover:text-gray-600 dark:hover:text-gray-200">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                   </svg>
                </button>
                <form id="planner-form" class="space-y-6">
                    <div>
                        <label class="flex items-center text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
                            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white font-bold mr-3">1</span>
                            Tu estilo de viaje
                        </label>
                        <div id="planner-style-group" class="grid grid-cols-3 gap-4 mt-2">
                            <button type="button" data-value="Aventura" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-emerald-500 text-white border-emerald-500">
                                <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg>
                                <span class="font-semibold">Aventura</span>
                            </button>
                            <button type="button" data-value="Relax" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-slate-600">
                                <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" /></svg>
                                <span class="font-semibold">Relax</span>
                            </button>
                            <button type="button" data-value="Familiar" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-slate-600">
                                <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962A3.75 3.75 0 0115 12a3.75 3.75 0 01-2.25 3.512m-9.75-2.962c0-.552.246-1.631 1.25-2.262a25.814 25.814 0 017.5 0c1.004.631 1.25 1.71 1.25 2.262m-9.75 1.068c0 .551.246 1.631 1.25 2.261a25.814 25.814 0 007.5 0c1.004-.63 1.25-1.71 1.25-2.261M12 6a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5z" /></svg>
                                <span class="font-semibold">Familiar</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="planner-days" class="flex items-center text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
                            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white font-bold mr-3">2</span>
                            ¬øCu√°ntos d√≠as te quedas?
                        </label>
                        <input type="number" id="planner-days" value="3" min="1" max="14" class="mt-1 block w-full p-3 border-2 border-gray-200 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 rounded-lg shadow-sm text-base text-center font-bold text-xl focus:border-emerald-500 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="flex items-center text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
                            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white font-bold mr-3">3</span>
                            Tu nivel de energ√≠a
                        </label>
                        <div id="planner-energy-group" class="grid grid-cols-3 gap-4 mt-2">
                            <button type="button" data-value="Bajo" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-slate-600">
                                <span class="text-2xl">üê¢</span>
                                <span class="font-semibold">Bajo</span>
                            </button>
                            <button type="button" data-value="Medio" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-emerald-500 text-white border-emerald-500">
                                <span class="text-2xl">üö∂‚Äç‚ôÇÔ∏è</span>
                                <span class="font-semibold">Medio</span>
                            </button>
                            <button type="button" data-value="Alto" class="planner-option-btn flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer transition-colors duration-200 bg-gray-50 dark:bg-slate-700 border-gray-200 dark:border-slate-600">
                                <span class="text-2xl">‚ö°</span>
                                <span class="font-semibold">Alto</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="flex items-center text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">
                            <span class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white font-bold mr-3">4</span>
                            Localidades a visitar
                        </label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="localidad" value="El Bols√≥n" class="planner-localidad-checkbox rounded text-emerald-600" checked>
                                <span>El Bols√≥n</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="localidad" value="Lago Puelo" class="planner-localidad-checkbox rounded text-emerald-600">
                                <span>Lago Puelo</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="localidad" value="El Hoyo" class="planner-localidad-checkbox rounded text-emerald-600">
                                <span>El Hoyo</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="localidad" value="Epuy√©n" class="planner-localidad-checkbox rounded text-emerald-600">
                                <span>Epuy√©n</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="localidad" value="El Mait√©n" class="planner-localidad-checkbox rounded text-emerald-600">
                                <span>El Mait√©n</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="localidad" value="Cholila" class="planner-localidad-checkbox rounded text-emerald-600">
                                <span>Cholila</span>
                            </label>
                        </div>
                    </div>
                    <div class="pt-6">
                        <button type="submit" class="w-full flex items-center justify-center gap-3 bg-emerald-500 text-white font-bold py-4 px-4 rounded-xl hover:bg-emerald-600 text-lg transition-transform transform hover:scale-105 shadow-lg">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M3.5 2.75a.75.75 0 00-1.5 0v14.5a.75.75 0 001.5 0v-4.392l1.657-.348a6.44 6.44 0 014.231.575l.256.102a.75.75 0 00.868-.133l4.25-4.25a.75.75 0 00-.133-.868l-.102-.256a6.44 6.44 0 01-.575-4.231l.348-1.657V2.75z" />
                            </svg>
                            Generar Mi Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL STORYBOOK -->
        <div id="storybook-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[110] transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Crea tu Storybook de Viaje</h3>
                    <button id="close-storybook-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <form id="storybook-form" class="flex-grow overflow-y-auto pr-2 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sube de 1 a 5 fotos de tu viaje (URLs p√∫blicas)</label>
                        <div id="image-inputs" class="space-y-2">
                            <div class="flex items-center gap-2">
                                <input type="url" placeholder="URL de la foto 1" class="storybook-image-input w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                <button type="button" class="remove-image-btn text-red-500 hover:text-red-700">‚úï</button>
                            </div>
                        </div>
                        <button type="button" id="add-image-btn" class="mt-2 text-emerald-500 hover:text-emerald-600 text-sm">+ Agregar otra foto</button>
                    </div>
                    <div>
                        <label for="storybook-question1" class="block text-sm font-medium text-gray-700 dark:text-gray-300">¬øCu√°l fue tu momento favorito?</label>
                        <textarea id="storybook-question1" rows="2" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm"></textarea>
                    </div>
                    <div>
                        <label for="storybook-question2" class="block text-sm font-medium text-gray-700 dark:text-gray-300">¬øQu√© lugar te sorprendi√≥ m√°s?</label>
                        <input type="text" id="storybook-question2" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="storybook-question3" class="block text-sm font-medium text-gray-700 dark:text-gray-300">¬øQu√© consejo dar√≠as a otros viajeros?</label>
                        <textarea id="storybook-question3" rows="2" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm"></textarea>
                    </div>
                    <div class="pt-4">
                        <button type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-600">Generar Storybook</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MODAL PREVIEW STORYBOOK -->
        <div id="storybook-preview-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[120] transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Tu Storybook de Viaje</h3>
                    <button id="close-storybook-preview-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="storybook-preview-content" class="flex-grow overflow-y-auto pr-2 py-4 bg-gray-50 dark:bg-slate-700 rounded-lg"></div>
                <div class="pt-4 text-center">
                    <button id="send-whatsapp-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2 mx-auto">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                        Enviar por WhatsApp
                    </button>
                </div>
            </div>
        </div>

        <!-- TODOS LOS OTROS MODALES (sin cambios) -->
        <!-- Copiados 1:1 del archivo original -->
        <div id="password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white dark:bg-slate-800">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Acceso de Administrador</h3>
                    <form id="password-form" class="mt-4 space-y-4">
                        <div>
                            <label for="password-input" class="sr-only">Contrase√±a</label>
                            <input type="password" id="password-input" placeholder="Ingresa la contrase√±a" class="w-full p-2 rounded-md border border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700">
                            <p id="password-error" class="text-red-500 text-xs mt-1 hidden">Contrase√±a incorrecta.</p>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" id="close-password-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-emerald-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-emerald-600">Entrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="admin-panel-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
                <div class="flex justify-between items-center pb-3 border-b dark:border-slate-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Panel de Administraci√≥n</h3>
                    <button id="close-admin-panel-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="mt-4 space-y-3">
                    <p class="text-sm text-gray-600 dark:text-gray-300">Desde aqu√≠ puedes a√±adir nuevo contenido y gestionar la informaci√≥n existente.</p>
                    <button id="admin-add-btn" class="w-full flex items-center justify-center text-left p-3 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white font-medium">
                        <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        A√±adir Nuevo Lugar
                    </button>
                    <button id="admin-manage-btn" class="w-full flex items-center justify-center text-left p-3 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium">
                        <svg class="h-6 w-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2.5 4A1.5 1.5 0 001 5.5v9A1.5 1.5 0 002.5 16h15a1.5 1.5 0 001.5-1.5v-9A1.5 1.5 0 0017.5 4h-15zM2 5.5a.5.5 0 01.5-.5h15a.5.5 0 01.5.5v9a.5.5 0 01-.5.5h-15a.5.5 0 01-.5-.5v-9zM8 8a.75.75 0 000 1.5h4a.75.75 0 000-1.5H8z" clip-rule="evenodd" /></svg>
                        Gestionar Contenido
                    </button>
                </div>
            </div>
        </div>
        <div id="contribution-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[65] transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="mt-3 text-center">
                    <h3 id="contribution-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">A√±adir conocimiento a Andes</h3>
                    <div class="mt-2 flex-grow overflow-y-auto p-2">
                        <div id="contribution-tabs" class="border-b border-gray-200 dark:border-slate-600">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <button id="tab-single" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-emerald-500 border-emerald-500">A√±adir Uno</button>
                                <button id="tab-bulk" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">Carga R√°pida</button>
                            </nav>
                        </div>
                        <form id="contribution-form" class="mt-4 space-y-4 text-left">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="lugar-tipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Lugar</label>
                                    <select id="lugar-tipo" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                        <option value="restaurantes" data-subtype="Restaurante">Restaurante</option>
                                        <option value="restaurantes" data-subtype="Bar">Bar</option>
                                        <option value="restaurantes" data-subtype="Confiter√≠a">Confiter√≠a</option>
                                        <option value="restaurantes" data-subtype="Casa de T√©">Casa de T√©</option>
                                        <option value="alojamiento" data-subtype="Apart Hotel">Apart Hotel</option>
                                        <option value="alojamiento" data-subtype="Caba√±as">Caba√±as</option>
                                        <option value="alojamiento" data-subtype="Campings">Campings</option>
                                        <option value="alojamiento" data-subtype="Hoteles">Hoteles</option>
                                        <option value="alojamiento" data-subtype="Hosterias">Hosterias</option>
                                        <option value="alojamiento" data-subtype="Hospedajes">Hospedajes</option>
                                        <option value="alojamiento" data-subtype="Hostels">Hostels</option>
                                        <option value="alojamiento" data-subtype="Alquiler de Casas">Alquiler de Casas</option>
                                        <option value="alojamiento" data-subtype="Alquiler de Departamentos">Alquiler de Departamentos</option>
                                        <option value="alojamiento" data-subtype="Bread & Breakfast">Bread & Breakfast</option>
                                        <option value="actividades">Actividades</option>
                                        <option value="lugaresParaVisitar">Lugar para Visitar</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="lugar-localidad" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Localidad</label>
                                    <select id="lugar-localidad" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                        <option>El Bols√≥n</option>
                                        <option>Lago Puelo</option>
                                        <option>El Hoyo</option>
                                        <option>Epuy√©n</option>
                                        <option>El Mait√©n</option>
                                        <option>Cholila</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="lugar-nombre" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre del Lugar</label>
                                <div class="relative w-full mt-1">
                                    <input type="text" id="lugar-nombre" required class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="lugar-direccion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Direcci√≥n (Opcional)</label>
                                <div class="relative w-full mt-1">
                                    <input type="text" id="lugar-direccion" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="lugar-telefono" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tel√©fono (Opcional)</label>
                                <div class="relative w-full mt-1">
                                    <input type="text" id="lugar-telefono" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                    <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="lugar-latitud" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Latitud (Opcional)</label>
                                    <input type="text" id="lugar-latitud" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="-41.9669">
                                </div>
                                <div>
                                    <label for="lugar-longitud" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Longitud (Opcional)</label>
                                    <input type="text" id="lugar-longitud" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="-71.5333">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Busca el lugar en Google Maps, haz clic derecho y copia las coordenadas (ej: -41.96, -71.53).</p>
                            <div>
                                <label for="lugar-imagen" class="block text-sm font-medium text-gray-700 dark:text-gray-300">URL de Imagen (Opcional)</label>
                                <input type="url" id="lugar-imagen" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="https://ejemplo.com/foto.jpg">
                            </div>
                            <div>
                                <label for="lugar-imagen360" class="block text-sm font-medium text-gray-700 dark:text-gray-300">URL de Imagen 360¬∞ (Opcional)</label>
                                <input type="url" id="lugar-imagen360" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="https://ejemplo.com/foto_360.jpg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Pega aqu√≠ el link a una foto equirectangular (formato 360¬∞).</p>
                            </div>
                            <div>
                                <label for="lugar-descripcion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descripci√≥n Principal</label>
                                <div class="relative w-full mt-1">
                                   <textarea id="lugar-descripcion" rows="3" required class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm"></textarea>
                                   <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                       <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                   </button>
                               </div>
                            </div>
                            <div>
                                <label for="lugar-datos-clave" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Datos Clave / Puntos a Destacar (Opcional)</label>
                                <div class="relative w-full mt-1">
                                    <textarea id="lugar-datos-clave" rows="3" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm" placeholder="Ej: Horario: 9 a 18hs.
No se aceptan mascotas.
Aclaraci√≥n: No hay un laberinto para ni√±os."></textarea>
                                    <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                       <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                   </button>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <input id="lugar-sponsor" type="checkbox" class="h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                                <label for="lugar-sponsor" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">‚≠ê Es un lugar recomendado</label>
                            </div>
                            <div class="pt-4 flex justify-end">
                                <button id="contribution-submit-btn" type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 flex items-center justify-center min-w-[120px]">A√±adir Lugar</button>
                            </div>
                        </form>
                        <div id="bulk-entry-form-container" class="hidden mt-4 text-left">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Pega cada lugar en una nueva l√≠nea. Separa cada dato con una coma. <strong class="dark:text-gray-200">La descripci√≥n siempre debe ir al final.</strong></p>
                            <p class="text-xs text-gray-500 dark:text-gray-300 mb-2">Si no tienes un dato (ej: tel√©fono o coordenadas), deja el espacio vac√≠o entre las comas.</p>
                            <p class="text-xs text-gray-500 dark:text-gray-300 bg-gray-100 dark:bg-slate-700 p-2 rounded-md mb-4"><code>Tipo: Caba√±as, Nombre: Mi Caba√±a, Localidad: El Bols√≥n, ... , Descripci√≥n completa...: Texto libre.</code></p>
                            <div class="relative w-full mt-1">
                                <textarea id="bulk-input" rows="8" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md" placeholder="Tipo: Caba√±as, Nombre: Caba√±a La Escondida, Localidad: El Hoyo, Direcci√≥n: Curva de fin de la recta de El Pedregoso, Tel√©fono: +54 (294) 459-7157, Latitud: -42.007621, Longitud: -71.522818, Descripci√≥n completa...: Caba√±a con capacidad para 4 personas, ideal para el descanso"></textarea>
                                <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"/><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z"/><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z"/></svg>
                                </button>
                            </div>
                            <div class="pt-4 flex justify-end">
                                <button type="button" id="process-bulk-btn" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Procesar</button>
                            </div>
                            <div id="bulk-review-container" class="mt-4"></div>
                        </div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-contribution-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="manage-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[60] transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="flex flex-wrap justify-between items-center mb-4 pb-2 border-b dark:border-slate-600 gap-2">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Gestionar Contenido</h3>
                    <div class="flex items-center gap-2">
                        <button id="restore-backup-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                            Restaurar Backup
                        </button>
                        <button id="download-backup-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Descargar Backup
                        </button>
                    </div>
                </div>
                <div id="manage-list" class="flex-grow overflow-y-auto pr-2">
                    </div>
                <div class="items-center px-4 py-3 text-right mt-4 border-t dark:border-slate-600">
                    <button id="close-manage-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600">Cerrar</button>
                </div>
            </div>
        </div>
        <div id="rincon-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">El Rinc√≥n del Viajero</h3>
                    <button id="close-rincon-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <form id="tip-form" class="mb-4">
                    <label for="tip-input" class="sr-only">Deja tu consejo</label>
                    <textarea id="tip-input" rows="3" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Comparte un dato, una recomendaci√≥n o un consejo para otros viajeros..."></textarea>
                    <div class="text-right mt-2">
                        <button type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Compartir Consejo</button>
                    </div>
                </form>
                <div id="rincon-list" class="flex-grow overflow-y-auto pr-2 space-y-4">
                    </div>
            </div>
        </div>
        <div id="rating-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
                    <h3 id="rating-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Opiniones y Valoraciones</h3>
                    <button id="close-rating-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div class="flex-grow overflow-y-auto pr-2">
                    <div id="average-rating-container" class="text-center mb-4"></div>
                    <div id="comments-list" class="space-y-4"></div>
                </div>
                <form id="rating-form" class="mt-4 border-t dark:border-slate-600 pt-4">
                    <h4 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Deja tu valoraci√≥n</h4>
                    <div class="star-rating mb-2">
                        <input type="radio" id="5-stars" name="rating" value="5" /><label for="5-stars">‚òÖ</label>
                        <input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars">‚òÖ</label>
                        <input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars">‚òÖ</label>
                        <input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars">‚òÖ</label>
                        <input type="radio" id="1-star" name="rating" value="1" /><label for="1-star">‚òÖ</label>
                    </div>
                    <textarea id="comment-input" rows="3" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Escribe tu comentario aqu√≠..."></textarea>
                    <div class="text-right mt-2">
                        <button type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Enviar Opini√≥n</button>
                    </div>
                </form>
            </div>
        </div>
        <input type="file" id="backup-file-input" accept=".csv" class="hidden">
        <div id="confirm-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
            <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Confirmar Eliminaci√≥n</h3>
                <p id="delete-confirmation-text" class="mt-2 text-sm text-gray-600 dark:text-gray-300">¬øEst√°s seguro de que quieres eliminar este elemento?</p>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Eliminar</button>
                </div>
            </div>
        </div>
        <div id="confirm-restore-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
            <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
                <h3 class="text-lg font-medium text-red-600 dark:text-red-400">¬°Acci√≥n Irreversible!</h3>
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
                    Est√°s a punto de <strong class="font-bold">BORRAR TODOS</strong> los datos actuales y reemplazarlos por el contenido del archivo de backup.
                    <br><br>
                    ¬øEst√°s completamente seguro?
                </p>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancel-restore-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                    <button id="confirm-restore-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">S√≠, restaurar</button>
                </div>
            </div>
        </div>
        <div id="confirm-rubro-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
            <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
                <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Confirmar Eliminaci√≥n de Rubro</h3>
                <p id="rubro-delete-confirmation-text" class="mt-2 text-sm text-gray-600 dark:text-gray-300"></p>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancel-rubro-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                    <button id="confirm-rubro-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">S√≠, eliminar rubro</button>
                </div>
            </div>
        </div>
        <div id="map-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 h-full w-full hidden z-[80] transition-opacity duration-300 flex flex-col">
            <div class="bg-white dark:bg-slate-800 p-3 flex justify-between items-center shadow-md">
                <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Mapa Interactivo de la Comarca</h3>
                <button id="close-map-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-gray-200" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div id="map-container" class="flex-grow">
                <div id="map"></div>
            </div>
        </div>
        <div id="vr-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[90] transition-opacity duration-300 flex flex-col">
            <div class="absolute top-0 right-0 p-2 z-10">
                <button id="close-vr-modal-btn" class="p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <a-scene id="vr-scene" embedded>
                <a-sky id="vr-sky" radius="100"></a-sky>
            </a-scene>
        </div>
        <div id="ar-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[100] transition-opacity duration-300">
            <div id="ar-top-bar" class="ar-top-bar" style="display: none;">
                <button id="close-ar-modal-btn" class="p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="ar-permissions-pill" class="ar-pill"></div>
            </div>
            <div id="ar-status"></div>
            <div id="ar-modal-content">
            </div>
        </div>
        <audio id="radio-player" preload="none"></audio>
        <script type="module">
            // ... (todo el JS existente SIN CAMBIOS hasta la funci√≥n generatePlannerPrompt)

            // --- A√ëADIMOS LAS NUEVAS FUNCIONES Y EVENTOS ---
            const storybookBtn = document.getElementById('storybook-btn');
            const storybookModal = document.getElementById('storybook-modal');
            const storybookPreviewModal = document.getElementById('storybook-preview-modal');
            const closeStorybookModalBtn = document.getElementById('close-storybook-modal-btn');
            const closeStorybookPreviewModalBtn = document.getElementById('close-storybook-preview-modal-btn');
            const storybookForm = document.getElementById('storybook-form');
            const addImageBtn = document.getElementById('add-image-btn');
            const imageInputs = document.getElementById('image-inputs');
            const sendWhatsappBtn = document.getElementById('send-whatsapp-btn');
            const storybookPreviewContent = document.getElementById('storybook-preview-content');

            // Setup Storybook modal
            if (storybookBtn) storybookBtn.addEventListener('click', () => storybookModal.classList.remove('hidden'));
            if (closeStorybookModalBtn) closeStorybookModalBtn.addEventListener('click', () => storybookModal.classList.add('hidden'));
            if (closeStorybookPreviewModalBtn) closeStorybookPreviewModalBtn.addEventListener('click', () => storybookPreviewModal.classList.add('hidden'));

            addImageBtn.addEventListener('click', () => {
                if (document.querySelectorAll('.storybook-image-input').length >= 5) return;
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <input type="url" placeholder="URL de la foto" class="storybook-image-input w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                    <button type="button" class="remove-image-btn text-red-500 hover:text-red-700">‚úï</button>
                `;
                imageInputs.appendChild(div);
            });

            imageInputs.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-image-btn')) {
                    if (document.querySelectorAll('.storybook-image-input').length > 1) {
                        e.target.closest('.flex').remove();
                    }
                }
            });

            async function generateStorybookWithAI(images, answers) {
                const prompt = `
Eres Andes, un narrador de viajes creativo. Basado en estas fotos y respuestas, crea un storybook de viaje de 6 a 10 p√°ginas en formato HTML listo para WhatsApp.
- Usa un tono c√°lido, inspirador y personal.
- Cada p√°gina debe tener un t√≠tulo y un p√°rrafo corto.
- Inserta las im√°genes entre las p√°ginas usando <img src="URL" style="width:100%; max-height:300px; object-fit:cover; border-radius:12px;">.
- No uses CSS externo, solo estilos inline b√°sicos.
- No incluyas botones ni enlaces, solo el contenido narrativo.
- Concluye con una despedida emotiva.

Fotos: ${images.filter(img => img).join(', ')}

Respuestas:
- Momento favorito: "${answers.q1}"
- Lugar que sorprendi√≥ m√°s: "${answers.q2}"
- Consejo para otros viajeros: "${answers.q3}"
                `;
                const history = [{ role: "user", parts: [{ text: prompt }] }];
                const response = await getAIResponse(history, "");
                return response.text;
            }

            storybookForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const imageUrls = Array.from(document.querySelectorAll('.storybook-image-input'))
                    .map(input => input.value.trim())
                    .filter(url => url && url.startsWith('http'));
                const q1 = document.getElementById('storybook-question1').value.trim();
                const q2 = document.getElementById('storybook-question2').value.trim();
                const q3 = document.getElementById('storybook-question3').value.trim();

                if (imageUrls.length === 0 || !q1 || !q2 || !q3) {
                    alert('Por favor completa todas las preguntas y al menos una foto.');
                    return;
                }

                storybookModal.classList.add('hidden');
                storybookPreviewContent.innerHTML = '<p class="text-center py-4">Generando tu storybook... üìñ</p>';

                try {
                    const htmlContent = await generateStorybookWithAI(imageUrls, { q1, q2, q3 });
                    storybookPreviewContent.innerHTML = htmlContent;
                    storybookPreviewModal.classList.remove('hidden');
                } catch (error) {
                    console.error("Error generando storybook:", error);
                    storybookPreviewContent.innerHTML = '<p class="text-center py-4 text-red-500">Hubo un error al generar tu storybook. Int√©ntalo de nuevo.</p>';
                }
            });

            sendWhatsappBtn.addEventListener('click', () => {
                const content = storybookPreviewContent.innerText || "¬°Mira mi storybook de viaje en la Comarca Andina!";
                const encoded = encodeURIComponent(`¬°Hola! üåÑ\n\n${content}\n\nCreado con Andes - Tu Gu√≠a en la Comarca`);
                window.open(`https://wa.me/?text=${encoded}`, '_blank');
            });

            // --- MODIFICAMOS generatePlannerPrompt para incluir localidades ---
            function generatePlannerPrompt(style, days, energy, selectedLocalidades) {
                const localidadesStr = selectedLocalidades.length > 0 ? selectedLocalidades.join(', ') : 'toda la Comarca Andina';
                return `
Eres "Andes Planner", un experto en crear itinerarios de viaje para la Comarca Andina del Paralelo 42.
Recibir√°s las preferencias del usuario y tu √öNICA tarea es crear un itinerario detallado, d√≠a por d√≠a.
PREFERENCIAS DEL USUARIO:
- Estilo de Viaje: ${style}
- Duraci√≥n: ${days} d√≠as
- Nivel de Energ√≠a: ${energy}
- Localidades a visitar: ${localidadesStr}

BASE DE CONOCIMIENTO DISPONIBLE (LUGARES):
\`\`\`json
${JSON.stringify(dynamicKnowledgeBase, null, 2)}
\`\`\`

INSTRUCCIONES PARA CREAR EL ITINERARIO:
1. **Formato Obligatorio:** Usa Markdown. Crea un t√≠tulo para cada d√≠a (ej: "**D√≠a 1: Aventura y Sabores**"). Para cada d√≠a, sugiere 2 o 3 actividades/lugares. Usa listas con guiones.
2. **Selecci√≥n Inteligente:**
   - **Coherencia:** Elige lugares y actividades que coincidan con el *Estilo de Viaje* y *Nivel de Energ√≠a*.
   - **Log√≠stica:** Agrupa actividades que est√©n en la misma localidad o cerca. **Solo usa las localidades seleccionadas por el usuario.**
   - **Variedad:** Intenta incluir una mezcla de actividades, gastronom√≠a y paisajes.
3. **REGLA ESPECIAL D√çA 1:** Para el **D√≠a 1**, enf√≥cate en actividades y lugares para comer. **NO** sugieras alojamiento.
4. **Menciona Lugares Correctamente:** Cuando sugieras un lugar de tu base de conocimiento, menci√≥nalo entre corchetes dobles: [[Nombre Exacto del Lugar]].
5. **Descripci√≥n Atractiva:** Para cada sugerencia, escribe una o dos frases cortas y atractivas.
6. **No Saludes ni Despidas:** Ve directo al itinerario. Empieza con "**D√≠a 1:...**".
                `;
            }

            // --- MODIFICAMOS EL SUBMIT DEL PLANIFICADOR ---
            plannerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedStyleBtn = document.querySelector('#planner-style-group .bg-emerald-500');
                const style = selectedStyleBtn ? selectedStyleBtn.dataset.value : 'Aventura';
                const days = document.getElementById('planner-days').value;
                const selectedEnergyBtn = document.querySelector('#planner-energy-group .bg-emerald-500');
                const energy = selectedEnergyBtn ? selectedEnergyBtn.dataset.value : 'Medio';
                const selectedLocalidades = Array.from(document.querySelectorAll('.planner-localidad-checkbox:checked'))
                    .map(cb => cb.value);

                plannerModal.classList.add('hidden');
                const userMessage = `Quiero un plan de viaje para ${days} d√≠as en ${selectedLocalidades.length ? selectedLocalidades.join(', ') : 'la Comarca Andina'}, con un estilo ${style} y nivel de energ√≠a ${energy}.`;
                addMessage({ text: userMessage }, 'user');
                const typingIndicator = showTypingIndicator();
                const plannerHistory = [{
                    role: "user",
                    parts: [{ text: `Estilo: ${style}, D√≠as: ${days}, Energ√≠a: ${energy}, Localidades: ${selectedLocalidades.join(', ') || 'todas'}` }]
                }];
                const plannerSystemPrompt = generatePlannerPrompt(style, days, energy, selectedLocalidades);
                const aiResponseData = await getAIResponse(plannerHistory, plannerSystemPrompt);
                chatWindow.removeChild(typingIndicator);
                addMessage({
                    text: aiResponseData.text,
                    isPlannerResponse: true
                }, 'ai');
            });

            // ... (el resto del JS existente SIN CAMBIOS, incluyendo initializeFirebase, getAIResponse, etc.)

            // --- FUNCI√ìN CORREGIDA PARA EL BOT√ìN COMENZAR ---
            function startApp() {
                const welcomeScreen = document.getElementById('welcome-screen');
                const mainApp = document.getElementById('main-app');
                if (welcomeScreen) welcomeScreen.classList.add('hidden');
                if (mainApp) mainApp.classList.remove('hidden');
                initializeFirebase();
                updateSuggestions();
            }
            const startChatBtn = document.getElementById('start-chat-btn');
            if (startChatBtn) {
                startChatBtn.addEventListener('click', startApp);
            } else {
                initializeFirebase();
                updateSuggestions();
            }
        </script>
    </div>
</body>
</html>
