<!DOCTYPE html>

<html lang="es" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistente Turístico: Comarca Andina</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Librerías para el mapa interactivo -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Librerías para Realidad Aumentada (AR) y Virtual (VR) -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<!-- El script de AR.js GPS se cargará dinámicamente -->

<style>
    body {
        font-family: 'Inter', sans-serif;
    }
    #chat-window, #manage-list, #rincon-list, #comments-list, #planner-list-container {
        scroll-behavior: smooth;
    }
    .user-message {
        background-color: #059669; /* emerald-600 */
        color: white;
    }
    .ai-message {
        background-color: #dcfce7; /* green-100 */
        color: #064e3b; /* emerald-900, dark green text */
    }
    .dark .ai-message {
        background-color: #064e3b; /* emerald-900 */
        color: #dcfce7; /* green-100, light green text */
    }
    .sponsored-message {
        background-color: #fefce8; /* yellow-50 */
        border: 1px solid #facc15; /* yellow-400 */
        color: #713f12; /* yellow-900 */
    }
    .dark .sponsored-message {
         background-color: #422006; /* yellow-900/darker */
         border: 1px solid #facc15; /* yellow-400 */
         color: #fefce8; /* yellow-50 */
    }
    .typing-indicator span {
        height: 8px;
        width: 8px;
        float: left;
        margin: 0 1px;
        background-color: #9ca3af;
        display: block;
        border-radius: 50%;
        opacity: 0.4;
        animation: 1s blink infinite .3333s;
    }
    .typing-indicator span:nth-child(2) {
        animation-delay: .6666s;
    }
    .typing-indicator span:nth-child(3) {
        animation-delay: .9999s;
    }
    @keyframes blink {
        50% {
            opacity: 1;
        }
    }
    @keyframes pulse {
        50% {
            transform: scale(1.1);
        }
    }
    .playing-animation {
        animation: pulse 1.5s infinite ease-in-out;
    }
    /* Scrollbar styles */
    #chat-window::-webkit-scrollbar, #manage-list::-webkit-scrollbar, #rincon-list::-webkit-scrollbar, #comments-list::-webkit-scrollbar, #map-container::-webkit-scrollbar, #planner-list-container::-webkit-scrollbar {
        width: 8px;
    }
    #chat-window::-webkit-scrollbar-track, #manage-list::-webkit-scrollbar-track, #rincon-list::-webkit-scrollbar-track, #comments-list::-webkit-scrollbar-track, #map-container::-webkit-scrollbar-track, #planner-list-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .dark #chat-window::-webkit-scrollbar-track, .dark #manage-list::-webkit-scrollbar-track, .dark #rincon-list::-webkit-scrollbar-track, .dark #comments-list::-webkit-scrollbar-track, .dark #map-container::-webkit-scrollbar-track, .dark #planner-list-container::-webkit-scrollbar-track {
        background: #2d3748;
    }
    #chat-window::-webkit-scrollbar-thumb, #manage-list::-webkit-scrollbar-thumb, #rincon-list::-webkit-scrollbar-thumb, #comments-list::-webkit-scrollbar-thumb, #map-container::-webkit-scrollbar-thumb, #planner-list-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    #chat-window::-webkit-scrollbar-thumb:hover, #manage-list::-webkit-scrollbar-thumb:hover, #rincon-list::-webkit-scrollbar-thumb:hover, #comments-list::-webkit-scrollbar-thumb:hover, #map-container::-webkit-scrollbar-thumb:hover, #planner-list-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    /* Estilos para notificaciones */
    #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .toast {
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        color: white;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.5s ease-in-out;
        display: flex;
        align-items: center;
    }
    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    .toast.success { background-color: #10B981; }
    .toast.error { background-color: #EF4444; }
    .toast.info { background-color: #3B82F6; }
    
    /* Estilos para Valoraciones y Comentarios */
    .place-link {
        font-weight: bold;
        text-decoration: underline;
        color: #059669; /* emerald-600 */
        cursor: pointer;
    }
    .dark .place-link {
        color: #34d399; /* emerald-400 */
    }
    .star-rating {
        display: inline-flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
    }
    .star-rating input { display: none; }
    .star-rating label {
        cursor: pointer;
        color: #d1d5db; /* gray-300 */
        font-size: 1.5rem;
        transition: color 0.2s;
    }
    .star-rating input:checked ~ label,
    .star-rating:not(:checked) > label:hover,
    .star-rating:not(:checked) > label:hover ~ label {
        color: #f59e0b; /* amber-500 */
    }

    /* Estilos para el Mapa */
    #map { height: 100%; width: 100%; z-index: 1; }
    .leaflet-popup-content-wrapper {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .dark .leaflet-popup-content-wrapper {
         background: #1f2937; /* slate-800 */
         color: #e5e7eb; /* gray-200 */
    }
    .dark .leaflet-popup-tip {
         background: #1f2937;
    }
    .leaflet-popup-content {
        margin: 10px;
        font-family: 'Inter', sans-serif;
        max-height: 200px;
        overflow-y: auto;
    }
    .leaflet-popup-content p {
        margin: 5px 0;
    }
    .popup-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
    .popup-description { font-size: 0.9em; margin-bottom: 10px; }
    .popup-vr-button {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        background-color: #059669;
        color: white;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        border: none;
        cursor: pointer;
    }

    .popup-directions-button {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        background-color: #3B82F6; /* blue-500 */
        color: white;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        border: none;
        cursor: pointer;
        margin-left: 5px;
    }

    .custom-leaflet-icon {
        background-color: white;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        width: 32px !important;
        height: 32px !important;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        border: 2px solid white;
    }
    .custom-leaflet-icon svg {
        width: 18px;
        height: 18px;
        transform: rotate(45deg);
        color: white;
    }
    
    /* Estilos para el modal de AR */
    #ar-modal-content {
         position: relative;
         height: 100%;
         width: 100%;
         overflow: hidden;
    }
    #ar-status {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        background-color: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        z-index: 1200; /* Alto para estar sobre la escena */
        font-size: 1.1rem;
        max-width: 90%;
    }
    .ar-top-bar {
        position: absolute;
        left: 12px;
        top: 12px;
        z-index: 1100;
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .ar-pill {
        background: rgba(255, 255, 255, .08);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 13px;
        color: #d8fff0
    }

    /* Estilos del Planificador */
    .task-card {
        transition: all 0.3s ease;
    }
    .task-card.completed {
        background-color: #f0fdf4; /* green-50 */
        border-left-color: #22c55e; /* green-500 */
    }
    .dark .task-card.completed {
        background-color: #052e16; /* dark green */
        border-left-color: #4ade80; /* green-400 */
    }
    .task-card.completed h3 {
        text-decoration: line-through;
        color: #6b7280; /* gray-500 */
    }
    .dark .task-card.completed h3 {
        color: #9ca3af; /* gray-400 */
    }
    .planner-option-btn {
        transition: all 0.2s ease-in-out;
        border: 2px solid transparent;
    }
    .planner-option-btn.selected {
        border-color: #10b981; /* emerald-500 */
        background-color: #ecfdf5; /* emerald-50 */
        color: #065f46; /* emerald-800 */
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .dark .planner-option-btn.selected {
        background-color: #064e3b; /* emerald-900 */
        color: #a7f3d0; /* emerald-200 */
    }
    /* Estilos para el scroll horizontal de sugerencias */
    .horizontal-scroll::-webkit-scrollbar {
        display: none; /* Ocultar scrollbar en Chrome, Safari y Opera */
    }
    .horizontal-scroll {
        -ms-overflow-style: none;  /* Ocultar scrollbar en IE y Edge */
        scrollbar-width: none;  /* Ocultar scrollbar en Firefox */
    }
</style>

</head>
<body class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-gray-200 flex flex-col h-screen font-sans">

<!-- Header -->
<header class="bg-white dark:bg-slate-800 shadow-md z-10 border-b border-gray-200 dark:border-slate-700">
    <div class="container mx-auto px-4 sm:px-6 py-3 flex flex-wrap justify-between items-center">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center text-white font-bold text-xl ring-2 ring-offset-2 ring-emerald-500 ring-offset-white dark:ring-offset-slate-800">A</div>
            <div>
                <h1 class="text-lg font-bold text-gray-900 dark:text-gray-100">Andes: Asistente de la Comarca</h1>
                <p class="text-gray-600 dark:text-gray-400 text-sm">Tu guía experto en el Paralelo 42</p>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <button id="planner-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700" title="Mi Planificador de Viaje">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                </svg>
            </button>
            <button id="ar-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700" title="Vista de Realidad Aumentada">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.002 6.002a1 1 0 011.413-.225l4 3.001a1 1 0 010 1.448l-4 3.001a1 1 0 01-1.413-.225V6.002z" clip-rule="evenodd" />
                    <path d="M3.5 5a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v2a.5.5 0 01-1 0V6H4a.5.5 0 01-.5-.5zM16.5 5a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v2a.5.5 0 001 0V6h1.5a.5.5 0 00.5-.5zM3.5 15a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2a.5.5 0 00-1 0v1.5H4a.5.5 0 00-.5.5zM16.5 15a.5.5 0 01-.5.5h-2a.5.5 0 01-.5-.5v-2a.5.5 0 011 0v1.5H16a.5.5 0 01.5.5z" />
                </svg>
            </button>
            <button id="map-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700" title="Mapa Interactivo">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <button id="rincon-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700" title="El Rincón del Viajero">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
                    <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
                </svg>
            </button>
            <div id="radio-widget" class="flex items-center space-x-2 bg-white dark:bg-slate-700 p-1.5 rounded-full shadow-sm border dark:border-slate-600">
                <button id="play-pause-btn" class="w-8 h-8 flex items-center justify-center bg-emerald-500 text-white rounded-full hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <!-- SVG Icon will be inserted here by JS -->
                </button>
                <div class="flex items-center space-x-2 pr-2">
                    <img src="https://i.postimg.cc/8cLnSv8c/Logo-Fm-Paraiso-42.png" alt="Logo FM Paraiso 42" class="w-8 h-8 rounded-full">
                    <span class="text-sm font-semibold text-gray-700 dark:text-gray-200 hidden sm:inline">FM Paraíso 42</span>
                </div>
            </div>
            <div id="admin-controls" class="flex space-x-2 hidden">
                <button id="manage-btn" class="bg-gray-200 dark:bg-slate-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors duration-300">Gestionar</button>
                <button id="contribute-btn" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 transition-colors duration-300">Contribuir</button>
            </div>
            <button id="admin-login-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </button>
        </div>
    </div>
</header>

<!-- Chat Window -->
<main class="flex-1 overflow-y-auto p-4 sm:p-6">
    <div id="chat-window" class="space-y-4 max-w-4xl mx-auto">
        <!-- Messages will be appended here -->
    </div>
</main>

<!-- Suggested Questions -->
<div id="suggestions" class="p-4 border-t border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800">
    <div class="max-w-4xl mx-auto flex flex-nowrap gap-2 overflow-x-auto justify-start horizontal-scroll">
        <!-- Buttons will be injected here -->
    </div>
</div>

<!-- Input Form -->
<footer class="bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 p-4">
    <form id="chat-form" class="container mx-auto flex items-center space-x-2 max-w-4xl">
        <input type="text" id="chat-input" placeholder="Ej: ¿Qué puedo hacer hoy en El Bolsón?" class="flex-1 p-3 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-full focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-300" autocomplete="off">
        <button type="button" id="mic-btn" class="text-gray-500 dark:text-gray-400 rounded-full p-3 hover:bg-gray-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
        </button>
        <button type="submit" class="bg-emerald-500 text-white rounded-full p-3 hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
            </svg>
        </button>
    </form>
</footer>

<!-- Contenedor para las notificaciones -->
<div id="toast-container"></div>

<!-- Modal del Planificador Inteligente -->
<div id="planner-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
            <h3 class="text-xl leading-6 font-medium text-gray-900 dark:text-gray-100">Planificador de Viaje Inteligente</h3>
            <button id="close-planner-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
        </div>

        <div class="flex-grow overflow-y-auto pr-2">
            <p class="text-center text-gray-600 dark:text-gray-400 mb-6">Andes creará un plan a tu medida con solo 3 preguntas.</p>

            <form id="smart-planner-form" class="p-4 space-y-8">
                <!-- Paso 1: Estilo de Viaje -->
                <div>
                    <h4 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200 text-center">1. Elige tu estilo de viaje</h4>
                    <div id="travel-style-options" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button type="button" data-style="Aventura" class="planner-option-btn flex flex-col items-center p-4 bg-gray-100 dark:bg-slate-700 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2.5a.5.5 0 01.5-.5h3a.5.5 0 01.5.5V17a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                            <span class="font-semibold">Aventura</span>
                        </button>
                        <button type="button" data-style="Relax" class="planner-option-btn flex flex-col items-center p-4 bg-gray-100 dark:bg-slate-700 rounded-lg">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v1.168l3.396 3.396a1 1 0 01-1.414 1.414L10 6.414l-2.982 2.982a1 1 0 11-1.414-1.414L8.999 5.168V4a1 1 0 011-1z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10 18a1 1 0 01-1-1v-1.168l-3.396-3.396a1 1 0 111.414-1.414L10 13.586l2.982-2.982a1 1 0 111.414 1.414L11.001 14.832V16a1 1 0 01-1 1z" clip-rule="evenodd" /></svg>
                            <span class="font-semibold">Relax</span>
                        </button>
                        <button type="button" data-style="Familiar" class="planner-option-btn flex flex-col items-center p-4 bg-gray-100 dark:bg-slate-700 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 00-1-1v-.5a1.5 1.5 0 01-3 0v.5a1 1 0 00-1 1H6a1 1 0 01-1-1v-3a1 1 0 011-1h.5a1.5 1.5 0 000-3H6a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" /></svg>
                            <span class="font-semibold">Familiar</span>
                        </button>
                    </div>
                </div>
                <!-- Paso 2: Días -->
                <div class="text-center">
                    <label for="planner-days" class="block text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">2. ¿Cuántos días te quedas?</label>
                    <input type="number" id="planner-days" min="1" max="15" value="3" class="w-32 p-2 text-center border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md focus:ring-2 focus:ring-emerald-500 text-lg">
                </div>
                <!-- Paso 3: Energía -->
                <div>
                    <h4 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200 text-center">3. ¿Cuál es tu nivel de energía?</h4>
                    <div id="energy-level-options" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button type="button" data-energy="Bajo" class="planner-option-btn p-3 bg-gray-100 dark:bg-slate-700 rounded-lg font-semibold">Bajo</button>
                        <button type="button" data-energy="Medio" class="planner-option-btn p-3 bg-gray-100 dark:bg-slate-700 rounded-lg font-semibold">Medio</button>
                        <button type="button" data-energy="Alto" class="planner-option-btn p-3 bg-gray-100 dark:bg-slate-700 rounded-lg font-semibold">Alto</button>
                    </div>
                </div>
                <!-- Botón de Generar -->
                <div class="pt-4 text-center">
                    <button type="submit" class="bg-emerald-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-emerald-600 transition-transform transform hover:scale-105 duration-300">
                        ✨ Generar mi Plan Inteligente
                    </button>
                </div>
            </form>
            <div id="planner-result-container" class="hidden">
                <!-- El plan generado por la IA se mostrará aquí -->
            </div>
        </div>
    </div>
</div>

<!-- Admin Login Modal -->
<div id="admin-login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-40 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white dark:bg-slate-800">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Acceso de Administrador</h3>
        <form id="admin-login-form" class="mt-4 space-y-4">
            <div>
                <label for="admin-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Contraseña</label>
                <input type="password" id="admin-password" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                <p id="admin-error-msg" class="text-red-500 text-sm mt-1 hidden">Contraseña incorrecta.</p>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancel-admin-login-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-emerald-500 text-white rounded-md hover:bg-emerald-600">Ingresar</button>
            </div>
        </form>
    </div>
</div>


<!-- Contribution Modal -->
<div id="contribution-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
        <div class="mt-3 text-center">
            <h3 id="contribution-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Añadir conocimiento a Andes</h3>
             <div class="mt-2 flex-grow overflow-y-auto p-2">
                <!-- Tabs -->
                <div id="contribution-tabs" class="border-b border-gray-200 dark:border-slate-600">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-single" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-emerald-500 border-emerald-500">Añadir Uno</button>
                        <button id="tab-bulk" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">Carga Rápida</button>
                    </nav>
                </div>
                <!-- Single Entry Form -->
                <form id="contribution-form" class="mt-4 space-y-4 text-left">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="lugar-tipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Lugar</label>
                            <select id="lugar-tipo" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                                <option value="restaurantes" data-subtype="Restaurante">Restaurante</option>
                                <option value="restaurantes" data-subtype="Bar">Bar</option>
                                <option value="restaurantes" data-subtype="Confitería">Confitería</option>
                                <option value="restaurantes" data-subtype="Casa de Té">Casa de Té</option>
                                <option value="alojamiento" data-subtype="Apart Hotel">Apart Hotel</option>
                                <option value="alojamiento" data-subtype="Cabañas">Cabañas</option>
                                <option value="alojamiento" data-subtype="Campings">Campings</option>
                                <option value="alojamiento" data-subtype="Hoteles">Hoteles</option>
                                <option value="alojamiento" data-subtype="Hosterias">Hosterias</option>
                                <option value="alojamiento" data-subtype="Hospedajes">Hospedajes</option>
                                <option value="alojamiento" data-subtype="Hostels">Hostels</option>
                                <option value="alojamiento" data-subtype="Alquiler de Casas">Alquiler de Casas</option>
                                <option value="alojamiento" data-subtype="Alquiler de Departamentos">Alquiler de Departamentos</option>
                                <option value="alojamiento" data-subtype="Bread & Breakfast">Bread & Breakfast</option>
                                <option value="actividades">Actividades</option>
                                <option value="lugaresParaVisitar">Lugar para Visitar</option>
                            </select>
                        </div>
                        <div>
                            <label for="lugar-localidad" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Localidad</label>
                            <select id="lugar-localidad" required class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                                <option>El Bolsón</option>
                                <option>Lago Puelo</option>
                                <option>El Hoyo</option>
                                <option>Epuyén</option>
                                <option>El Maitén</option>
                                <option>Cholila</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="lugar-nombre" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre del Lugar</label>
                        <div class="relative w-full mt-1">
                            <input type="text" id="lugar-nombre" required class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                            <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="lugar-direccion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dirección (Opcional)</label>
                        <div class="relative w-full mt-1">
                            <input type="text" id="lugar-direccion" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                            <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="lugar-telefono" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Teléfono (Opcional)</label>
                        <div class="relative w-full mt-1">
                            <input type="text" id="lugar-telefono" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm">
                            <button type="button" class="absolute inset-y-0 right-0 flex items-center pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label for="lugar-latitud" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Latitud (Opcional)</label>
                            <input type="text" id="lugar-latitud" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="-41.9669">
                        </div>
                         <div>
                            <label for="lugar-longitud" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Longitud (Opcional)</label>
                            <input type="text" id="lugar-longitud" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="-71.5333">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Busca el lugar en Google Maps, haz clic derecho y copia las coordenadas (ej: -41.96, -71.53).</p>

                    <div>
                        <label for="lugar-imagen" class="block text-sm font-medium text-gray-700 dark:text-gray-300">URL de Imagen (Opcional)</label>
                        <input type="url" id="lugar-imagen" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="https://ejemplo.com/foto.jpg">
                    </div>
                    
                    <div>
                        <label for="lugar-imagen360" class="block text-sm font-medium text-gray-700 dark:text-gray-300">URL de Imagen 360° (Opcional)</label>
                        <input type="url" id="lugar-imagen360" class="mt-1 block w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="https://ejemplo.com/foto_360.jpg">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Pega aquí el link a una foto equirectangular (formato 360°).</p>
                    </div>

                    <div>
                        <label for="lugar-descripcion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descripción Principal</label>
                        <div class="relative w-full mt-1">
                            <textarea id="lugar-descripcion" rows="3" required class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm"></textarea>
                            <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="lugar-datos-clave" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Datos Clave / Puntos a Destacar (Opcional)</label>
                        <div class="relative w-full mt-1">
                            <textarea id="lugar-datos-clave" rows="3" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md shadow-sm" placeholder="Ej: Horario: 9 a 18hs.&#10;No se aceptan mascotas.&#10;Aclaración: No hay un laberinto para niños."></textarea>
                            <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input id="lugar-sponsor" type="checkbox" class="h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                        <label for="lugar-sponsor" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">⭐ Es un lugar recomendado</label>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button id="contribution-submit-btn" type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600 flex items-center justify-center min-w-[120px]">Añadir Lugar</button>
                    </div>
                </form>
                <!-- Bulk Entry Form -->
                <div id="bulk-entry-form-container" class="hidden mt-4 text-left">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Pega cada lugar en una nueva línea. Separa cada dato con una coma. <strong class="dark:text-gray-200">La descripción siempre debe ir al final.</strong></p>
                    <p class="text-xs text-gray-500 dark:text-gray-300 mb-2">Si no tienes un dato (ej: teléfono o coordenadas), deja el espacio vacío entre las comas.</p>
                    <p class="text-xs text-gray-500 dark:text-gray-300 bg-gray-100 dark:bg-slate-700 p-2 rounded-md mb-4"><code>Tipo: Nombre, Localidad, Dirección, Teléfono, Latitud, Longitud, Descripción completa...</code></p>
                    <div class="relative w-full mt-1">
                        <textarea id="bulk-input" rows="8" class="block w-full p-2 pr-10 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Restaurante: A Gusto, El Bolsón, Av. San Martín 2500, 2944112233, -41.963, -71.534, Excelente lugar para comer pastas, abierto mediodía y noche."></textarea>
                        <button type="button" class="absolute top-0 right-0 flex items-center pt-3 pr-3 mic-input-btn text-gray-500 hover:text-emerald-500">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 9.5a.5.5 0 01.5.5v1a4 4 0 004 4h.5a.5.5 0 010 1h-.5a5 5 0 01-5-5v-1a.5.5 0 01.5-.5z" /><path d="M10 15a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg>
                        </button>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="button" id="process-bulk-btn" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Procesar</button>
                    </div>
                    <div id="bulk-review-container" class="mt-4"></div>
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button id="close-contribution-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Management Modal -->
<div id="manage-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
        <!-- Header del modal con botones de descarga y restauración -->
         <div class="flex flex-wrap justify-between items-center mb-4 pb-2 border-b dark:border-slate-600 gap-2">
             <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Gestionar Contenido</h3>
             <div class="flex items-center gap-2">
                 <button id="restore-backup-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                       <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                     </svg>
                     Restaurar Backup
                 </button>
                 <button id="download-backup-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                       <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                     </svg>
                     Descargar Backup
                 </button>
             </div>
         </div>
         <div id="manage-list" class="flex-grow overflow-y-auto pr-2">
             <!-- La lista agrupada se mostrará aquí -->
         </div>
         <div class="items-center px-4 py-3 text-right mt-4 border-t dark:border-slate-600">
            <button id="close-manage-modal-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-600">Cerrar</button>
        </div>
    </div>
</div>

<!-- Nuevo modal para "El Rincón del Viajero" -->
<div id="rincon-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">El Rincón del Viajero</h3>
            <button id="close-rincon-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <!-- Formulario para dejar un consejo -->
        <form id="tip-form" class="mb-4">
            <label for="tip-input" class="sr-only">Deja tu consejo</label>
            <textarea id="tip-input" rows="3" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Comparte un dato, una recomendación o un consejo para otros viajeros..."></textarea>
            <div class="text-right mt-2">
                <button type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Compartir Consejo</button>
            </div>
        </form>
        
        <!-- Lista de consejos -->
        <div id="rincon-list" class="flex-grow overflow-y-auto pr-2 space-y-4">
            <!-- Los consejos de los viajeros se mostrarán aquí -->
        </div>
    </div>
</div>

<!-- Nuevo modal para Valoraciones y Comentarios -->
<div id="rating-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-[70] transition-opacity duration-300">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-slate-800 max-h-[85vh] flex flex-col">
        <!-- Header -->
        <div class="flex justify-between items-center mb-4 pb-2 border-b dark:border-slate-600">
            <h3 id="rating-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">Opiniones y Valoraciones</h3>
            <button id="close-rating-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                     <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        
        <!-- Rating y Comentarios -->
        <div class="flex-grow overflow-y-auto pr-2">
            <div id="average-rating-container" class="text-center mb-4"></div>
            <div id="comments-list" class="space-y-4"></div>
        </div>

        <!-- Formulario para valorar -->
        <form id="rating-form" class="mt-4 border-t dark:border-slate-600 pt-4">
             <h4 class="text-md font-semibold mb-2 text-gray-800 dark:text-gray-200">Deja tu valoración</h4>
             <div class="star-rating mb-2">
                <input type="radio" id="5-stars" name="rating" value="5" /><label for="5-stars">★</label>
                <input type="radio" id="4-stars" name="rating" value="4" /><label for="4-stars">★</label>
                <input type="radio" id="3-stars" name="rating" value="3" /><label for="3-stars">★</label>
                <input type="radio" id="2-stars" name="rating" value="2" /><label for="2-stars">★</label>
                <input type="radio" id="1-star" name="rating" value="1" /><label for="1-star">★</label>
            </div>
             <textarea id="comment-input" rows="3" class="w-full p-2 border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 rounded-md" placeholder="Escribe tu comentario aquí..."></textarea>
             <div class="text-right mt-2">
                <button type="submit" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-600">Enviar Opinión</button>
            </div>
        </form>
    </div>
</div>


<!-- Input oculto para seleccionar el archivo de backup -->
<input type="file" id="backup-file-input" accept=".csv" class="hidden">

<!-- Confirm Delete Modal (Individual & Planner) -->
<div id="confirm-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
     <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Confirmar Eliminación</h3>
        <p id="delete-confirmation-text" class="mt-2 text-sm text-gray-600 dark:text-gray-300">¿Estás seguro de que quieres eliminar este elemento?</p>
         <div class="mt-4 flex justify-end space-x-2">
            <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
            <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Eliminar</button>
        </div>
    </div>
</div>

<!-- Confirm Restore Modal -->
<div id="confirm-restore-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50 transition-opacity duration-300">
     <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
        <h3 class="text-lg font-medium text-red-600 dark:text-red-400">¡Acción Irreversible!</h3>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
            Estás a punto de <strong class="font-bold">BORRAR TODOS</strong> los datos actuales y reemplazarlos por el contenido del archivo de backup.
            <br><br>
            ¿Estás completamente seguro?
        </p>
         <div class="mt-4 flex justify-end space-x-2">
            <button id="cancel-restore-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
            <button id="confirm-restore-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Sí, restaurar</button>
        </div>
    </div>
</div>

<!-- Modal para confirmar borrado de rubro -->
<div id="confirm-rubro-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden z-[60] transition-opacity duration-300">
     <div class="relative top-40 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-slate-800">
        <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Confirmar Eliminación de Rubro</h3>
        <p id="rubro-delete-confirmation-text" class="mt-2 text-sm text-gray-600 dark:text-gray-300"></p>
         <div class="mt-4 flex justify-end space-x-2">
            <button id="cancel-rubro-delete-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
            <button id="confirm-rubro-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Sí, eliminar rubro</button>
        </div>
    </div>
</div>

<!-- Modal para el Mapa Interactivo -->
<div id="map-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 h-full w-full hidden z-[80] transition-opacity duration-300 flex flex-col">
    <div class="bg-white dark:bg-slate-800 p-3 flex justify-between items-center shadow-md">
        <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Mapa Interactivo de la Comarca</h3>
        <button id="close-map-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-gray-200" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
    <div id="map-container" class="flex-grow">
        <div id="map"></div>
    </div>
</div>

<!-- Modal para la Vista de Realidad Virtual (360°) -->
<div id="vr-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[90] transition-opacity duration-300 flex flex-col">
    <div class="absolute top-0 right-0 p-2 z-10">
         <button id="close-vr-modal-btn" class="p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                 <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
    <a-scene id="vr-scene" embedded>
        <a-sky id="vr-sky" radius="100"></a-sky>
    </a-scene>
</div>

<!-- Modal para Realidad Aumentada -->
<div id="ar-modal" class="fixed inset-0 bg-black h-full w-full hidden z-[100] transition-opacity duration-300">
     <div id="ar-top-bar" class="ar-top-bar" style="display: none;">
         <button id="close-ar-modal-btn" class="p-2 rounded-full bg-black bg-opacity-50 hover:bg-opacity-75">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                 <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
         <div id="ar-permissions-pill" class="ar-pill"></div>
     </div>
     <div id="ar-status"></div>
    <div id="ar-modal-content">
        <!-- La escena de A-Frame para AR se inyectará aquí dinámicamente -->
    </div>
</div>


<audio id="radio-player" preload="none"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, setLogLevel, doc, updateDoc, deleteDoc, writeBatch, getDocs, query, orderBy, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    document.addEventListener('DOMContentLoaded', function () {
        // Cargar el script de AR-GPS dinámicamente para evitar que se ejecute antes de tiempo
        function loadArGpsScript() {
            return new Promise((resolve, reject) => {
                if (document.querySelector('script[src*="aframe-ar-gps.js"]')) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-gps.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Estas variables serán reemplazadas por el entorno de ejecución
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        let lugaresCollectionRef;
        let consejosCollectionRef; 
        let collectionPath;
        let isAdmin = false; 
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    lugaresCollectionRef = getCollectionRef('lugares');
                    consejosCollectionRef = getCollectionRef('consejos'); 
                    
                    if (lugaresCollectionRef) listenForNewPlaces();
                    if (consejosCollectionRef) listenForTips(); 

                } else {
                    console.log("No user signed in, attempting to sign in.");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error during sign-in:", error);
                    }
                }
            });

        } catch (error) {
            console.error("Error initializing Firebase:", error);
            document.getElementById('chat-window').innerHTML = '<div class="text-red-500 p-4">Error: No se pudo conectar con la base de datos. La configuración de Firebase es incorrecta.</div>';
        }

        function getCollectionRef(name) {
            if (!db) {
                console.error("Firestore DB not initialized.");
                return null;
            }
            const path = `/artifacts/${appId}/public/data/${name}`;
            collectionPath = path;
            return collection(db, path);
        };

        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const suggestionsContainer = document.getElementById('suggestions');

        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        let dynamicKnowledgeBase = {};
        let placesCache = []; 
        let chatHistory = [];
        let tipsCache = []; 
        let commentsCache = {}; 
        let lastOpenDetails = { localidadId: null, rubroId: null };
        let currentPlaceCommentsUnsubscribe = null; 
        
        let map = null;
        let mapInitialized = false;
        let markersLayer = null; 
        let markersById = {};
        const mapModal = document.getElementById('map-modal');
        const mapBtn = document.getElementById('map-btn');
        const closeMapModalBtn = document.getElementById('close-map-modal-btn');
        const vrModal = document.getElementById('vr-modal');
        const closeVrModalBtn = document.getElementById('close-vr-modal-btn');
        const vrSky = document.getElementById('vr-sky');
        
        // --- Elementos de AR ---
        const arModal = document.getElementById('ar-modal');
        const arBtn = document.getElementById('ar-btn');
        const closeArModalBtn = document.getElementById('close-ar-modal-btn');
        const arModalContent = document.getElementById('ar-modal-content');
        const arStatus = document.getElementById('ar-status');
        const arTopBar = document.getElementById('ar-top-bar');
        const arPermissionsPill = document.getElementById('ar-permissions-pill');
        let arSceneEl = null;
        let videoTracks = [];
        
        function getRubroFromPlace(place) {
            if (place && typeof place.subtipo === 'string' && place.subtipo.trim()) {
                return place.subtipo.trim();
            }
            if (place && typeof place.tipo === 'string' && place.tipo.trim()) {
                const tipo = place.tipo.trim();
                return tipo.charAt(0).toUpperCase() + tipo.slice(1);
            }
            return 'Sin Rubro';
        }

        function listenForNewPlaces() {
            if (!lugaresCollectionRef) return;
            onSnapshot(lugaresCollectionRef, (snapshot) => {
                dynamicKnowledgeBase = {};
                placesCache = [];
                snapshot.docs.forEach(doc => {
                    const place = { id: doc.id, ...doc.data() };
                    const { localidad, tipo } = place;
                    
                    placesCache.push(place);

                    if (!dynamicKnowledgeBase[localidad]) dynamicKnowledgeBase[localidad] = {};
                    if (!dynamicKnowledgeBase[localidad][tipo]) dynamicKnowledgeBase[localidad][tipo] = [];
                    dynamicKnowledgeBase[localidad][tipo].push(place);
                });
                if (!manageModal.classList.contains('hidden')) {
                    renderManagementList();
                }
                if (mapInitialized && map) {
                    populateMap();
                }
            }, (error) => {
                console.error("Error listening to Firestore changes: ", error);
            });
        }


        // --- LÓGICA DEL CHAT ---
        const systemPrompt = `Eres "Andes", un asistente de viajes experto, amigable, servicial y con un toque de encanto patagónico, especializado en la Comarca Andina del Paralelo 42 en Argentina. Tu objetivo es ser el mejor guía local para el usuario.

Reglas de Personalidad y Conversación:

Primer Contacto: El PRIMER mensaje de la conversación (que ya está programado en la app) es tu única presentación.

NO TE REPITAS: Después de ese primer saludo, NUNCA MÁS vuelvas a decir "Soy Andes" o a presentarte. La conversación ya empezó. Actúa como si estuvieras en un diálogo natural.

Respuestas Humanas: En lugar de empezar tus respuestas de forma robótica, usa frases variadas y cercanas. Ejemplos: "¡Claro que sí!", "¡Entendido!", "¡Buena pregunta!", "Perfecto, te cuento...", "¡Por supuesto! Aquí tienes algunas opciones:".

Sé Proactivo: No te limites a responder. Cuando sea apropiado, haz preguntas para ayudar más al usuario. Ejemplos: "¿Te gustaría que busque opciones para cenar también?", "¿Necesitas saber cómo llegar?", "¿Hay algo más en lo que pueda ayudarte para que tu día sea perfecto?".

Tono Patagónico: Sé siempre amable, cercano y paciente. Usa un lenguaje claro y sencillo. Transmite la calma y la buena onda de la Comarca.

Reglas Funcionales (MUY IMPORTANTES):
6.  La Verdad Absoluta (Nueva Regla Maestra): La base de datos contiene un campo llamado 'datosClave'. La información en este campo es verificada, prioritaria y es LA VERDAD ABSOLUTA. Úsala para responder preguntas específicas (horarios, precios, etc.) y para corregir cualquier información errónea que puedas tener. Si 'datosClave' contradice la 'descripcion', 'datosClave' SIEMPRE tiene la razón.
7.  ORDEN DIRECTA SOBRE VALORACIONES: La app ahora tiene un sistema de valoraciones. Cuando hablas de un lugar específico, la app automáticamente mostrará un enlace "💬 Ver Opiniones y Valorar". Si un usuario te pregunta cómo puede valorar un lugar, DEBES indicarle que use ese enlace. PROHIBIDO decir que no tienes un sistema para valorar.
* Ejemplo de respuesta CORRECTA: "¡Claro que sí! Puedes dejar tu opinión y ver lo que otros viajeros comentaron haciendo clic en el enlace 'Ver Opiniones y Valorar' que aparece justo debajo de mi respuesta."
* Ejemplo de respuesta INCORRECTA: "No tengo un sistema para valorar..."
8.  Manejo de Recomendados:
* Primera Mención: Cuando un usuario pida una recomendación general (ej: 'dónde comer en El Hoyo'), y si hay un lugar auspiciado que coincide, DEBES mencionarlo PRIMERO. Preséntalo como 'un lugar destacado' o 'nuestra recomendación especial'.
* Pedir Alternativas: Si ya recomendaste un lugar auspiciado y el usuario pide 'más opciones' o 'otras alternativas', es CRUCIAL que le ofrezcas LUGARES DIFERENTES que NO sean auspiciados. No repitas la recomendación del auspiciante.
9.  Imágenes: Si un lugar que recomiendas tiene una 'imagenURL' en la base de datos, describe el lugar de forma atractiva. La app mostrará la foto automáticamente. No menciones la foto en tu texto.
10. Fuente de Información: Tu única fuente de conocimiento es la base de datos. Si no encuentras la información allí, indica amablemente que no tienes ese dato específico en tiempo real. NO inventes datos.
11. Localización: Responde solo sobre la Comarca Andina.
12. Fecha Actual: Usa la fecha actual proporcionada para preguntas sobre el clima o eventos, basándote en tu conocimiento general.`;
        
        const systemPlannerPrompt = `Eres "Andes", un asistente experto en viajes por la Comarca Andina. Tu tarea es crear un itinerario de viaje detallado, día por día, basado en las preferencias del usuario.

INPUT DEL USUARIO:
- Estilo de Viaje: {travelStyle}
- Duración: {days} días
- Nivel de Energía: {energyLevel}

TU BASE DE CONOCIMIENTOS (LUGARES DISPONIBLES):
{knowledgeBase}

INSTRUCCIONES:
1.  **Estructura del Itinerario**: Crea un plan para cada día. Usa un formato claro como "Día 1: [Título del Día]", "Día 2: [Título del Día]", etc.
2.  **Actividades por Día**: Para cada día, sugiere 2-3 actividades o lugares para visitar de tu base de conocimientos. Asegúrate de que las sugerencias coincidan con el ESTILO DE VIAJE y el NIVEL DE ENERGÍA del usuario.
    * **Aventura/Alto**: Sugiere trekkings, actividades al aire libre, lugares de difícil acceso.
    * **Relax/Bajo**: Sugiere casas de té, miradores de fácil acceso, paseos tranquilos.
    * **Familiar/Medio**: Sugiere lugares aptos para niños, paseos cortos, restaurantes familiares.
3.  **Descripción Atractiva**: Describe brevemente cada lugar sugerido para que suene interesante.
4.  **Realismo**: No satures los días. El plan debe ser realista y disfrutable.
5.  **Variedad**: Intenta variar las localidades (El Bolsón, Lago Puelo, etc.) a lo largo de los días si es posible.
6.  **Formato**: Usa negritas (con **asteriscos**) para los títulos de los días y los nombres de los lugares. Usa listas con guiones o asteriscos para las actividades de cada día.
7.  **Creatividad**: Conecta las actividades de forma lógica. Por ejemplo, un trekking por la mañana y una cena relajada por la tarde.
8.  **Limitación**: SOLO recomienda lugares que existan en tu base de conocimientos. No inventes nada.`;


        // ================== INICIO DEL CAMBIO ==================
        // He modificado esta función para que los enlaces aparezcan
        // debajo de cada lugar en vez de en una lista al final.
        function addMessage(messageData, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            let messageElement;
            if(sender === 'ai' && messageData.isSponsored) {
                messageElement = document.createElement('div');
                messageElement.className = `w-fit max-w-xs md:max-w-md lg:max-w-2xl p-3 rounded-2xl break-words shadow sponsored-message`;
                messageElement.innerHTML = `<p class="text-xs font-bold mb-1">⭐ Recomendado</p>`;
            } else {
                messageElement = document.createElement('div');
                messageElement.className = `w-fit max-w-xs md:max-w-md lg:max-w-2xl p-3 rounded-2xl break-words shadow ${sender === 'user' ? 'user-message' : 'ai-message'}`;
            }
            
            let messageContent = messageData.text || "No se pudo obtener una respuesta.";
            const placeholders = {}; 

            // 1. Preparamos los enlaces para cada lugar mencionado
            if (sender === 'ai' && messageData.places && messageData.places.length > 0) {
                const createLinksForPlace = (place) => {
                    let links = `<a class="place-link" data-place-id="${place.id}" data-place-name="${place.nombre}">💬 Ver Opiniones y Valorar</a>`;
                    if (place.latitud && place.longitud) {
                        links += ` | <a class="place-link map-link" data-lat="${place.latitud}" data-lng="${place.longitud}" data-id="${place.id}">📍 Ver en el mapa</a>`;
                    }
                    return `<div class="text-sm mt-1">${links}</div>`;
                };

                const processedPlaces = new Set();
                messageData.places.forEach((place, index) => {
                    const placeNameLower = place.nombre.toLowerCase();
                    if (processedPlaces.has(placeNameLower)) return;

                    const placeholder = `__PLACE_LINK_PLACEHOLDER_${index}__`;
                    placeholders[placeholder] = createLinksForPlace(place);

                    const escapedName = place.nombre.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                    const regex = new RegExp(escapedName, 'i');

                    if (regex.test(messageContent)) {
                         messageContent = messageContent.replace(regex, (match) => `${match}${placeholder}`);
                         processedPlaces.add(placeNameLower);
                    }
                });
            }

            // 2. Procesamos el texto con formato (negritas, listas, etc.)
            messageContent = messageContent
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\s*[\*\-]\s(.*?)/g, (match, item) => `<li class="list-disc list-inside ml-2">${item}</li>`)
                .replace(/(\<li.*\>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');
            
            // 3. Reemplazamos los placeholders por el HTML final de los enlaces
            for(const p in placeholders) {
                messageContent = messageContent.replace(p, placeholders[p]);
            }

            if(sender === 'ai' && messageData.isSponsored) {
                const contentP = document.createElement('p');
                contentP.innerHTML = messageContent;
                messageElement.appendChild(contentP);
            } else {
                messageElement.innerHTML = messageContent;
            }

            if (messageData.imageUrl) {
                const imgElement = document.createElement('img');
                imgElement.src = messageData.imageUrl;
                imgElement.alt = "Foto del lugar recomendado";
                imgElement.className = "rounded-lg mt-2 shadow-md w-full";
                imgElement.onerror = () => { 
                    imgElement.style.display = 'none'; 
                    const errorDiv = document.createElement('div');
                    errorDiv.className = "mt-2 p-2 bg-red-100 dark:bg-red-900 dark:text-red-200 text-red-700 text-xs rounded-lg";
                    errorDiv.textContent = "Error al cargar la imagen. Revisa que el link sea público y tenga el formato correcto.";
                    messageElement.appendChild(errorDiv);
                }; 
                messageElement.appendChild(imgElement);
            }
            
            // YA NO SE AÑADE LA LISTA DE ENLACES AL FINAL

            if (messageData.sources && messageData.sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'mt-2 pt-2 border-t border-gray-300 dark:border-gray-500 text-xs text-gray-600 dark:text-gray-400';
                let sourcesHTML = '<strong>Fuentes:</strong><ul class="list-disc list-inside">';
                messageData.sources.forEach(source => {
                    sourcesHTML += `<li><a href="${source.uri}" target="_blank" class="text-emerald-500 hover:underline">${source.title}</a></li>`;
                });
                sourcesHTML += '</ul>';
                sourcesDiv.innerHTML = sourcesHTML;
                messageElement.appendChild(sourcesDiv);
            }
            
            messageWrapper.appendChild(messageElement);
            chatWindow.appendChild(messageWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        // =================== FIN DEL CAMBIO ====================

        function showTypingIndicator() {
            const typingWrapper = document.createElement('div');
            typingWrapper.id = 'typing-indicator-wrapper';
            typingWrapper.className = 'w-full flex justify-start';
            typingWrapper.innerHTML = `<div class="ai-message w-fit p-3 rounded-2xl shadow"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            chatWindow.appendChild(typingWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return typingWrapper;
        }

        async function getAIResponse(currentHistory) {
            const knowledgeBase = dynamicKnowledgeBase; 
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const currentDate = today.toLocaleDateString('es-AR', options);

            const knowledgePrompt = `Base de conocimientos (JSON):\n${JSON.stringify(knowledgeBase)}`;
            const datePrompt = `Fecha de hoy: ${currentDate}.`;

            const apiHistory = JSON.parse(JSON.stringify(currentHistory));

            const lastUserMessage = apiHistory[apiHistory.length - 1];
            if (lastUserMessage && lastUserMessage.role === 'user') {
                lastUserMessage.parts[0].text = `${knowledgePrompt}\n${datePrompt}\n\nPregunta del usuario: "${lastUserMessage.parts[0].text}"`;
            }
            
            const payload = {
                contents: apiHistory,
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`La llamada a la API falló con el estado: ${response.status}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return { text: candidate.content.parts[0].text, sources: [] };
                } else {
                    return { text: "No he podido generar una respuesta esta vez. ¿Podrías intentarlo de otra manera?" };
                }

            } catch (error) {
                console.error("Error fetching AI response:", error);
                return { text: "Lo siento, parece que hay un problema de conexión o con el servicio. Por favor, intenta de nuevo en un momento." };
            }
        }

        chatForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (userInput === '') return;

            addMessage({ text: userInput }, 'user');
            chatHistory.push({ role: "user", parts: [{ text: userInput }] });
            chatInput.value = '';
            chatInput.disabled = true;
            suggestionsContainer.classList.add('hidden');
            
            if (typeof mainRecognition !== 'undefined' && isMainMicListening) {
                mainRecognition.stop();
            }

            const typingIndicator = showTypingIndicator();
            
            const aiResponseData = await getAIResponse(chatHistory);
            
            chatWindow.removeChild(typingIndicator);

            const aiResponseFullText = aiResponseData.text || "";
            
            const userInputLower = userInput.toLowerCase();
            const mentionedPlaces = placesCache.filter(place => {
                if (!aiResponseFullText || !place.nombre) return false;
                const escapedName = place.nombre.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                const regex = new RegExp(`\\b${escapedName}\\b`, 'i');
                return regex.test(aiResponseFullText);
            });

            let primaryPlace = null; 

            if (mentionedPlaces.length === 1) {
                primaryPlace = mentionedPlaces[0];
            } else if (mentionedPlaces.length > 1) {
                const matchesInQuery = mentionedPlaces.filter(p => userInputLower.includes(p.nombre.toLowerCase()));
                if (matchesInQuery.length > 0) {
                    primaryPlace = matchesInQuery[0];
                } else {
                    primaryPlace = mentionedPlaces[0];
                }
            }

            const isSponsoredResponse = primaryPlace ? primaryPlace.esAuspiciante : false;
            const imageUrl = primaryPlace ? primaryPlace.imagenURL : null;
            
            if (aiResponseFullText) {
                addMessage({ 
                    text: aiResponseFullText, 
                    isSponsored: isSponsoredResponse, 
                    sources: aiResponseData.sources, 
                    imageUrl: imageUrl, 
                    places: mentionedPlaces
                }, 'ai');
                chatHistory.push({ role: "model", parts: [{ text: aiResponseFullText }] });
            } else {
                const errorMsg = "Lo siento, algo no funcionó como esperaba.";
                addMessage({ text: errorMsg, places: [] }, 'ai');
                chatHistory.push({ role: "model", parts: [{ text: errorMsg }] });
            }

            chatInput.disabled = false;
            chatInput.focus();
        });
        
        // --- Lógica de Administración y Contribución ---
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminLoginForm = document.getElementById('admin-login-form');
        const cancelAdminLoginBtn = document.getElementById('cancel-admin-login-btn');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminErrorMsg = document.getElementById('admin-error-msg');
        
        const adminControls = document.getElementById('admin-controls');
        const contributeBtn = document.getElementById('contribute-btn');
        const contributionModal = document.getElementById('contribution-modal');
        const closeContributionModalBtn = document.getElementById('close-contribution-modal-btn');
        const contributionForm = document.getElementById('contribution-form');
        const contributionTitle = document.getElementById('contribution-title');
        const contributionSubmitBtn = document.getElementById('contribution-submit-btn');
        
        const tabSingle = document.getElementById('tab-single');
        const tabBulk = document.getElementById('tab-bulk');
        const bulkFormContainer = document.getElementById('bulk-entry-form-container');
        const contributionTabs = document.getElementById('contribution-tabs');
        const bulkInput = document.getElementById('bulk-input');
        const processBulkBtn = document.getElementById('process-bulk-btn');
        const bulkReviewContainer = document.getElementById('bulk-review-container');
        let placesToSave = [];

        const tipoSelect = document.getElementById('lugar-tipo');
        const tipoMap = {};
        Array.from(tipoSelect.options).forEach(opt => {
            const key = opt.text; 
            tipoMap[key.toLowerCase()] = { 
                tipo: opt.value, 
                subtipo: opt.dataset.subtype || ''
            };
        });

        adminLoginBtn.addEventListener('click', () => {
            adminLoginModal.classList.remove('hidden');
            adminPasswordInput.focus();
        });

        cancelAdminLoginBtn.addEventListener('click', () => {
            adminLoginModal.classList.add('hidden');
            adminErrorMsg.classList.add('hidden');
            adminLoginForm.reset();
        });

        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = adminPasswordInput.value;
            const correctPassword = 'andesadmin';

            if (password === correctPassword) {
                isAdmin = true; 
                adminControls.classList.remove('hidden');
                adminLoginBtn.classList.add('hidden');
                adminLoginModal.classList.add('hidden');
                adminLoginForm.reset();
                adminErrorMsg.classList.add('hidden');
                
                renderTips(tipsCache); 
            } else {
                isAdmin = false;
                adminErrorMsg.classList.remove('hidden');
            }
        });

        contributeBtn.addEventListener('click', () => {
            contributionForm.reset();
            delete contributionForm.dataset.docId;
            contributionTitle.textContent = "Añadir conocimiento a Andes";
            contributionSubmitBtn.textContent = "Añadir Lugar";
            contributionTabs.classList.remove('hidden');
            contributionModal.classList.remove('hidden');

            contributionForm.classList.remove('hidden');
            bulkFormContainer.classList.add('hidden');
            tabSingle.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-emerald-500 border-emerald-500';
            tabBulk.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200';
        });
        
        closeContributionModalBtn.addEventListener('click', () => contributionModal.classList.add('hidden'));
        
        tabSingle.addEventListener('click', () => {
            contributionForm.classList.remove('hidden');
            bulkFormContainer.classList.add('hidden');
            tabSingle.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-emerald-500 border-emerald-500';
            tabBulk.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200';
        });
        tabBulk.addEventListener('click', () => {
            contributionForm.classList.add('hidden');
            bulkFormContainer.classList.remove('hidden');
            tabBulk.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-emerald-500 border-emerald-500';
            tabSingle.className = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200';
        });

        contributionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(contributionSubmitBtn, true);

            const docId = contributionForm.dataset.docId;
            const tipoSelect = document.getElementById('lugar-tipo');
            const selectedOption = tipoSelect.options[tipoSelect.selectedIndex];
            
            const newPlace = {
                localidad: document.getElementById('lugar-localidad').value,
                tipo: tipoSelect.value,
                subtipo: selectedOption.dataset.subtype || '',
                nombre: document.getElementById('lugar-nombre').value,
                direccion: document.getElementById('lugar-direccion').value,
                telefono: document.getElementById('lugar-telefono').value,
                latitud: document.getElementById('lugar-latitud').value,
                longitud: document.getElementById('lugar-longitud').value,
                imagenURL: document.getElementById('lugar-imagen').value,
                imagen360URL: document.getElementById('lugar-imagen360').value,
                descripcion: document.getElementById('lugar-descripcion').value,
                datosClave: document.getElementById('lugar-datos-clave').value, 
                esAuspiciante: document.getElementById('lugar-sponsor').checked,
            };

            try {
                if (!lugaresCollectionRef) throw new Error("DB not available.");
                const docPath = `/artifacts/${appId}/public/data/lugares`;
                if(docId) {
                    const docRef = doc(db, docPath, docId);
                    await updateDoc(docRef, newPlace);
                    showToast("¡Lugar actualizado con éxito!", 'success');
                } else {
                    newPlace.createdAt = serverTimestamp();
                    newPlace.ratingCount = 0;
                    newPlace.totalRatingSum = 0;
                    await addDoc(collection(db, docPath), newPlace);
                    showToast("¡Gracias por tu contribución!", 'success');
                }
                contributionForm.reset();
                delete contributionForm.dataset.docId;
                contributionModal.classList.add('hidden');
            } catch (error) {
                console.error("Error saving place: ", error);
                showToast("Hubo un error al guardar.", 'error');
            } finally {
                setButtonLoading(contributionSubmitBtn, false, docId ? 'Guardar Cambios' : 'Añadir Lugar');
            }
        });
        
        processBulkBtn.addEventListener('click', () => {
            const lines = bulkInput.value.trim().split('\n');
            placesToSave = [];
            let reviewHtml = '';

            lines.forEach((line, index) => {
                if (!line.trim()) return;
                
                const parts = line.split(',');
                
                if(parts.length < 3) { 
                    reviewHtml += `<div class="p-2 my-1 bg-red-100 dark:bg-red-900 rounded-md text-sm text-left"><strong>Línea ${index + 1}:</strong> Formato incorrecto. Se necesitan al menos 'Tipo: Nombre, Localidad, ..., Descripción'.</div>`;
                    return;
                }

                const tipoRaw = parts[0].trim();
                const tipoMatch = tipoRaw.match(/(.+?):\s*(.*)/);
                
                if(!tipoMatch || !tipoMatch[1] || !tipoMatch[2]) {
                    reviewHtml += `<div class="p-2 my-1 bg-red-100 dark:bg-red-900 rounded-md text-sm text-left"><strong>Línea ${index + 1}:</strong> Formato incorrecto en "Tipo: Nombre". Asegúrate de que empiece con el tipo, dos puntos y el nombre.</div>`;
                    return;
                }

                const tipoTexto = tipoMatch[1].trim();
                const nombre = tipoMatch[2].trim();
                
                const typeInfo = tipoMap[tipoTexto.toLowerCase()];

                if (!typeInfo) {
                    reviewHtml += `<div class="p-2 my-1 bg-red-100 dark:bg-red-900 rounded-md text-sm text-left"><strong>Línea ${index + 1}:</strong> Tipo de lugar inválido: "${tipoTexto}".</div>`;
                    return;
                }

                const localidad = (parts[1] || '').trim();
                const direccion = (parts[2] || '').trim();
                const telefono = (parts[3] || '').trim();
                const latitud = (parts[4] || '').trim();
                const longitud = (parts[5] || '').trim();
                const descripcion = parts.slice(6).join(',').trim();

                if (!descripcion) {
                    reviewHtml += `<div class="p-2 my-1 bg-red-100 dark:bg-red-900 rounded-md text-sm text-left"><strong>Línea ${index + 1}:</strong> Falta la descripción. Debe ser el último campo.</div>`;
                    return;
                }

                const place = { 
                    tipo: typeInfo.tipo, 
                    subtipo: typeInfo.subtipo,
                    nombre, 
                    localidad, 
                    direccion, 
                    telefono,
                    latitud,
                    longitud,
                    imagenURL: "",
                    imagen360URL: "",
                    descripcion,
                    datosClave: "",
                    esAuspiciante: false,
                    ratingCount: 0, 
                    totalRatingSum: 0,
                    createdAt: serverTimestamp() 
                };
                placesToSave.push(place);
                
                reviewHtml += `
                    <div class="p-2 my-1 bg-green-100 dark:bg-green-900 rounded-md text-sm text-left">
                        <strong>${place.nombre}</strong> (${place.localidad}) - <strong>OK</strong>
                    </div>
                `;
            });
            
            if (placesToSave.length > 0) {
                reviewHtml += `<div class="pt-4 flex justify-end"><button id="save-bulk-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Guardar ${placesToSave.length} Válidos</button></div>`;
            }

            bulkReviewContainer.innerHTML = reviewHtml;
            if(placesToSave.length > 0) {
                document.getElementById('save-bulk-btn').addEventListener('click', saveBulkPlaces);
            }
        });

        async function saveBulkPlaces() {
            const saveBtn = document.getElementById('save-bulk-btn');
            setButtonLoading(saveBtn, true);
            
            try {
                const deletePromises = [];
                let batch = writeBatch(db);
                let count = 0;

                for (const place of placesToSave) {
                    const newDocRef = doc(lugaresCollectionRef);
                    batch.set(newDocRef, place);
                    count++;
                    if (count === 499) {
                        deletePromises.push(batch.commit());
                        batch = writeBatch(db);
                        count = 0;
                    }
                }
                if (count > 0) {
                    deletePromises.push(batch.commit());
                }

                await Promise.all(deletePromises);

                showToast(`${placesToSave.length} lugares guardados.`, 'success');
                bulkInput.value = '';
                bulkReviewContainer.innerHTML = '';
                contributionModal.classList.add('hidden');
            } catch(error) {
                console.error("Error saving bulk: ", error);
                showToast("Error al guardar en lote.", 'error');
            } finally {
                setButtonLoading(saveBtn, false, `Guardar ${placesToSave.length} Válidos`);
            }
        }


        // --- PANEL DE GESTIÓN ---
        const manageBtn = document.getElementById('manage-btn');
        const manageModal = document.getElementById('manage-modal');
        const closeManageModalBtn = document.getElementById('close-manage-modal-btn');
        const manageListContainer = document.getElementById('manage-list');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteConfirmationText = document.getElementById('delete-confirmation-text');
        const downloadBackupBtn = document.getElementById('download-backup-btn');
        
        const restoreBackupBtn = document.getElementById('restore-backup-btn');
        const backupFileInput = document.getElementById('backup-file-input');
        const confirmRestoreModal = document.getElementById('confirm-restore-modal');
        const cancelRestoreBtn = document.getElementById('cancel-restore-btn');
        const confirmRestoreBtn = document.getElementById('confirm-restore-btn');
        let parsedBackupData = [];

        const confirmRubroDeleteModal = document.getElementById('confirm-rubro-delete-modal');
        const cancelRubroDeleteBtn = document.getElementById('cancel-rubro-delete-btn');
        const confirmRubroDeleteBtn = document.getElementById('confirm-rubro-delete-btn');
        const rubroDeleteConfirmationText = document.getElementById('rubro-delete-confirmation-text');
        let itemToDelete = { id: null, type: null };


        // Nuevos elementos para el modal de valoraciones
        const ratingModal = document.getElementById('rating-modal');
        const closeRatingModalBtn = document.getElementById('close-rating-modal-btn');
        const ratingModalTitle = document.getElementById('rating-modal-title');
        const averageRatingContainer = document.getElementById('average-rating-container');
        const commentsList = document.getElementById('comments-list');
        const ratingForm = document.getElementById('rating-form');
        const commentInput = document.getElementById('comment-input');


        manageBtn.addEventListener('click', () => {
            lastOpenDetails = { localidadId: null, rubroId: null };
            renderManagementList();
            manageModal.classList.remove('hidden');
        });
        closeManageModalBtn.addEventListener('click', () => manageModal.classList.add('hidden'));
        downloadBackupBtn.addEventListener('click', downloadBackup);
        
        restoreBackupBtn.addEventListener('click', () => backupFileInput.click());
        backupFileInput.addEventListener('change', handleBackupFileSelect);
        cancelRestoreBtn.addEventListener('click', () => confirmRestoreModal.classList.add('hidden'));
        confirmRestoreBtn.addEventListener('click', executeRestore);

        cancelDeleteBtn.addEventListener('click', () => {
            confirmDeleteModal.classList.add('hidden');
            itemToDelete = { id: null, type: null };
        });
        confirmDeleteBtn.addEventListener('click', () => {
             if (itemToDelete.id && itemToDelete.type) {
                if (itemToDelete.type === 'place') {
                    executePlaceDeletion(itemToDelete.id);
                }
            }
        });

        cancelRubroDeleteBtn.addEventListener('click', () => confirmRubroDeleteModal.classList.add('hidden'));
        confirmRubroDeleteBtn.addEventListener('click', executeRubroDelete);

        chatWindow.addEventListener('click', (e) => {
            const target = e.target;
            if (target && target.classList.contains('place-link')) {
                if (target.classList.contains('map-link')) {
                    const lat = target.dataset.lat;
                    const lng = target.dataset.lng;
                    const placeId = target.dataset.id;
                    openMapAtLocation(lat, lng, placeId);
                } else {
                    const placeId = target.dataset.placeId;
                    const placeName = target.dataset.placeName;
                    openRatingModal(placeId, placeName);
                }
            }
        });

        // Listeners para el modal de valoraciones
        closeRatingModalBtn.addEventListener('click', () => ratingModal.classList.add('hidden'));
        ratingForm.addEventListener('submit', handleRatingSubmit);


        function renderManagementList() {
            if (placesCache.length === 0) {
                manageListContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 mt-8">Aún no se ha añadido ningún lugar.</p>`;
                return;
            }
            
            manageListContainer.innerHTML = '';
            const groupedPlaces = placesCache.reduce((acc, place) => {
                const localidad = place.localidad || 'Sin Localidad';
                const rubro = getRubroFromPlace(place); 

                if (!acc[localidad]) acc[localidad] = {};
                if (!acc[localidad][rubro]) acc[localidad][rubro] = [];
                acc[localidad][rubro].push(place);
                return acc;
            }, {});

            const sortedLocalidades = Object.keys(groupedPlaces).sort();

            for(const localidad of sortedLocalidades) {
                const localidadId = `localidad-${localidad.replace(/\s+/g, '-')}`;
                const localidadDetails = document.createElement('details');
                localidadDetails.id = localidadId;
                localidadDetails.className = 'mb-2 bg-white dark:bg-slate-800 rounded-lg shadow-sm';
                if (lastOpenDetails.localidadId === localidadId) {
                    localidadDetails.open = true;
                }
                
                const localidadSummary = document.createElement('summary');
                localidadSummary.className = 'cursor-pointer font-bold text-lg p-3 list-none flex items-center';
                localidadSummary.innerHTML = `<span class="flex-grow">${localidad}</span> <span class="text-sm font-normal text-gray-500 dark:text-gray-400 mr-2">${Object.keys(groupedPlaces[localidad]).length} rubros</span>`;
                localidadSummary.dataset.id = localidadId;
                localidadDetails.appendChild(localidadSummary);

                const sortedRubros = Object.keys(groupedPlaces[localidad]).sort();

                for (const rubro of sortedRubros) {
                    const rubroId = `rubro-${localidadId}-${rubro.replace(/\s+/g, '-')}`;
                    const rubroDetails = document.createElement('details');
                    rubroDetails.id = rubroId;
                    rubroDetails.className = 'ml-6 border-l-2 border-gray-200 dark:border-slate-600';
                    if (lastOpenDetails.rubroId === rubroId) {
                        rubroDetails.open = true;
                    }
                    
                    const rubroSummary = document.createElement('summary');
                    rubroSummary.className = 'cursor-pointer font-semibold p-2 list-none flex items-center justify-between';
                    rubroSummary.innerHTML = `
                        <div class="flex items-center">
                            <span class="flex-grow">${rubro}</span> 
                            <span class="bg-emerald-100 dark:bg-emerald-800 text-emerald-800 dark:text-emerald-200 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${groupedPlaces[localidad][rubro].length}</span>
                        </div>
                        <button class="delete-rubro-btn text-gray-400 hover:text-red-500 p-1 rounded-full" data-localidad="${localidad}" data-rubro="${rubro}" data-count="${groupedPlaces[localidad][rubro].length}">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    rubroSummary.dataset.id = rubroId;
                    rubroSummary.dataset.parentId = localidadId;
                    rubroDetails.appendChild(rubroSummary);

                    const placesList = document.createElement('div');
                    placesList.className = 'pl-4 pb-2';

                    groupedPlaces[localidad][rubro].sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(place => {
                        const placeDiv = document.createElement('div');
                        placeDiv.className = 'flex justify-between items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700';
                        placeDiv.innerHTML = `
                            <div>
                                <p class="font-semibold">${place.nombre} ${place.esAuspiciante ? '⭐' : ''}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${place.direccion || 'Sin dirección'}</p>
                            </div>
                            <div class="space-x-2 flex-shrink-0">
                                <button class="edit-btn text-blue-500 hover:underline text-sm" data-id="${place.id}">Editar</button>
                                <button class="delete-btn text-red-500 hover:underline text-sm" data-id="${place.id}" data-name="${place.nombre}">Eliminar</button>
                            </div>
                        `;
                        placesList.appendChild(placeDiv);
                    });
                    rubroDetails.appendChild(placesList);
                    localidadDetails.appendChild(rubroDetails);
                }

                manageListContainer.appendChild(localidadDetails);
            }
             manageListContainer.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openEditForm(e.target.dataset.id)));
             manageListContainer.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => confirmPlaceDeletion(e.target.dataset.id, e.target.dataset.name)));
             addManagementEventListeners();
        }

        function confirmPlaceDeletion(id, name) {
            deleteConfirmationText.textContent = `¿Estás seguro de que quieres eliminar "${name}"?`;
            itemToDelete = { id, type: 'place' };
            confirmDeleteModal.classList.remove('hidden');
        }

        async function executePlaceDeletion(id) {
            confirmDeleteModal.classList.add('hidden');
            try {
                await deleteDoc(doc(lugaresCollectionRef, id));
                showToast("Lugar eliminado.", 'info');
            } catch (error) {
                console.error("Error deleting place:", error);
                showToast("Error al eliminar el lugar.", 'error');
            } finally {
                itemToDelete = { id: null, type: null };
            }
        }


        function addManagementEventListeners() {
            manageListContainer.querySelectorAll('summary').forEach(summary => {
                summary.addEventListener('click', (e) => {
                    // Prevenir que el click en el botón de borrar abra/cierre el desplegable
                    if (e.target.closest('.delete-rubro-btn')) {
                        e.preventDefault();
                        return;
                    }
                    setTimeout(() => {
                        const detailsElement = e.target.closest('details');
                        if (!detailsElement) return;

                        const parentId = summary.dataset.parentId;
                        
                        if (parentId) { // Es un rubro
                            if (detailsElement.open) {
                                lastOpenDetails.localidadId = parentId;
                                lastOpenDetails.rubroId = summary.dataset.id;
                            } else {
                                lastOpenDetails.rubroId = null;
                            }
                        } else { // Es una localidad
                            if (detailsElement.open) {
                                lastOpenDetails.localidadId = summary.dataset.id;
                                lastOpenDetails.rubroId = null; 
                            } else {
                                lastOpenDetails.localidadId = null;
                                lastOpenDetails.rubroId = null;
                            }
                        }
                    }, 0);
                });
            });
            
            manageListContainer.querySelectorAll('.delete-rubro-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const { localidad, rubro, count } = e.currentTarget.dataset;
                    confirmRubroDeletion(localidad, rubro, count);
                });
            });
        }


        function openEditForm(placeId) {
            const place = placesCache.find(p => p.id === placeId);
            if(!place) return;
            
            manageModal.classList.add('hidden');
            contributionForm.reset();

            document.getElementById('lugar-localidad').value = place.localidad;
            document.getElementById('lugar-nombre').value = place.nombre;
            document.getElementById('lugar-direccion').value = place.direccion || '';
            document.getElementById('lugar-telefono').value = place.telefono || '';
            document.getElementById('lugar-latitud').value = place.latitud || '';
            document.getElementById('lugar-longitud').value = place.longitud || '';
            document.getElementById('lugar-imagen').value = place.imagenURL || '';
            document.getElementById('lugar-imagen360').value = place.imagen360URL || '';
            document.getElementById('lugar-descripcion').value = place.descripcion;
            document.getElementById('lugar-datos-clave').value = place.datosClave || ''; 
            document.getElementById('lugar-sponsor').checked = place.esAuspiciante;
            
            const tipoSelect = document.getElementById('lugar-tipo');
            for(let opt of tipoSelect.options) {
                if(opt.value === place.tipo && (!place.subtipo || opt.dataset.subtype === place.subtipo)) {
                    opt.selected = true;
                    break;
                }
            }
            
            contributionForm.dataset.docId = placeId;
            contributionTitle.textContent = "Editar Lugar";
            contributionSubmitBtn.textContent = "Guardar Cambios";
            contributionTabs.classList.add('hidden'); 
            contributionForm.classList.remove('hidden'); 
            contributionModal.classList.remove('hidden');
        }

        function confirmRubroDeletion(localidad, rubro, count) {
            rubroDeleteConfirmationText.innerHTML = `¿Estás seguro de que quieres eliminar los <strong class="font-bold">${count}</strong> lugares del rubro <strong class="font-bold">"${rubro}"</strong> en <strong class="font-bold">${localidad}</strong>? <br><br>Esta acción es irreversible.`;
            confirmRubroDeleteBtn.dataset.localidad = localidad;
            confirmRubroDeleteBtn.dataset.rubro = rubro;
            confirmRubroDeleteModal.classList.remove('hidden');
        }

        async function executeRubroDelete(e) {
            const button = e.currentTarget;
            const { localidad, rubro } = button.dataset;
            confirmRubroDeleteModal.classList.add('hidden');
            setButtonLoading(button, true, 'Sí, eliminar rubro');

            try {
                const idsToDelete = placesCache
                    .filter(place => {
                        const placeLocalidad = (place.localidad || '').trim();
                        const placeRubro = getRubroFromPlace(place);
                        return placeLocalidad === localidad && placeRubro === rubro;
                    })
                    .map(place => place.id);

                if (idsToDelete.length === 0) {
                    showToast("No se encontraron lugares para eliminar.", "info");
                } else {
                    const deletePromises = [];
                    let batch = writeBatch(db);
                    let deleteCount = 0;

                    idsToDelete.forEach(id => {
                        if (id) {
                            const docRef = doc(db, collectionPath, id);
                            batch.delete(docRef);
                            deleteCount++;
                            if (deleteCount >= 499) {
                                deletePromises.push(batch.commit());
                                batch = writeBatch(db);
                                deleteCount = 0;
                            }
                        }
                    });

                    if (deleteCount > 0) {
                        deletePromises.push(batch.commit());
                    }

                    await Promise.all(deletePromises);
                    showToast(`Rubro "${rubro}" de ${localidad} eliminado con éxito.`, 'success');
                }
            } catch (error) {
                console.error("Error detailed in executeRubroDelete:", error);
                showToast(`Error al eliminar: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }


        function downloadBackup() {
            if (placesCache.length === 0) {
                showToast('No hay datos para descargar.', 'info');
                return;
            }
            const headers = ['id', 'tipo', 'subtipo', 'nombre', 'localidad', 'direccion', 'telefono', 'descripcion', 'datosClave', 'latitud', 'longitud', 'imagenURL', 'imagen360URL', 'esAuspiciante'];
            let csvContent = headers.join(',') + '\n';

            placesCache.forEach(place => {
                const row = headers.map(header => {
                    let value = place[header] === undefined || place[header] === null ? '' : place[header];
                    if (typeof value === 'string') {
                        return `"${value.replace(/"/g, '""').replace(/\n/g, ' ')}"`;
                    }
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute("download", `backup_andes_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Descarga iniciada.', 'success');
        }

        // --- Lógica completa para Restaurar Backup ---

        function handleBackupFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    parsedBackupData = parseCSV(text);
                    if (parsedBackupData.length > 0) {
                        confirmRestoreModal.classList.remove('hidden');
                    } else {
                        showToast('El archivo de backup está vacío o tiene un formato incorrecto.', 'error');
                    }
                } catch (error) {
                    console.error("Error parsing CSV:", error);
                    showToast('Error al leer el archivo de backup.', 'error');
                }
            };
            reader.onerror = () => showToast('No se pudo leer el archivo.', 'error');
            reader.readAsText(file);
            
            backupFileInput.value = '';
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                if (values.length !== headers.length) continue;

                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    let value = values[j].trim();
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1).replace(/""/g, '"');
                    }
                    if (value === 'true') obj[headers[j]] = true;
                    else if (value === 'false') obj[headers[j]] = false;
                    else obj[headers[j]] = value;
                }
                data.push(obj);
            }
            return data;
        }

        async function executeRestore() {
            confirmRestoreModal.classList.add('hidden');
            setButtonLoading(restoreBackupBtn, true);
            
            try {
                // 1. Borrar todos los documentos existentes
                const querySnapshot = await getDocs(lugaresCollectionRef);
                const deletePromises = [];
                let deleteBatch = writeBatch(db);
                let deleteCount = 0;

                querySnapshot.forEach((doc) => {
                    deleteBatch.delete(doc.ref);
                    deleteCount++;
                    if (deleteCount === 500) {
                        deletePromises.push(deleteBatch.commit());
                        deleteBatch = writeBatch(db);
                        deleteCount = 0;
                    }
                });
                if (deleteCount > 0) {
                    deletePromises.push(deleteBatch.commit());
                }
                await Promise.all(deletePromises);
                showToast(`${querySnapshot.size} lugares eliminados.`, 'info');

                // 2. Subir los nuevos documentos del backup
                const uploadPromises = [];
                let uploadBatch = writeBatch(db);
                let uploadCount = 0;

                parsedBackupData.forEach(place => {
                    const { id, ...placeData } = place; 
                    const newDocRef = doc(lugaresCollectionRef);
                    uploadBatch.set(newDocRef, placeData);
                    uploadCount++;
                    if (uploadCount === 500) {
                        uploadPromises.push(uploadBatch.commit());
                        uploadBatch = writeBatch(db);
                        uploadCount = 0;
                    }
                });
                if (uploadCount > 0) {
                    uploadPromises.push(uploadBatch.commit());
                }
                await Promise.all(uploadPromises);
                
                showToast(`¡Restauración completa! ${parsedBackupData.length} lugares añadidos.`, 'success');

            } catch (error) {
                console.error("Error during restore process:", error);
                showToast('Ocurrió un error durante la restauración.', 'error');
            } finally {
                setButtonLoading(restoreBackupBtn, false);
                parsedBackupData = []; 
            }
        }
        
        // --- Lógica para "El Rincón del Viajero" ---
        
        const rinconBtn = document.getElementById('rincon-btn');
        const rinconModal = document.getElementById('rincon-modal');
        const closeRinconModalBtn = document.getElementById('close-rincon-modal-btn');
        const tipForm = document.getElementById('tip-form');
        const tipInput = document.getElementById('tip-input');
        const rinconList = document.getElementById('rincon-list');
        
        rinconBtn.addEventListener('click', () => rinconModal.classList.remove('hidden'));
        closeRinconModalBtn.addEventListener('click', () => rinconModal.classList.add('hidden'));

        tipForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const tipText = tipInput.value.trim();
            if (!tipText) return;

            const newTip = {
                text: tipText,
                createdAt: serverTimestamp(),
                userId: auth.currentUser ? auth.currentUser.uid : 'anonimo'
            };

            try {
                await addDoc(consejosCollectionRef, newTip);
                tipInput.value = '';
                showToast("¡Consejo compartido!", 'success');
            } catch (error) {
                console.error("Error sharing tip:", error);
                showToast("No se pudo compartir el consejo.", 'error');
            }
        });

        function listenForTips() {
            if (!consejosCollectionRef) return;
            const q = query(consejosCollectionRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                tipsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTips(tipsCache);
            });
        }

        function renderTips(tips) {
            rinconList.innerHTML = '';
            if (tips.length === 0) {
                rinconList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 mt-8">¡Sé el primero en dejar un consejo para la comunidad!</p>';
                return;
            }
            tips.forEach(tip => {
                const tipElement = document.createElement('div');
                tipElement.className = 'bg-yellow-50 dark:bg-slate-700 p-3 rounded-lg shadow-sm relative';
                
                const date = tip.createdAt ? new Date(tip.createdAt.seconds * 1000).toLocaleString('es-AR') : 'Justo ahora';
                
                let adminDeleteButton = '';
                if (isAdmin) {
                    adminDeleteButton = `<button data-id="${tip.id}" class="delete-tip-btn absolute top-2 right-2 text-gray-400 hover:text-red-500">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>`;
                }

                tipElement.innerHTML = `
                    <p class="text-gray-800 dark:text-gray-200">${tip.text}</p>
                    <p class="text-xs text-right text-gray-500 dark:text-gray-400 mt-2">${date}</p>
                    ${adminDeleteButton}
                `;
                rinconList.appendChild(tipElement);
            });

            rinconList.querySelectorAll('.delete-tip-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const tipId = e.currentTarget.dataset.id;
                    try {
                        await deleteDoc(doc(consejosCollectionRef, tipId));
                        showToast("Consejo eliminado.", 'info');
                    } catch (error) {
                        console.error("Error deleting tip:", error);
                        showToast("No se pudo eliminar el consejo.", 'error');
                    }
                });
            });
        }


        // --- PREGUNTAS SUGERIDAS ---
        const suggestions = ["¿Dónde comer barato?", "¿Qué trekking me recomiendas?", "¿Cómo está el clima?"];
        function renderSuggestions() {
            const container = suggestionsContainer.querySelector('div');
            container.innerHTML = '';
            suggestions.forEach(q => {
                const button = document.createElement('button');
                button.className = "flex-shrink-0 bg-gray-200 dark:bg-slate-700 text-sm text-gray-700 dark:text-gray-200 py-1 px-3 rounded-full hover:bg-gray-300 dark:hover:bg-slate-600";
                button.textContent = q;
                button.addEventListener('click', () => {
                    chatInput.value = q;
                    chatForm.dispatchEvent(new Event('submit'));
                });
                container.appendChild(button);
            });
        }
        renderSuggestions();
        
        // --- REPRODUCTOR DE RADIO ---
        const radioPlayer = document.getElementById('radio-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        
        const streamURL = 'https://streaming6.locucionar.com:24140/stream'; 
        radioPlayer.src = streamURL;

        let isPlaying = false;

        const playIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3l14 9-14 9V3z" /></svg>`;
        const pauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6" /></svg>`;

        playPauseBtn.innerHTML = playIcon;

        playPauseBtn.addEventListener('click', () => {
            if(isPlaying) {
                radioPlayer.pause();
                playPauseBtn.innerHTML = playIcon;
                playPauseBtn.classList.remove('playing-animation');
            } else {
                radioPlayer.play();
                playPauseBtn.innerHTML = pauseIcon;
                playPauseBtn.classList.add('playing-animation');
            }
            isPlaying = !isPlaying;
        });
        
        // --- RECONOCIMIENTO DE VOZ ---
        const micBtn = document.getElementById('mic-btn');
        let isMainMicListening = false;
        let mainRecognition;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            // Micrófono principal del chat
            mainRecognition = new SpeechRecognition();
            mainRecognition.continuous = false; 
            mainRecognition.lang = 'es-AR';
            mainRecognition.interimResults = false;

            micBtn.addEventListener('click', () => {
                if (isMainMicListening) {
                    mainRecognition.stop();
                } else {
                    mainRecognition.start();
                }
            });

            mainRecognition.onstart = () => {
                isMainMicListening = true;
                micBtn.classList.add('bg-red-500', 'text-white');
                chatInput.placeholder = "Escuchando...";
            };

            mainRecognition.onend = () => {
                isMainMicListening = false;
                micBtn.classList.remove('bg-red-500', 'text-white');
                chatInput.placeholder = "Ej: ¿Qué puedo hacer hoy en El Bolsón?";
            };

            mainRecognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0])
                    .map(result => result.transcript)
                    .join('');
                
                chatInput.value = chatInput.value + transcript + ' ';
            };

            mainRecognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                chatInput.placeholder = "Error de micrófono. Revisa los permisos.";
            };

            // Lógica para los nuevos micrófonos en los formularios
            document.querySelectorAll('.mic-input-btn').forEach(button => {
                const input = button.closest('.relative').querySelector('input, textarea');
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'es-AR';
                recognition.interimResults = false;
                let isListening = false;
                let originalPlaceholder = input.placeholder;

                button.addEventListener('click', () => {
                    if (isListening) {
                        recognition.stop();
                    } else {
                        recognition.start();
                    }
                });

                recognition.onstart = () => {
                    isListening = true;
                    button.classList.add('text-red-500');
                    input.placeholder = "Escuchando...";
                };

                recognition.onend = () => {
                    isListening = false;
                    button.classList.remove('text-red-500');
                    input.placeholder = originalPlaceholder;
                };

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    input.value += (input.value ? ' ' : '') + transcript;
                };

                 recognition.onerror = (event) => {
                    console.error("Form mic error:", event.error);
                    showToast('Error de micrófono. Revisa los permisos.', 'error');
                };
            });


        } else {
            console.log("Speech Recognition not supported.");
            micBtn.style.display = 'none';
            document.querySelectorAll('.mic-input-btn').forEach(btn => btn.style.display = 'none');
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        function setButtonLoading(button, isLoading, originalText = '') {
            if (isLoading) {
                button.dataset.originalText = originalText || button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            } else {
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                    delete button.dataset.originalText;
                }
            }
        }


        // --- Lógica para VALORACIONES Y COMENTARIOS ---

        async function openRatingModal(placeId, placeName) {
            ratingModalTitle.textContent = `Opiniones sobre ${placeName}`;
            ratingForm.dataset.placeId = placeId;
            ratingForm.reset();

            averageRatingContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 p-4">Cargando valoraciones...</p>';
            commentsList.innerHTML = '';

            if (currentPlaceCommentsUnsubscribe) {
                currentPlaceCommentsUnsubscribe();
            }

            const commentsCollectionRef = collection(db, `/artifacts/${appId}/public/data/lugares/${placeId}/comments`);
            const q = query(commentsCollectionRef);

            currentPlaceCommentsUnsubscribe = onSnapshot(q, (snapshot) => {
                const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                comments.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                commentsCache[placeId] = comments;
                
                const place = placesCache.find(p => p.id === placeId);
                
                renderAverageRating(place, comments);
                renderComments(comments, placeId);
            }, (error) => {
                console.error("Error al escuchar comentarios: ", error);
                averageRatingContainer.innerHTML = '';
                commentsList.innerHTML = '<p class="text-center text-red-500 dark:text-red-400 py-4">No se pudieron cargar los comentarios.</p>';
            });

            ratingModal.classList.remove('hidden');
        }

        function renderAverageRating(place, comments) {
            averageRatingContainer.innerHTML = '';
            if (!place || !place.ratingCount || place.ratingCount === 0) {
                averageRatingContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Este lugar aún no tiene valoraciones. ¡Sé el primero!</p>';
                return;
            }

            const average = (place.totalRatingSum / place.ratingCount).toFixed(1);
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                starsHTML += `<span class="text-2xl ${i <= Math.round(average) ? 'text-amber-500' : 'text-gray-300'}">★</span>`;
            }
            
            const ratingDistribution = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };
            if (comments && comments.length > 0) {
                comments.forEach(comment => {
                    if (comment.rating && ratingDistribution[comment.rating] !== undefined) {
                        ratingDistribution[comment.rating]++;
                    }
                });
            }

            let barsHTML = '<div class="space-y-1">';
            for (let i = 5; i >= 1; i--) {
                const count = ratingDistribution[i];
                const percentage = place.ratingCount > 0 ? (count / place.ratingCount) * 100 : 0;
                barsHTML += `
                    <div class="flex items-center text-sm">
                        <span class="text-gray-600 dark:text-gray-400 w-8 text-center">${i} ★</span>
                        <div class="w-full bg-gray-200 dark:bg-slate-600 rounded-full h-2 mx-2">
                            <div class="bg-amber-400 h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <span class="text-gray-500 dark:text-gray-400 w-8 text-right font-mono text-xs">${count}</span>
                    </div>
                `;
            }
            barsHTML += '</div>';

            averageRatingContainer.innerHTML = `
                <div class="flex flex-col md:flex-row gap-4 md:gap-6 items-center p-4 bg-gray-50 dark:bg-slate-700/50 rounded-lg">
                    <div class="flex-shrink-0 text-center">
                        <p class="text-5xl font-bold text-gray-800 dark:text-gray-200">${average}</p>
                        <div class="flex justify-center">${starsHTML}</div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${place.ratingCount} ${place.ratingCount === 1 ? 'valoración' : 'valoraciones'}</p>
                    </div>
                    <div class="w-full flex-grow">
                        ${barsHTML}
                    </div>
                </div>
            `;
        }

        function renderComments(comments, placeId) {
            commentsList.innerHTML = '';
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">Aún no hay comentarios.</p>';
                return;
            }

            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'bg-gray-100 dark:bg-slate-700 p-3 rounded-lg relative';
                const date = comment.createdAt ? new Date(comment.createdAt.seconds * 1000).toLocaleDateString('es-AR') : '';
                
                let starsHTML = '';
                for (let i = 1; i <= 5; i++) {
                    starsHTML += `<span class="${i <= comment.rating ? 'text-amber-500' : 'text-gray-300'}">★</span>`;
                }

                const adminDeleteButton = isAdmin ? `
                    <button data-id="${comment.id}" data-place-id="${placeId}" data-rating="${comment.rating}" class="delete-comment-btn absolute top-2 right-2 text-gray-400 hover:text-red-500">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                ` : '';

                commentElement.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center">${starsHTML}</div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${date}</p>
                    </div>
                    <p class="text-gray-800 dark:text-gray-200 pr-6">${comment.text || '<i>Sin comentario.</i>'}</p>
                    ${adminDeleteButton}
                `;
                commentsList.appendChild(commentElement);
            });

            commentsList.querySelectorAll('.delete-comment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const commentId = e.currentTarget.dataset.id;
                    const placeId = e.currentTarget.dataset.placeId;
                    const ratingValue = Number(e.currentTarget.dataset.rating);
                    deleteComment(placeId, commentId, ratingValue);
                });
            });
        }
        async function handleRatingSubmit(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const placeId = e.target.dataset.placeId;
            const rating = e.target.rating.value;
            const commentText = commentInput.value.trim();

            if (!rating) {
                showToast("Por favor, selecciona una cantidad de estrellas.", 'error');
                return;
            }
            
            setButtonLoading(submitBtn, true, 'Enviar Opinión');

            const newComment = {
                rating: Number(rating),
                text: commentText,
                createdAt: serverTimestamp(),
                userId: auth.currentUser ? auth.currentUser.uid : 'anonimo'
            };
            
            try {
                const commentsCollectionRef = collection(db, `/artifacts/${appId}/public/data/lugares/${placeId}/comments`);
                await addDoc(commentsCollectionRef, newComment);

                const placeRef = doc(lugaresCollectionRef, placeId);
                await runTransaction(db, async (transaction) => {
                    const placeDoc = await transaction.get(placeRef);
                    if (!placeDoc.exists()) {
                        throw "¡El lugar no existe!";
                    }
                    const newCount = (placeDoc.data().ratingCount || 0) + 1;
                    const newSum = (placeDoc.data().totalRatingSum || 0) + newComment.rating;
                    transaction.update(placeRef, { ratingCount: newCount, totalRatingSum: newSum });
                });

                showToast("¡Gracias por tu opinión!", 'success');
                ratingForm.reset();

            } catch (error) {
                console.error("Error submitting rating:", error);
                showToast("No se pudo enviar tu opinión.", 'error');
            } finally {
                setButtonLoading(submitBtn, false);
            }
        }
        async function deleteComment(placeId, commentId, ratingValue) {
            try {
                const commentRef = doc(db, `/artifacts/${appId}/public/data/lugares/${placeId}/comments`, commentId);
                await deleteDoc(commentRef);

                const placeRef = doc(lugaresCollectionRef, placeId);
                await runTransaction(db, async (transaction) => {
                    const placeDoc = await transaction.get(placeRef);
                    if (!placeDoc.exists()) {
                        throw "¡El lugar no existe!";
                    }
                    const currentCount = placeDoc.data().ratingCount || 0;
                    const currentSum = placeDoc.data().totalRatingSum || 0;

                    const newCount = currentCount > 0 ? currentCount - 1 : 0;
                    const newSum = currentSum - ratingValue;

                    transaction.update(placeRef, { ratingCount: newCount, totalRatingSum: newSum });
                });

                showToast("Comentario eliminado.", 'info');
            } catch (error) {
                 console.error("Error deleting comment:", error);
                 showToast("No se pudo eliminar el comentario.", 'error');
            }
        }

        // --- Lógica del Mapa, VR y AR ---

        const ICONS = {
            restaurantes: {
                svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M11.637 1.402a2.5 2.5 0 0 0-3.274 0l-7.5 6.429A2.5 2.5 0 0 0 2.5 12h15a2.5 2.5 0 0 0 1.637-4.169l-7.5-6.429Z" /><path d="M5.25 13.5a.75.75 0 0 0 0 1.5h9.5a.75.75 0 0 0 0-1.5h-9.5Z" /></svg>`,
                color: '#F97316'
            },
            alojamiento: {
                svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M5.5 3A2.5 2.5 0 0 0 3 5.5v2.879a.5.5 0 0 0 .146.353l3.586 3.586a.5.5 0 0 0 .707 0l3.586-3.586A.5.5 0 0 0 11.121 8.38V5.5A2.5 2.5 0 0 0 8.5 3h-3Zm0 1.5h3a1 1 0 0 1 1 1v2.379l-2.293 2.293a.5.5 0 0 1-.707 0L4.5 8.38V5.5a1 1 0 0 1 1-1Z" clip-rule="evenodd" /><path d="M12.5 3a2.5 2.5 0 0 1 2.5 2.5v8.5a2.5 2.5 0 0 1-2.5 2.5h-5A2.5 2.5 0 0 1 5 14v-1.5a.75.75 0 0 0-1.5 0V14a4 4 0 0 0 4 4h5a4 4 0 0 0 4-4V5.5a4 4 0 0 0-4-4h-1.5a.75.75 0 0 0 0 1.5h1.5Z" /></svg>`,
                color: '#3B82F6'
            },
            actividades: {
                svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 1a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 1ZM10 6a.75.75 0 0 1 .75.75v3.44l1.47-1.47a.75.75 0 1 1 1.06 1.06l-2.5 2.5a.75.75 0 0 1-1.06 0l-2.5-2.5a.75.75 0 1 1 1.06-1.06l1.47 1.47V6.75A.75.75 0 0 1 10 6Zm-4.192 3.192a.75.75 0 0 1 0 1.06l-1.5 1.5a.75.75 0 0 1-1.06-1.06l1.5-1.5a.75.75 0 0 1 1.06 0Zm10.444 1.06a.75.75 0 0 0-1.06-1.06l-1.5 1.5a.75.75 0 1 0 1.06 1.06l1.5-1.5Z" clip-rule="evenodd" /></svg>`,
                color: '#10B981'
            },
            lugaresParaVisitar: {
                svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772.145-1.65-.43-2.226l-.527-.527a.75.75 0 0 0-1.061 0l-.527.527c-.575.576-.751 1.454-.43 2.226L10 9.5l-1.894 4.516a.75.75 0 0 0 1.342.562l1.625-3.25L13.1 14.578a.75.75 0 0 0 1.342-.562l-1.894-4.516L15.4 3.73a.75.75 0 0 0-.527-1.28l-4.005.667-1.13-2.261Z" clip-rule="evenodd" /></svg>`,
                color: '#8B5CF6'
            },
            default: {
                svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 0 0 .281-.14c.186-.1.4-.27.662-.477.352-.274.764-.646 1.226-1.099 1.584-1.532 3.125-3.869 3.125-6.191C15.62 4.404 13.09 2 10 2S4.38 4.404 4.38 8c0 2.322 1.542 4.659 3.125 6.191.462.453.874.825 1.226 1.099.262.207.476.377.662.477a5.741 5.741 0 0 0 .281.14l.018.008.006.003zM10 11.25a3.25 3.25 0 100-6.5 3.25 3.25 0 000 6.5z" clip-rule="evenodd" /></svg>`,
                color: '#6B7280'
            }
        };

        function getIconForPlace(place) {
            const iconData = ICONS[place.tipo] || ICONS.default;
            return L.divIcon({
                html: `<div class="custom-leaflet-icon" style="background-color: ${iconData.color}; border-color: ${iconData.color};">${iconData.svg}</div>`,
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        }
        
        function initMap() {
            if(mapInitialized) return;
            
            map = L.map('map').setView([-41.966, -71.533], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            mapInitialized = true;
            populateMap();
        }

        function populateMap() {
            if (!map || !markersLayer) return;
            markersLayer.clearLayers();
            markersById = {}; 

            placesCache.forEach(place => {
                const lat = parseFloat(place.latitud);
                const lon = parseFloat(place.longitud);

                if (!isNaN(lat) && !isNaN(lon)) {
                    const customIcon = getIconForPlace(place);
                    const marker = L.marker([lat, lon], { icon: customIcon }).addTo(markersLayer);
                    
                    let buttonsHTML = '<div class="mt-2 flex flex-wrap gap-2">';
                    if (place.imagen360URL) {
                        buttonsHTML += `<button class="popup-vr-button" data-vr-url="${place.imagen360URL}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                            <span>Ver en 360°</span>
                        </button>`;
                    }
                    
                    buttonsHTML += `<button class="popup-directions-button" data-lat="${lat}" data-lng="${lon}">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.414a.5.5 0 0 1 .707 0L18 9.121a.5.5 0 0 1 0 .707L13.293 14.5a.5.5 0 0 1-.707-.707L16.086 10H4.5a.5.5 0 0 1 0-1h11.586l-2.707-2.707a.5.5 0 0 1 0-.707Z" clip-rule="evenodd" /></svg>
                         <span>Iniciar Ruta</span>
                    </button>`;

                    buttonsHTML += '</div>';
                    
                    const popupContent = `
                        <div class="popup-title">${place.nombre}</div>
                        <div class="popup-description">${(place.descripcion || '').substring(0, 100)}...</div>
                        ${buttonsHTML}
                    `;
                    marker.bindPopup(popupContent);

                    markersById[place.id] = marker;
                }
            });
        }
        
        function openVRModal(imageUrl) {
            if (vrSky && imageUrl) {
                vrSky.setAttribute('src', imageUrl);
                vrModal.classList.remove('hidden');
            } else {
                showToast("No hay imagen 360° para este lugar.", "info");
            }
        }
        
        mapBtn.addEventListener('click', () => {
            mapModal.classList.remove('hidden');
            if (!mapInitialized) {
                initMap();
            }
            setTimeout(() => map.invalidateSize(), 10);
        });
        closeMapModalBtn.addEventListener('click', () => mapModal.classList.add('hidden'));

        document.getElementById('map').addEventListener('click', (e) => {
            const vrButton = e.target.closest('.popup-vr-button');
            if (vrButton) {
                const url = vrButton.dataset.vrUrl;
                openVRModal(url);
                return;
            }

            const directionsButton = e.target.closest('.popup-directions-button');
            if (directionsButton) {
                const lat = directionsButton.dataset.lat;
                const lng = directionsButton.dataset.lng;
                getDirections(lat, lng);
            }
        });

        closeVrModalBtn.addEventListener('click', () => {
            vrModal.classList.add('hidden');
            if(vrSky) vrSky.setAttribute('src', '');
        });

        function openMapAtLocation(lat, lng, placeId) {
            const numLat = parseFloat(lat);
            const numLng = parseFloat(lng);

            if (isNaN(numLat) || isNaN(numLng)) {
                showToast("Este lugar no tiene coordenadas válidas.", "error");
                return;
            }

            mapModal.classList.remove('hidden');
            
            if (!mapInitialized) {
                initMap();
            }
            
            setTimeout(() => {
                map.invalidateSize();
                map.setView([numLat, numLng], 16);
                if (markersById[placeId]) {
                    markersById[placeId].openPopup();
                }
            }, 10);
        }

        function getDirections(destLat, destLng) {
            if (!navigator.geolocation) {
                showToast("La geolocalización no es soportada por tu navegador.", 'error');
                const url = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}`;
                window.open(url, '_blank');
                return;
            }

            showToast("Obteniendo tu ubicación...", 'info');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const startLat = position.coords.latitude;
                    const startLng = position.coords.longitude;
                    const url = `https://www.google.com/maps/dir/${startLat},${startLng}/${destLat},${destLng}`;
                    window.open(url, '_blank');
                },
                () => {
                    showToast("No se pudo obtener tu ubicación. Abriendo mapa solo con el destino.", 'error');
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}`;
                    window.open(url, '_blank');
                }
            );
        }
        
        // --- Lógica de Realidad Aumentada (Integrada y mejorada) ---
        
        function updateArStatus(message, isError = false) {
            arStatus.textContent = message;
            arStatus.style.display = 'block';
            arPermissionsPill.style.display = 'none';
        }

        function stopARAndCleanup() {
            if (arSceneEl) {
                try {
                    if (arSceneEl.systems && arSceneEl.systems.arjs) {
                       arSceneEl.systems.arjs.stop();
                    }
                    arSceneEl.pause();
                    const video = document.querySelector('video');
                    if (video && video.srcObject) {
                       video.srcObject.getTracks().forEach(track => track.stop());
                    }
                } catch (e) { console.warn("Error al detener la escena AR", e); }
                if(arSceneEl.parentNode) {
                    arSceneEl.parentNode.removeChild(arSceneEl);
                }
                arSceneEl = null;
            }

            videoTracks.forEach(track => {
                try { track.stop(); } catch (e) {}
            });
            videoTracks = [];

            arModal.classList.add('hidden');
            arStatus.style.display = 'none';
            arTopBar.style.display = 'none';
        }
        
        async function requestARPermissions() {
            updateArStatus("Se necesita acceso a la cámara. Por favor, acepta la solicitud del navegador.");
            arPermissionsPill.textContent = 'Pidiendo cámara...';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoTracks = stream.getTracks(); // Guardar para detenerlas luego
                arPermissionsPill.textContent = 'Cámara OK';
            } catch (err) {
                console.error('Cámara denegada o no disponible', err);
                throw new Error('Permiso de cámara denegado. Revisa los ajustes del navegador (icono 🔒).');
            }

            updateArStatus("¡Cámara OK! Ahora se necesita tu ubicación para mostrar los lugares cercanos.");
            arPermissionsPill.textContent = 'Pidiendo ubicación...';
            const geoPromise = new Promise((resolve, reject) => {
                if (!navigator.geolocation) return reject(new Error('Geolocalización no es compatible.'));
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        arPermissionsPill.textContent = 'Ubicación OK';
                        resolve(pos.coords);
                    },
                    (err) => {
                        console.error('Error de geolocalización', err);
                        reject(new Error('Permiso de ubicación denegado. Revisa los ajustes del navegador (icono 🔒).'));
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
                );
            });
            return await geoPromise;
        }

        async function startAR() {
            arModal.classList.remove('hidden');
            arTopBar.style.display = 'flex';
            arPermissionsPill.style.display = 'block';
            arPermissionsPill.textContent = 'Esperando permisos...';
            
            try {
                await loadArGpsScript();
                await requestARPermissions();
                updateArStatus('¡Permisos aceptados! Iniciando escena AR...');
                setTimeout(() => createAndLaunchGpsScene(), 300);
            } catch (err) {
                console.error('La solicitud de permisos falló:', err);
                updateArStatus(err.message || 'No se pudieron obtener los permisos necesarios', true);
            }
        }
        
        function createAndLaunchGpsScene() {
            if (arSceneEl) return;
            
            const placesHTML = placesCache.filter(p => p.latitud && p.longitud).map(p => {
                const lat = parseFloat(p.latitud);
                const lon = parseFloat(p.longitud);
                if (isNaN(lat) || isNaN(lon)) return '';
                
                const safeName = (p.nombre || '').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
                const safeInfo = (getRubroFromPlace(p) || '').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
                
                return `
                    <a-entity id="poi-${p.id}"
                              data-name="${safeName}"
                              gps-entity-place="latitude: ${lat}; longitude: ${lon};"
                              look-at="[gps-camera]"
                              scale="25 25 25"
                              class="clickable">
                        <a-plane width="2.4" height="0.9" position="0 0 0" material="color: #064e3b; opacity:0.85" radius="0.1"></a-plane>
                        <a-text value="${safeName}" color="#FFFFFF" align="center" width="2.2" position="0 0.15 0.01" 
                                font="https://cdn.aframe.io/fonts/Roboto-msdf.json"></a-text>
                        <a-text value="${safeInfo}" color="#d1fae5" align="center" width="2.2" position="0 -0.15 0.01" 
                                font="https://cdn.aframe.io/fonts/Roboto-msdf.json" scale="0.8 0.8 0.8"></a-text>
                    </a-entity>
                `;
            }).join('\n');

            const sceneHtml = `
                <a-scene
                    vr-mode-ui="enabled: false"
                    embedded
                    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true"
                    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
                >
                    <a-camera gps-camera rotation-reader></a-camera>
                    ${placesHTML}
                </a-scene>
            `;

            arModalContent.innerHTML = sceneHtml;
            arSceneEl = arModalContent.querySelector('a-scene');

            if (arSceneEl.hasLoaded) {
                setupGpsArEvents(arSceneEl);
            } else {
                arSceneEl.addEventListener('loaded', () => setupGpsArEvents(arSceneEl));
            }
        }

        function setupGpsArEvents(scene) {
            scene.addEventListener('arjs-gps-camera-status-active', () => {
                console.log('AR.js GPS camera active');
                arStatus.style.display = 'none';
                arPermissionsPill.style.display = 'block';
            });

            scene.addEventListener('arjs-gps-camera-error', (e) => {
                console.warn('AR.js GPS error', e);
                let msg = 'Error al iniciar AR';
                if (e && e.detail && e.detail.code === 2) msg = 'No se obtuvo señal GPS. Intenta en un lugar abierto.';
                updateArStatus(msg, true);
            });

            scene.querySelectorAll('[gps-entity-place]').forEach(el => {
                el.addEventListener('click', (evt) => {
                    const placeId = el.id.replace('poi-', '');
                    const placeName = el.dataset.name;
                    stopARAndCleanup(); // Cierra la AR para mostrar el modal de rating
                    openRatingModal(placeId, placeName);
                });
            });
        }

        arBtn.addEventListener('click', startAR);
        closeArModalBtn.addEventListener('click', stopARAndCleanup);
        
        // --- LÓGICA DEL PLANIFICADOR DE VIAJES INTELIGENTE ---
        const plannerBtn = document.getElementById('planner-btn');
        const plannerModal = document.getElementById('planner-modal');
        const closePlannerModalBtn = document.getElementById('close-planner-modal-btn');
        const smartPlannerForm = document.getElementById('smart-planner-form');
        const plannerResultContainer = document.getElementById('planner-result-container');
        const travelStyleOptions = document.getElementById('travel-style-options');
        const energyLevelOptions = document.getElementById('energy-level-options');

        let selectedTravelStyle = null;
        let selectedEnergyLevel = null;

        plannerBtn.addEventListener('click', () => {
             // Resetear el formulario y resultado cada vez que se abre
            smartPlannerForm.classList.remove('hidden');
            plannerResultContainer.innerHTML = '';
            plannerResultContainer.classList.add('hidden');
            
            // Quitar selecciones previas
            travelStyleOptions.querySelectorAll('.selected').forEach(btn => btn.classList.remove('selected'));
            energyLevelOptions.querySelectorAll('.selected').forEach(btn => btn.classList.remove('selected'));
            selectedTravelStyle = null;
            selectedEnergyLevel = null;

            plannerModal.classList.remove('hidden');
        });
        closePlannerModalBtn.addEventListener('click', () => plannerModal.classList.add('hidden'));

        // Manejo de selección de botones
        travelStyleOptions.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            travelStyleOptions.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedTravelStyle = button.dataset.style;
        });

        energyLevelOptions.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            energyLevelOptions.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedEnergyLevel = button.dataset.energy;
        });


        smartPlannerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const days = document.getElementById('planner-days').value;

            if (!selectedTravelStyle) {
                showToast("Por favor, elige un estilo de viaje.", 'error');
                return;
            }
            if (!selectedEnergyLevel) {
                showToast("Por favor, elige tu nivel de energía.", 'error');
                return;
            }

            smartPlannerForm.classList.add('hidden');
            plannerResultContainer.classList.remove('hidden');
            plannerResultContainer.innerHTML = `
                <div class="text-center p-8">
                    <p class="text-lg font-semibold dark:text-gray-200">Andes está pensando...</p>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Creando un plan de ${days} días de tipo "${selectedTravelStyle}" con energía "${selectedEnergyLevel}"...</p>
                     <div class="typing-indicator mx-auto mt-4"><span></span><span></span><span></span></div>
                </div>
            `;
            
            const aiPlanText = await getPlannerAIResponse(selectedTravelStyle, days, selectedEnergyLevel);

            const formattedPlan = aiPlanText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\s*[\*\-]\s(.*?)/g, (match, item) => `<li class="list-disc list-inside ml-4">${item}</li>`)
                .replace(/(\<li.*\>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');

            plannerResultContainer.innerHTML = `
                <div class="prose dark:prose-invert max-w-none p-4 bg-emerald-50 dark:bg-slate-700 rounded-lg">
                    <h3 class="text-center">¡Tu Plan de Viaje está Listo!</h3>
                    ${formattedPlan}
                </div>
                <div class="text-center mt-6">
                    <button id="share-plan-btn" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors duration-300 flex items-center justify-center mx-auto gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.93 7.93 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.89 7.89 0 0 0 13.6 2.326zM7.994 14.521a6.57 6.57 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.1-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                        <span>Compartir por WhatsApp</span>
                    </button>
                </div>
            `;
            
            document.getElementById('share-plan-btn').addEventListener('click', () => {
                const cleanPlanText = aiPlanText.replace(/\*\*/g, ''); // Remove bold asterisks
                let whatsAppText = `¡Hola! Andes me preparó este plan de viaje para la Comarca Andina:\n\n${cleanPlanText}`;
                
                const encodedText = encodeURIComponent(whatsAppText);
                const whatsappUrl = `https://wa.me/?text=${encodedText}`;

                window.open(whatsappUrl, '_blank');
            });
        });

        async function getPlannerAIResponse(travelStyle, days, energyLevel) {
            const knowledgeBase = JSON.stringify(dynamicKnowledgeBase);
            let prompt = systemPlannerPrompt
                .replace('{travelStyle}', travelStyle)
                .replace('{days}', days)
                .replace('{energyLevel}', energyLevel)
                .replace('{knowledgeBase}', knowledgeBase);

            const payload = {
                contents: [{ parts: [{ text: "Genera el itinerario por favor." }] }],
                systemInstruction: { parts: [{ text: prompt }] },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                return candidate?.content?.parts?.[0]?.text || "No se pudo generar un plan. Intenta de nuevo.";
            } catch (error) {
                console.error("Error fetching planner response:", error);
                return "Hubo un problema al contactar a Andes para crear tu plan. Por favor, intenta más tarde.";
            }
        }


        // --- Mensaje de bienvenida inicial ---
        const welcomeText = "¡Hola! Soy Andes, tu guía experto para la Comarca Andina. ¿En qué te puedo ayudar hoy?";
        addMessage({ text: welcomeText }, 'ai');
        chatHistory.push({ role: "model", parts: [{ text: welcomeText }] });
    });
</script>

</body>
</html>


